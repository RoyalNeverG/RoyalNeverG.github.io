<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>深入理解Java并发编程 - MilkLc</title><meta description="-Ⅰ、进程和线程 一、进程和线程的区别？简单的比喻：进程&amp;#x3D;火车，线程&amp;#x3D;车厢  线程在进程下行进（单纯的车厢无法运行） 一个进程可以包含多个线程（一辆火车可以有多个车厢） 不同进程间数据很难共享（一辆火车上的乘客很难换到另外一辆火车，比如站点换乘） 同一进程下不同线程间数据很易共享（A车厢换到B车厢很容易） 进程要比线程消耗更多的计算机资源（采用多列火车相比多个车厢更耗资源） 进程间不会相互影响，一"><meta property="og:type" content="blog"><meta property="og:title" content="深入理解Java并发编程"><meta property="og:url" content="http://yoursite.com/2020/07/24/thread/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><meta property="og:site_name" content="MilkLc"><meta property="og:description" content="-Ⅰ、进程和线程 一、进程和线程的区别？简单的比喻：进程&amp;#x3D;火车，线程&amp;#x3D;车厢  线程在进程下行进（单纯的车厢无法运行） 一个进程可以包含多个线程（一辆火车可以有多个车厢） 不同进程间数据很难共享（一辆火车上的乘客很难换到另外一辆火车，比如站点换乘） 同一进程下不同线程间数据很易共享（A车厢换到B车厢很容易） 进程要比线程消耗更多的计算机资源（采用多列火车相比多个车厢更耗资源） 进程间不会相互影响，一"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="c:/Users/42119/AppData/Roaming/Typora/typora-user-images/1589784404912.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200518144802.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200518145152.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200518145336.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519101859.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519102955.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519121432.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519132721.png"><meta property="og:image" content="http://img.louchen.top/2020/05/批注 2020-05-19 162918.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519170638.png"><meta property="og:image" content="c:%5CUsers%5C42119%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1590227934591.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519175203.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519215657.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519215736.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519220028.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200519220155.png"><meta property="og:image" content="http://img.louchen.top/2020/05/批注 2020-05-20 112818.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200520111759.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200520200704.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200520203425.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200520204110.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200521100207.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200521205415.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200521161247.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200521161200.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200521161218.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200521211404.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200524105942.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200524105843.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200524150638.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200524170608.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200526170517.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200526170543.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200526170609.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200526170543.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200526170609.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200525214057.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200525214258.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200526212626.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200527172826.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200527173229.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200527174944.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200528122410.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200528122711.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200528130102.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200528210043.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200529194946.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200601161355.png"><meta property="og:image" content="http://img.louchen.top/2020/05/20200601165853.png"><meta property="og:image" content="http://img.louchen.top/2020/06/20200601170142.png"><meta property="og:image" content="http://img.louchen.top/2020/06/20200601171534.png"><meta property="og:image" content="http://img.louchen.top/2020/06/20200601172724.png"><meta property="article:published_time" content="2020-07-24T15:14:33.027Z"><meta property="article:modified_time" content="2020-06-06T14:49:50.970Z"><meta property="article:author" content="lc"><meta property="article:tag" content="多线程"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="C:\Users\42119\AppData\Roaming\Typora\typora-user-images\1589784404912.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com/2020/07/24/thread/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"},"headline":"MilkLc","image":["c:/Users/42119/AppData/Roaming/Typora/typora-user-images/1589784404912.png","http://img.louchen.top/2020/05/20200518144802.png","http://img.louchen.top/2020/05/20200518145152.png","http://img.louchen.top/2020/05/20200518145336.png","http://img.louchen.top/2020/05/20200519101859.png","http://img.louchen.top/2020/05/20200519102955.png","http://img.louchen.top/2020/05/20200519121432.png","http://img.louchen.top/2020/05/20200519132721.png","http://img.louchen.top/2020/05/批注 2020-05-19 162918.png","http://img.louchen.top/2020/05/20200519170638.png","c:%5CUsers%5C42119%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1590227934591.png","http://img.louchen.top/2020/05/20200519175203.png","http://img.louchen.top/2020/05/20200519215657.png","http://img.louchen.top/2020/05/20200519215736.png","http://img.louchen.top/2020/05/20200519220028.png","http://img.louchen.top/2020/05/20200519220155.png","http://img.louchen.top/2020/05/批注 2020-05-20 112818.png","http://img.louchen.top/2020/05/20200520111759.png","http://img.louchen.top/2020/05/20200520200704.png","http://img.louchen.top/2020/05/20200520203425.png","http://img.louchen.top/2020/05/20200520204110.png","http://img.louchen.top/2020/05/20200521100207.png","http://img.louchen.top/2020/05/20200521205415.png","http://img.louchen.top/2020/05/20200521161247.png","http://img.louchen.top/2020/05/20200521161200.png","http://img.louchen.top/2020/05/20200521161218.png","http://img.louchen.top/2020/05/20200521211404.png","http://img.louchen.top/2020/05/20200524105942.png","http://img.louchen.top/2020/05/20200524105843.png","http://img.louchen.top/2020/05/20200524150638.png","http://img.louchen.top/2020/05/20200524170608.png","http://img.louchen.top/2020/05/20200526170517.png","http://img.louchen.top/2020/05/20200526170543.png","http://img.louchen.top/2020/05/20200526170609.png","http://img.louchen.top/2020/05/20200526170543.png","http://img.louchen.top/2020/05/20200526170609.png","http://img.louchen.top/2020/05/20200525214057.png","http://img.louchen.top/2020/05/20200525214258.png","http://img.louchen.top/2020/05/20200526212626.png","http://img.louchen.top/2020/05/20200527172826.png","http://img.louchen.top/2020/05/20200527173229.png","http://img.louchen.top/2020/05/20200527174944.png","http://img.louchen.top/2020/05/20200528122410.png","http://img.louchen.top/2020/05/20200528122711.png","http://img.louchen.top/2020/05/20200528130102.png","http://img.louchen.top/2020/05/20200528210043.png","http://img.louchen.top/2020/05/20200529194946.png","http://img.louchen.top/2020/05/20200601161355.png","http://img.louchen.top/2020/05/20200601165853.png","http://img.louchen.top/2020/06/20200601170142.png","http://img.louchen.top/2020/06/20200601171534.png","http://img.louchen.top/2020/06/20200601172724.png"],"datePublished":"2020-07-24T15:14:33.027Z","dateModified":"2020-06-06T14:49:50.970Z","author":{"@type":"Person","name":"lc"},"description":"-Ⅰ、进程和线程 一、进程和线程的区别？简单的比喻：进程&#x3D;火车，线程&#x3D;车厢  线程在进程下行进（单纯的车厢无法运行） 一个进程可以包含多个线程（一辆火车可以有多个车厢） 不同进程间数据很难共享（一辆火车上的乘客很难换到另外一辆火车，比如站点换乘） 同一进程下不同线程间数据很易共享（A车厢换到B车厢很容易） 进程要比线程消耗更多的计算机资源（采用多列火车相比多个车厢更耗资源） 进程间不会相互影响，一"}</script><link rel="canonical" href="http://yoursite.com/2020/07/24/thread/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><link rel="icon" href="/img/favicon.ico"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/favicon.ico" alt="MilkLc" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/RoyalNeverG"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><input placeholder="你想要查找什么？" type="text"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2020-07-24T15:14:33.027Z" title="2020-07-24T15:14:33.027Z">2020-07-24</time><span class="level-item"><a class="link-muted" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a></span><span class="level-item">4 小时 读完 (大约 32838 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">深入理解Java并发编程</h1><div class="content"><p>-Ⅰ、进程和线程</p>
<h3 id="一、进程和线程的区别？"><a href="#一、进程和线程的区别？" class="headerlink" title="一、进程和线程的区别？"></a>一、进程和线程的区别？</h3><p>简单的比喻：<strong>进程=火车，线程=车厢</strong></p>
<ul>
<li>线程在进程下行进（单纯的车厢无法运行）</li>
<li>一个进程可以包含多个线程（一辆火车可以有多个车厢）</li>
<li>不同进程间数据很难共享（一辆火车上的乘客很难换到另外一辆火车，比如站点换乘）</li>
<li>同一进程下不同线程间数据很易共享（A车厢换到B车厢很容易）</li>
<li>进程要比线程消耗更多的计算机资源（采用多列火车相比多个车厢更耗资源）</li>
<li>进程间不会相互影响，一个线程挂掉将导致整个进程挂掉（一列火车不会影响到另外一列火车，但是如果一列火车上中间的一节车厢着火了，将影响到所有车厢）<a id="more"></a></li>
<li>进程可以拓展到多机，进程最多适合多核（不同火车可以开在多个轨道上，同一火车的车厢不能在行进的不同的轨道上）</li>
<li>进程使用的内存地址可以上锁，即一个线程使用某些共享内存时，其他线程必须等它结束，才能使用这一块内存。（比如火车上的洗手间）－<strong>“互斥锁”</strong></li>
<li>进程使用的内存地址可以限定使用量（比如火车上的餐厅，最多只允许多少人进入，如果满了需要在门口等，等有人出来了才能进去）－“信号量”</li>
</ul>
<p><strong>进一步总结：</strong></p>
<ul>
<li>进程是一个资源的容器，为进程里的所有线程提供共享资源，是对程序的一种静态描述</li>
<li>线程是计算机最小的调度和运行单位，是对程序的一种动态描述</li>
</ul>
<p><strong>例如：</strong></p>
<ul>
<li><p>开个QQ，开了一个进程；开了迅雷，开了一个进程。<br>在QQ的这个进程里，传输文字开一个线程、传输语音开了一个线程、弹出对话框又开了一个线程。</p>
<p>所以运行某个软件，相当于开了一个进程。在这个软件运行的过程里（在这个进程里），多个工作支撑的完成QQ的运行，那么这“多个工作”分别有一个线程。</p>
</li>
<li><p><strong>所以一个进程管着多个线程。</strong></p>
</li>
</ul>
<h4 id="1、进程"><a href="#1、进程" class="headerlink" title="1、进程"></a>1、进程</h4><ul>
<li><p>程序由指令和数据组成，但这些指令要运行，数据要读写，就必须将指令加载至 CPU，数据加载至内存。在 指令运行过程中还需要用到磁盘、网络等设备。进程就是用来加载指令、管理内存、管理 IO 的 </p>
</li>
<li><p>当一个程序被运行，从磁盘加载这个程序的代码至内存，这时就开启了一个进程。 </p>
</li>
<li><p>进程就可以视为程序的一个实例。大部分程序可以同时运行多个实例进程（例如记事本、画图、浏览器 等），也有的程序只能启动一个实例进程（例如网易云音乐、360 安全卫士等）</p>
</li>
</ul>
<h4 id="2、线程"><a href="#2、线程" class="headerlink" title="2、线程"></a>2、线程</h4><ul>
<li><p>一个进程之内可以分为一到多个线程。 </p>
</li>
<li><p>一个线程就是一个指令流，将指令流中的一条条指令以一定的顺序交给 CPU 执行 </p>
</li>
<li><p>Java 中，线程作为小调度单位，进程作为资源分配的小单位。 在 windows 中进程是不活动的，只是作 为线程的容器</p>
</li>
</ul>
<h4 id="3、进程和线程的区别"><a href="#3、进程和线程的区别" class="headerlink" title="3、进程和线程的区别"></a>3、进程和线程的区别</h4><ul>
<li><p>进程是资源分配的最小单位，线程是CPU调度的最小单位</p>
</li>
<li><p>进程基本上相互独立的，而线程存在于进程内，是进程的一个子集 </p>
</li>
<li><p>进程拥有共享的资源，如内存空间等，供其内部的线程共享</p>
</li>
<li><p>进程间通信较为复杂</p>
<ul>
<li>同一台计算机的进程通信称为 IPC（Inter-process communication） </li>
<li>不同计算机之间的进程通信，需要通过网络，并遵守共同的协议，例如 HTTP </li>
</ul>
</li>
<li><p>线程通信相对简单，因为它们共享进程内的内存，一个例子是多个线程可以访问同一个共享变量 </p>
</li>
<li><p>线程更轻量，线程上下文切换成本一般上要比进程上下文切换低</p>
</li>
</ul>
<h2 id="Ⅱ、Java线程"><a href="#Ⅱ、Java线程" class="headerlink" title="Ⅱ、Java线程"></a>Ⅱ、Java线程</h2><h3 id="一、创建线程的方式"><a href="#一、创建线程的方式" class="headerlink" title="一、创建线程的方式"></a>一、创建线程的方式</h3><h4 id="1、继承Thread"><a href="#1、继承Thread" class="headerlink" title="1、继承Thread"></a>1、继承Thread</h4><p>只有调用<strong>start()</strong>方法才算开启一个线程。否则只是代表创建一个Thread实例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line"><span class="comment">//            Thread.currentThread().getName()获取当前线程名称</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">":"</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        ①继承Thread类 重写run方法</span></span><br><span class="line">        MyThread myThread=<span class="keyword">new</span> MyThread();</span><br><span class="line"><span class="comment">//        设置线程的名称</span></span><br><span class="line">        myThread.setName(<span class="string">"myThread"</span>);</span><br><span class="line">        myThread.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        ②使用匿名内部类继承Thread</span></span><br><span class="line">        Thread thread1=<span class="keyword">new</span> Thread(<span class="string">"thread1"</span>)&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">":"</span>+i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread1.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、实现Runnable接口"><a href="#2、实现Runnable接口" class="headerlink" title="2、实现Runnable接口"></a>2、实现Runnable接口</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">":"</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        ①传入Runnable接口的实现类</span></span><br><span class="line">        Thread thread=<span class="keyword">new</span> Thread(<span class="keyword">new</span> MyRunnable(), <span class="string">"myRunnable"</span>);</span><br><span class="line">        thread.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        ②使用匿名内部类实现Runnable接口</span></span><br><span class="line">        Thread thread1=<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable()&#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName()+<span class="string">":"</span>+i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"myRunnable2"</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、实现Callable接口"><a href="#3、实现Callable接口" class="headerlink" title="3、实现Callable接口"></a>3、实现Callable接口</h4><p>Callable和Runnable的区别是，Callable接口可以拿到线程处理后的返回值给其他线程使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyCallable</span> <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        System.out.println(Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        新建任务</span></span><br><span class="line"><span class="comment">//        ①通过实现Callable接口</span></span><br><span class="line">        FutureTask&lt;Integer&gt; task=<span class="keyword">new</span> FutureTask&lt;&gt;(<span class="keyword">new</span> MyCallable());</span><br><span class="line"><span class="comment">//        ②使用匿名内部类实现Callable实现接口</span></span><br><span class="line">        FutureTask&lt;String&gt; task1=<span class="keyword">new</span> FutureTask&lt;&gt;(()-&gt;&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"hello java"</span>;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        FutureTask也是实现Runnable接口的</span></span><br><span class="line">        Thread thread=<span class="keyword">new</span> Thread(task, <span class="string">"MyCallable"</span>);</span><br><span class="line">        Thread thread1=<span class="keyword">new</span> Thread(task1,<span class="string">"MyCallable2"</span>);</span><br><span class="line"><span class="comment">//       开启此线程</span></span><br><span class="line">        thread.start();</span><br><span class="line">        thread1.start();</span><br><span class="line"><span class="comment">//        主线程获取返回值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            注意：主线程会一直阻塞在这里，直到get拿到此返回值</span></span><br><span class="line">            Integer t1 = task.get();</span><br><span class="line">            String t2 = task1.get();</span><br><span class="line">            System.out.println(t1);</span><br><span class="line">            System.out.println(t2);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4、Thread和Runnable的关系"><a href="#4、Thread和Runnable的关系" class="headerlink" title="4、Thread和Runnable的关系"></a>4、Thread和Runnable的关系</h4><p>Thread 是把线程和任务合并在了一起</p>
<p>Runnable是把线程和任务分开了</p>
<p>用 Runnable 更容易与线程池等高级 API 配合 </p>
<p>用 Runnable 让任务类脱离了 Thread 继承体系，更灵活</p>
<h3 id="三、原理之线程运行"><a href="#三、原理之线程运行" class="headerlink" title="三、原理之线程运行"></a>三、原理之线程运行</h3><h4 id="1、栈与栈帧"><a href="#1、栈与栈帧" class="headerlink" title="1、栈与栈帧"></a>1、栈与栈帧</h4><p><strong>栈先进后出</strong></p>
<p>Java Virtual Machine Stacks （Java 虚拟机栈） </p>
<p>我们都知道 JVM 中由堆、栈、方法区所组成，其中栈内存是给谁用的呢？其实就是线程，每个线程启动后，虚拟 机就会为其分配一块栈内存。</p>
<ul>
<li><p>每个线程都有自己的一个独立的栈帧，栈帧之间互不影响。</p>
</li>
<li><p>每个栈由多个栈帧（Frame）组成，对应着每次方法调用时所占用的内存 </p>
</li>
<li><p>每个线程只能有一个活动栈帧，对应着当前正在执行的那个方法</p>
</li>
</ul>
<img src="C:\Users\42119\AppData\Roaming\Typora\typora-user-images\1589784404912.png" alt="1589784404912" style="zoom: 67%;" />

<p><strong>idea中每个方法执行的栈帧，我们可以看到main方法首先入栈，然后method1和method2相继压栈，最后mehtod2和mehtod1执行完后，从上到下出栈</strong></p>
<img src="http://img.louchen.top/2020/05/20200518144802.png" style="zoom: 67%;" />

<h5 id="图解分析：方法执行在jvm中内存区域分析："><a href="#图解分析：方法执行在jvm中内存区域分析：" class="headerlink" title="图解分析：方法执行在jvm中内存区域分析："></a>图解分析：<strong>方法执行在jvm中内存区域分析：</strong></h5><img src="http://img.louchen.top/2020/05/20200518145152.png" style="zoom: 67%;" />

<p><strong>方法相继出栈：</strong></p>
<img src="http://img.louchen.top/2020/05/20200518145336.png" style="zoom:67%;" />

<h4 id="2、线程上下文切换"><a href="#2、线程上下文切换" class="headerlink" title="2、线程上下文切换"></a>2、线程上下文切换</h4><p>因为以下一些原因导致 cpu 不再执行当前的线程，转而执行另一个线程的代码</p>
<ul>
<li><p>线程的 cpu 时间片用完</p>
</li>
<li><p>垃圾回收 </p>
</li>
<li><p>有更高优先级的线程需要运行 </p>
</li>
<li><p>线程自己调用了 sleep、yield、wait、join、park、synchronized、lock 等方法</p>
</li>
</ul>
<p>当 Context Switch 发生时，需要由操作系统保存当前线程的状态，并恢复另一个线程的状态，Java 中对应的概念 就是程序计数器（Program Counter Register），它的作用是记住下一条 jvm 指令的执行地址，是线程私有的</p>
<ul>
<li>状态包括程序计数器、虚拟机栈中每个栈帧的信息，如局部变量、操作数栈、返回地址等 </li>
<li>Context Switch 频繁发生会影响性能 </li>
</ul>
<h3 id="四、Thread常用方法"><a href="#四、Thread常用方法" class="headerlink" title="四、Thread常用方法"></a>四、Thread常用方法</h3><table>
<thead>
<tr>
<th>方法名</th>
<th align="center">static</th>
<th>功能说明</th>
<th>注意</th>
</tr>
</thead>
<tbody><tr>
<td>start()</td>
<td align="center"></td>
<td>启动一个新线 程，在新的线程 运行 run 方法 中的代码</td>
<td>start 方法只是让线程进入就绪，里面代码不一定立刻 运行（CPU 的时间片还没分给它）。每个线程对象的 start方法只能调用一次，如果调用了多次会出现 IllegalThreadStateException</td>
</tr>
<tr>
<td>run()</td>
<td align="center"></td>
<td>新线程启动后会 调用的方法</td>
<td>如果在构造 Thread 对象时传递了 Runnable 参数，则 线程启动后会调用 Runnable 中的 run 方法，否则默 认不执行任何操作。但可以创建 Thread 的子类对象， 来覆盖默认行为</td>
</tr>
<tr>
<td>join()</td>
<td align="center"></td>
<td>等待线程运行结 束</td>
<td></td>
</tr>
<tr>
<td>join(long n)</td>
<td align="center"></td>
<td>等待线程运行结 束,多等待 n 毫秒</td>
<td></td>
</tr>
<tr>
<td>getId()</td>
<td align="center"></td>
<td>获取线程长整型 的 id</td>
<td>id 唯一</td>
</tr>
<tr>
<td>getName()</td>
<td align="center"></td>
<td>获取线程名</td>
<td></td>
</tr>
<tr>
<td>setName(String name)</td>
<td align="center"></td>
<td>修改线程名</td>
<td></td>
</tr>
<tr>
<td>getPriority()</td>
<td align="center"></td>
<td>获取线程优先级</td>
<td></td>
</tr>
<tr>
<td>setPriority(int)</td>
<td align="center"></td>
<td>修改线程优先级</td>
<td>java中规定线程优先级是1~10 的整数，较大的优先级 能提高该线程被 CPU 调度的机率</td>
</tr>
<tr>
<td>getState()</td>
<td align="center"></td>
<td>获取线程状态</td>
<td>Java 中线程状态是用 6 个 enum 表示，分别为： NEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED</td>
</tr>
<tr>
<td>isInterrupted()</td>
<td align="center"></td>
<td>判断是否被打 断</td>
<td>不会清除 <code>打断标记</code></td>
</tr>
<tr>
<td>isAlive()</td>
<td align="center"></td>
<td>线程是否存活 （还没有运行完 毕）</td>
<td></td>
</tr>
<tr>
<td>interrupt()</td>
<td align="center"></td>
<td>打断线程</td>
<td>如果被打断线程正在 sleep，wait，join 会导致被打断 的线程抛出 InterruptedException，并清除 <code>打断标记</code>；如果打断的正在运行的线程，则会设置 <code>打断标记</code>；park 的线程被打断，也会设置 <code>打断标记</code></td>
</tr>
<tr>
<td>interrupted()</td>
<td align="center">static</td>
<td>判断当前线程是 否被打断</td>
<td>会清除 <code>打断标记</code></td>
</tr>
<tr>
<td>currentThread()</td>
<td align="center">static</td>
<td>获取当前正在执 行的线程</td>
<td></td>
</tr>
<tr>
<td>sleep(long n)</td>
<td align="center">static</td>
<td>让当前执行的线 程休眠n毫秒， 休眠时让出 cpu 的时间片给其它 线程</td>
<td></td>
</tr>
<tr>
<td>yield()</td>
<td align="center">static</td>
<td>提示线程调度器 让出当前线程对 CPU的使用</td>
<td>主要是为了测试和调试</td>
</tr>
</tbody></table>
<h3 id="五、sleep与yield"><a href="#五、sleep与yield" class="headerlink" title="五、sleep与yield"></a>五、sleep与yield</h3><h4 id="1、sleep"><a href="#1、sleep" class="headerlink" title="1、sleep"></a>1、sleep</h4><p><strong>①调用 sleep 会让当前线程从 Running  进入 Timed Waiting 状态（阻塞）</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//        新建的线程t1处于new状态</span></span><br><span class="line"><span class="comment">//        NEW</span></span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,t1.getState());</span><br><span class="line">        t1.start();</span><br><span class="line"><span class="comment">//        调用start方法后线程t1处于可运行状态</span></span><br><span class="line"><span class="comment">//        RUNNABLE</span></span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,t1.getState());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            主线程休眠1秒</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        此时主线程执行到这的时候，t1线程处于休眠状态</span></span><br><span class="line"><span class="comment">//        即此时t1处于超时等待</span></span><br><span class="line"><span class="comment">//        TIMED_WAITING</span></span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,t1.getState());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>②其它线程可以使用  interrupt 方法打断正在睡眠的线程，这时 sleep 方法会抛出 InterruptedException</strong> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"start sleep...."</span>);</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                log.info(<span class="string">"i wake up"</span>);</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//        打断正在休眠的进程 抛出InterruptedException异常</span></span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">02</span>:<span class="number">56.329</span> [Thread-<span class="number">0</span>] INFO org.lc.sleep_yield.T2 - start sleep....</span><br><span class="line"><span class="number">17</span>:<span class="number">02</span>:<span class="number">57.325</span> [Thread-<span class="number">0</span>] INFO org.lc.sleep_yield.T2 - i wake up</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br><span class="line">	at org.lc.sleep_yield.T2.lambda$main$<span class="number">0</span>(T2.java:<span class="number">18</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br></pre></td></tr></table></figure>

<p><strong>③睡眠结束后的线程未必会立刻得到执行</strong></p>
<p>睡眠过后，还是要等cpu来分配时间片给该线程来执行 </p>
<p><strong>④建议用 TimeUnit 的 sleep 代替 Thread 的 sleep 来获得更好的可读性</strong> </p>
<p><code>TimeUnit.DAYS</code></p>
<p><code>TimeUnit.HOURS</code></p>
<p><code>TimeUnit.MINUTES</code></p>
<p><code>TimeUnit.SECONDS</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"start sleep"</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            格式化睡眠时间 1 秒</span></span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"end sleep"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2、yield"><a href="#2、yield" class="headerlink" title="2、yield"></a>2、yield</h4><p><code>Thread.yield();</code></p>
<p><strong>①调用 yield 会让当前线程从 Running 进入 Runnable  就绪状态，然后调度执行其它线程</strong> </p>
<p><strong>②具体的实现依赖于操作系统的任务调度器</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line"><span class="comment">//                设置yield() 让出cpu</span></span><br><span class="line">                Thread.yield();</span><br><span class="line">                System.out.println(<span class="string">"t1----:"</span>+count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                System.out.println(<span class="string">"t2----:"</span>+count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">......</span><br><span class="line">t1----:<span class="number">6577</span></span><br><span class="line">t1----:<span class="number">6578</span></span><br><span class="line">t1----:<span class="number">6579</span></span><br><span class="line">t2----:<span class="number">23524</span></span><br><span class="line">t2----:<span class="number">23525</span></span><br><span class="line">t2----:<span class="number">23526</span></span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p><strong>我们明显可以发现，yield是有一定作用来让出cpu时间片给其他线程来执行的</strong></p>
<h4 id="3、sleep与yield的区别"><a href="#3、sleep与yield的区别" class="headerlink" title="3、sleep与yield的区别"></a>3、sleep与yield的区别</h4><p>当运行中的线程调用yield方法时，会直接进入从运行状态进入就绪状态，然后等待cpu时间片的调用。</p>
<p>当运行中的线程调用sleep方法时，线程会进入一个timed waiting阻塞状态，只有该sleep时间片过了，才有机会让cpu调用此线程</p>
<h4 id="4、线程优先级"><a href="#4、线程优先级" class="headerlink" title="4、线程优先级"></a>4、线程优先级</h4><ul>
<li><p>线程优先级会提示（hint）调度器优先调度该线程，但它仅仅是一个提示，调度器可以忽略它 </p>
</li>
<li><p>如果 cpu 比较忙，那么优先级高的线程会获得更多的时间片，但 cpu 闲时，优先级几乎没作用</p>
</li>
</ul>
<p><code>setPriority(int newPriority)</code>  范围：1-10</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 线程最小的优先级.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MIN_PRIORITY = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 线程默认的优先级.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> NORM_PRIORITY = <span class="number">5</span>;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 线程最大的优先级</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> MAX_PRIORITY = <span class="number">10</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                System.out.println(<span class="string">"t1----:"</span>+count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                System.out.println(<span class="string">"t2----:"</span>+count++);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>);</span><br><span class="line"><span class="comment">//        设置t1线程最大的优先级</span></span><br><span class="line">        t1.setPriority(Thread.MAX_PRIORITY);</span><br><span class="line"><span class="comment">//        设置t2线程最小的优先级</span></span><br><span class="line">        t2.setPriority(Thread.MIN_PRIORITY);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">t1----:<span class="number">34178</span></span><br><span class="line">t1----:<span class="number">34179</span></span><br><span class="line">t2----:<span class="number">28259</span></span><br><span class="line">t2----:<span class="number">28260</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>我们可以发现优先级高的线程比优先级高的有明显</strong></p>
<h4 id="5、设置线程优先级和yield的区别"><a href="#5、设置线程优先级和yield的区别" class="headerlink" title="5、设置线程优先级和yield的区别"></a>5、设置线程优先级和yield的区别</h4><p>都是可以尽量让出cpu时间片给其他线程执行，但是还是取决于cpu的执行能力和cpu是否闲忙的程度</p>
<h4 id="6、sleep应用：使用sleep限制对cpu的占用"><a href="#6、sleep应用：使用sleep限制对cpu的占用" class="headerlink" title="6、sleep应用：使用sleep限制对cpu的占用"></a>6、sleep应用：使用sleep限制对cpu的占用</h4><p>​        在没有利用 cpu 来计算时，不要让 while(true) 空转浪费 cpu，这时可以使用 yield 或 sleep 来让出 cpu 的使用权 给其他程序</p>
<ul>
<li><p>可以用 wait 或 条件变量达到类似的效果 </p>
</li>
<li><p>不同的是，后两种都需要加锁，并且需要相应的唤醒操作，一般适用于要进行同步的场景 </p>
</li>
<li><p>sleep 适用于无需锁同步的场景</p>
</li>
</ul>
<p>在<strong>单核cpu</strong>情况下，如果我们运行一下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                System.out.println(<span class="string">"hello world! "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们会发现cpu会出现占满的情况。</p>
<p>修改以上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">"hello world! "</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以发现加上sleep后cpu占用率明显下降。</p>
<h3 id="六、join的使用"><a href="#六、join的使用" class="headerlink" title="六、join的使用"></a>六、join的使用</h3><p><strong>join会阻塞当前正在运行的代码。直到该join对应的线程执行完毕。</strong> join底层其实就是wait</p>
<h4 id="1、基本应用"><a href="#1、基本应用" class="headerlink" title="1、基本应用"></a>1、基本应用</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T6</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> a=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"开始"</span>);</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"开始"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                log.info(<span class="string">"结束"</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            a=<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="string">"t1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"><span class="comment">//        主线程等待该线程结束 然后才能执行后面的代码 会阻塞当前主线程</span></span><br><span class="line">        t1.join();</span><br><span class="line">        log.info(<span class="string">"结果为:&#123;&#125;"</span>,a);</span><br><span class="line">        log.info(<span class="string">"结束"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">14</span>:<span class="number">00.197</span> [main] INFO org.lc.sleep_yield.T6 - 开始</span><br><span class="line"><span class="number">10</span>:<span class="number">14</span>:<span class="number">00.240</span> [t1] INFO org.lc.sleep_yield.T6 - 开始</span><br><span class="line"><span class="number">10</span>:<span class="number">14</span>:<span class="number">01.240</span> [t1] INFO org.lc.sleep_yield.T6 - 结束</span><br><span class="line"><span class="number">10</span>:<span class="number">14</span>:<span class="number">01.240</span> [main] INFO org.lc.sleep_yield.T6 - 结果为:<span class="number">10</span></span><br><span class="line"><span class="number">10</span>:<span class="number">14</span>:<span class="number">01.241</span> [main] INFO org.lc.sleep_yield.T6 - 结束</span><br></pre></td></tr></table></figure>

<img src="http://img.louchen.top/2020/05/20200519101859.png" style="zoom: 67%;" />

<h4 id="2、同步应用-等待多个线程结果"><a href="#2、同步应用-等待多个线程结果" class="headerlink" title="2、同步应用-等待多个线程结果"></a>2、同步应用-等待多个线程结果</h4><p>以调用方角度来讲，如果</p>
<ul>
<li>需要等待结果返回，才能继续运行就是同步</li>
<li>不需要等待结果返回，就能继续运行就是异步</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T7</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> a=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> b=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        test();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                a=<span class="number">10</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                b=<span class="number">20</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>);</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">"a:&#123;&#125;  b:&#123;&#125;  花费时间:&#123;&#125;"</span>,a,b,end-start);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">25</span>:<span class="number">45.948</span> [main] INFO org.lc.sleep_yield.T7 - a:<span class="number">10</span>  b:<span class="number">20</span>  花费时间:<span class="number">2000</span></span><br></pre></td></tr></table></figure>

<p>我们可以发现，为啥不是3秒呢？</p>
<p>因为t1线程在跑的同时，t2线程也在跑。当等待t1线程跑完时，经过了1秒，到t2线程时，t2已经跑了1秒，所以现在只用等待1s即可，所以总共为2s</p>
<img src="http://img.louchen.top/2020/05/20200519102955.png" style="zoom:67%;" />

<h4 id="3、限时同步"><a href="#3、限时同步" class="headerlink" title="3、限时同步"></a>3、限时同步</h4><p><strong>join(long n) 等待线程执行毫秒</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T7</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> a=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        test1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                a=<span class="number">10</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join(<span class="number">1500</span>);</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;"</span>,a);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">41</span>:<span class="number">59.091</span> [main] INFO org.lc.sleep_yield.T7 - <span class="number">0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们发现当join设置的小于t1线程的执行时间时，t1线程还没有执行完，主线程即不再等待，将执行join后面的代码</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T7</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> a=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        test1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                a=<span class="number">10</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        <span class="keyword">long</span> s=System.currentTimeMillis();</span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join(<span class="number">4000</span>);</span><br><span class="line">        <span class="keyword">long</span> e=System.currentTimeMillis();</span><br><span class="line">        log.info(<span class="string">"&#123;&#125;, 时间：&#123;&#125;"</span>,a,e-s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:<span class="number">46</span>:<span class="number">03.790</span> [main] INFO org.lc.sleep_yield.T7 - <span class="number">10</span>, 时间：<span class="number">2000</span></span><br></pre></td></tr></table></figure>

<ul>
<li>我们发现当设置的join时间大于t1线程的执行时间，则t1线程会提前终止join。</li>
</ul>
<h3 id="七、interrupt使用"><a href="#七、interrupt使用" class="headerlink" title="七、interrupt使用"></a>七、interrupt使用</h3><p>注意：</p>
<ul>
<li><p><code>interrupt()</code> 使线程中断 。实例方法。</p>
</li>
<li><p><code>isInterrupted()</code> 判断线程是否被打断，<strong>不会</strong>清除标记 。该方法为实例方法</p>
</li>
<li><p><code>interrupted()</code> 判断线程是否被打断，<strong>会</strong>清除标记。该方法为静态方法</p>
</li>
</ul>
<h4 id="1、打断-sleep，wait，join-的阻塞线程"><a href="#1、打断-sleep，wait，join-的阻塞线程" class="headerlink" title="1、打断 sleep，wait，join 的阻塞线程"></a>1、打断 sleep，wait，join 的阻塞线程</h4><p><strong>打断sleep，wait，join时的阻塞线程，会清除interrupt标记，即isInterrupted()为false</strong></p>
<p>这几个方法都会让线程进入阻塞状态<br><strong>打断 sleep 的线程, 会清空打断状态</strong>，以 sleep 为例(打断正在睡眠的线程)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"开始睡眠"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"interrupt"</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">        log.info(<span class="string">"打断状态:&#123;&#125;"</span>,t1.isInterrupted());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">38</span>:<span class="number">13.518</span> [Thread-<span class="number">0</span>] INFO org.lc.interrupt.T1 - 开始睡眠</span><br><span class="line"><span class="number">11</span>:<span class="number">38</span>:<span class="number">14.518</span> [main] INFO org.lc.interrupt.T1 - interrupt</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br><span class="line">	at org.lc.interrupt.T1.lambda$main$<span class="number">0</span>(T1.java:<span class="number">18</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"><span class="number">11</span>:<span class="number">38</span>:<span class="number">14.518</span> [main] INFO org.lc.interrupt.T1 - 打断状态:<span class="keyword">false</span></span><br></pre></td></tr></table></figure>

<h4 id="2、打断正常运行的线程"><a href="#2、打断正常运行的线程" class="headerlink" title="2、打断正常运行的线程"></a>2、打断正常运行的线程</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"><span class="comment">//        保证t1线程能够在main线程执行打断方法时运行</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"interrupt"</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">        log.info(<span class="string">"打断状态:&#123;&#125;"</span>,t1.isInterrupted());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">48</span>:<span class="number">32.775</span> [main] INFO org.lc.interrupt.T2 - interrupt</span><br><span class="line"><span class="number">11</span>:<span class="number">48</span>:<span class="number">32.778</span> [main] INFO org.lc.interrupt.T2 - 打断状态:<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>上述程序未终止</p>
<p>对于正常运行的线程，如果此时t1线程被告知需要打断，则需要在线程内部手动终止程序。否则会一直运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="comment">//                如果当前线程被告知要打断，即设置了interrupte标记为true</span></span><br><span class="line">                <span class="keyword">if</span>(Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">                    log.info(<span class="string">"退出循环！"</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"><span class="comment">//        保证t1线程能够在main线程执行打断方法时运行</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"interrupt"</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">        log.info(<span class="string">"打断状态:&#123;&#125;"</span>,t1.isInterrupted());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">51</span>:<span class="number">59.831</span> [main] INFO org.lc.interrupt.T2 - interrupt</span><br><span class="line"><span class="number">11</span>:<span class="number">51</span>:<span class="number">59.834</span> [t1] INFO org.lc.interrupt.T2 - 退出循环！</span><br><span class="line"><span class="number">11</span>:<span class="number">51</span>:<span class="number">59.834</span> [main] INFO org.lc.interrupt.T2 - 打断状态:<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<h4 id="3、优雅的利用interrupt打断线程"><a href="#3、优雅的利用interrupt打断线程" class="headerlink" title="3、优雅的利用interrupt打断线程"></a>3、优雅的利用interrupt打断线程</h4><h5 id="①错误思路"><a href="#①错误思路" class="headerlink" title="①错误思路"></a><strong>①错误思路</strong></h5><ul>
<li><p>使用线程对象的 stop() 方法停止线程</p>
<ul>
<li>stop 方法会真正杀死线程，如果这时线程锁住了共享资源，那么当它被杀死后就再也没有机会释放锁， 其它线程将永远无法获取锁 </li>
</ul>
</li>
<li><p>使用 System.exit(int) 方法停止线程 </p>
<ul>
<li>目的仅是停止一个线程，但这种做法会让整个程序都停止</li>
</ul>
</li>
</ul>
<h5 id="②终止模式之两阶段终止模式-Two-Phase-Termination"><a href="#②终止模式之两阶段终止模式-Two-Phase-Termination" class="headerlink" title="②终止模式之两阶段终止模式(Two Phase Termination )"></a>②终止模式之两阶段终止模式(Two Phase Termination )</h5><p>模拟应用监控，若出现应用出现异常则停止监控。手动点击停止，也停止监控</p>
<img src="http://img.louchen.top/2020/05/20200519121432.png" style="zoom:67%;" />





<h5 id="③利用-isInterrupted"><a href="#③利用-isInterrupted" class="headerlink" title="③利用 isInterrupted()"></a>③利用 isInterrupted()</h5><p>interrupt 可以打断正在执行的线程，无论这个线程是在 sleep，wait，还是正常运行</p>
<img src="http://img.louchen.top/2020/05/20200519132721.png" style="zoom:67%;" />

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TwoPhaseTermination</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    监视器线程</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Thread monitor;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 启动线程监控</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        monitor =<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="comment">//                如果当前线程是被提示需要打断</span></span><br><span class="line">                <span class="keyword">if</span>(Thread.currentThread().isInterrupted())&#123;</span><br><span class="line">                    log.info(<span class="string">"日志监控停止..."</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    log.info(<span class="string">"日志监控中..."</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"><span class="comment">//                    当主程序第一次打算该线程时，如果在sleep时被打断，则interrupt为false</span></span><br><span class="line"><span class="comment">//                    当主程序第一次打算该线程时，如果在sleep之外时被打断，则interrupt为true,这时进入while时，interrupt为true</span></span><br><span class="line"><span class="comment">//                    所以这里我们需要手动设置，该线程要被打断</span></span><br><span class="line">                    monitor.interrupt();</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"monitor"</span>);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 终止线程</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"><span class="comment">//        启动监控</span></span><br><span class="line">        start();</span><br><span class="line"><span class="comment">//        保证已经进入监控线程</span></span><br><span class="line">        Thread.sleep(<span class="number">8000</span>);</span><br><span class="line"><span class="comment">//        停止监控</span></span><br><span class="line">        log.info(<span class="string">"stop"</span>);</span><br><span class="line">        stop();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">13</span>:<span class="number">23</span>:<span class="number">05.423</span> [monitor] INFO org.lc.interrupt.TwoPhaseTermination - 日志监控中...</span><br><span class="line"><span class="number">13</span>:<span class="number">23</span>:<span class="number">07.427</span> [monitor] INFO org.lc.interrupt.TwoPhaseTermination - 日志监控中...</span><br><span class="line"><span class="number">13</span>:<span class="number">23</span>:<span class="number">09.427</span> [monitor] INFO org.lc.interrupt.TwoPhaseTermination - 日志监控中...</span><br><span class="line"><span class="number">13</span>:<span class="number">23</span>:<span class="number">11.423</span> [main] INFO org.lc.interrupt.TwoPhaseTermination - stop</span><br><span class="line">java.lang.InterruptedException: sleep interrupted</span><br><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br><span class="line">	at org.lc.interrupt.TwoPhaseTermination.lambda$start$<span class="number">0</span>(TwoPhaseTermination.java:<span class="number">31</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"><span class="number">13</span>:<span class="number">23</span>:<span class="number">11.423</span> [monitor] INFO org.lc.interrupt.TwoPhaseTermination - 日志监控停止...</span><br></pre></td></tr></table></figure>

<h4 id="4、打断park线程"><a href="#4、打断park线程" class="headerlink" title="4、打断park线程"></a>4、打断park线程</h4><p><strong>①打断 park 线程, 不会清空打断状态</strong></p>
<p><strong>②如果打断标记已经是 true, 则 park 会失效</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParkTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"park..."</span>);</span><br><span class="line"><span class="comment">//            执行到该代码时，该线程会阻塞</span></span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.info(<span class="string">"unpark..."</span>);</span><br><span class="line">            log.info(<span class="string">"打断状态:&#123;&#125;"</span>,Thread.currentThread().isInterrupted());</span><br><span class="line"></span><br><span class="line"><span class="comment">//            再次使用park,不会阻塞该线程。 当线程打断的标记为true时，park不会阻塞线程</span></span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.info(<span class="string">"unpark"</span>);</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"><span class="comment">//       打断park线程</span></span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">31</span>:<span class="number">21.611</span> [t1] INFO org.lc.interrupt.ParkTest - park...</span><br><span class="line"><span class="number">15</span>:<span class="number">31</span>:<span class="number">23.610</span> [t1] INFO org.lc.interrupt.ParkTest - unpark...</span><br><span class="line"><span class="number">15</span>:<span class="number">31</span>:<span class="number">23.610</span> [t1] INFO org.lc.interrupt.ParkTest - 打断状态:<span class="keyword">true</span></span><br><span class="line"><span class="number">15</span>:<span class="number">31</span>:<span class="number">23.611</span> [t1] INFO org.lc.interrupt.ParkTest - unpark</span><br></pre></td></tr></table></figure>

<p>我们可以发现，打断后的park，线程标记为true,再次使用park时，park不会阻塞。即只有当线程标记为falses时park才有效。</p>
<p><strong>结论：可以使用 Thread.interrupted() 清除打断状态</strong></p>
<p>注意：</p>
<ul>
<li><p><code>Thread.currentThread().isInterrupted()</code>和<code>Thread.interrupted()</code>最好不要同时使用。</p>
</li>
<li><p><code>Thread.interrupted()</code>要在<code>Thread.currentThread().isInterrupted()</code>之前使用</p>
</li>
</ul>
<h4 id="5、-不推荐的方法"><a href="#5、-不推荐的方法" class="headerlink" title="5、 不推荐的方法"></a>5、 不推荐的方法</h4><p>还有一些不推荐使用的方法，这些方法已过时，容易破坏同步代码块，造成线程死锁</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>是否static</th>
<th>功能说明</th>
</tr>
</thead>
<tbody><tr>
<td>stop()</td>
<td></td>
<td>停止线程运行</td>
</tr>
<tr>
<td>suspend()</td>
<td></td>
<td>挂起（暂停）线程运行</td>
</tr>
<tr>
<td>resume()</td>
<td></td>
<td>恢复线程运行</td>
</tr>
</tbody></table>
<h3 id="八、主线程和守护线程"><a href="#八、主线程和守护线程" class="headerlink" title="八、主线程和守护线程"></a>八、主线程和守护线程</h3><p>默认情况下线程为非守护线程，Java 进程需要等待所有线程都运行结束，才会结束。有一种特殊的线程叫做守护线程，只要其它非守 护线程运行结束了，即使守护线程的代码没有执行完，也会强制结束。</p>
<p>设置守护线程的方法：<code>setDaemon(true);</code>  该方法为实例方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaemonTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"开始运行"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">                log.info(<span class="string">"线程t1终止..."</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        t1.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"主线程终止..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">20</span>:<span class="number">42.775</span> [t1] INFO org.lc.interrupt.DaemonTest - 开始运行</span><br><span class="line"><span class="number">16</span>:<span class="number">20</span>:<span class="number">43.774</span> [main] INFO org.lc.interrupt.DaemonTest - 主线程终止...</span><br></pre></td></tr></table></figure>

<p><strong>非守护线程执行完后，所有守护线程无论是否执行完毕，直接退出。无需执行守护线程后面代码</strong></p>
<p><strong>注意</strong></p>
<ul>
<li><p>垃圾回收器线程就是一种守护线程</p>
</li>
<li><p>Tomcat 中的 Acceptor 和 Poller 线程都是守护线程，所以 Tomcat 接收到 shutdown 命令后，不会等 待它们处理完当前请求</p>
</li>
</ul>
<h3 id="九、线程的状态"><a href="#九、线程的状态" class="headerlink" title="九、线程的状态"></a>九、线程的状态</h3><h4 id="1、五种状态-操作系统层面"><a href="#1、五种状态-操作系统层面" class="headerlink" title="1、五种状态(操作系统层面)"></a>1、五种状态(操作系统层面)</h4><img src="http://img.louchen.top/2020/05/批注 2020-05-19 162918.png" style="zoom: 50%;" />

<ul>
<li>【初始状态】仅是在语言层面创建了线程对象，还未与操作系统线程关联</li>
<li>【可运行状态】（就绪状态）指该线程已经被创建（与操作系统线程关联），可以由 CPU 调度执行 </li>
<li>【运行状态】指获取了 CPU 时间片运行中的状态<ul>
<li>当 CPU 时间片用完，会从【运行状态】转换至【可运行状态】，会导致线程的上下文切换</li>
</ul>
</li>
<li>【阻塞状态】<ul>
<li>如果调用了阻塞 API，如 BIO(同步阻塞I/O) 读写文件，这时该线程实际不会用到 CPU，会导致线程上下文切换，进入 【阻塞状态】 </li>
<li>等 BIO 操作完毕，会由操作系统唤醒阻塞的线程，转换至【可运行状态】</li>
<li>与【可运行状态】的区别是，对【阻塞状态】的线程来说只要它们一直不唤醒，调度器就一直不会考虑 调度它们 </li>
</ul>
</li>
<li>【终止状态】表示线程已经执行完毕，生命周期已经结束，不会再转换为其它状态</li>
</ul>
<h4 id="2、六种状态-Java层面"><a href="#2、六种状态-Java层面" class="headerlink" title="2、六种状态(Java层面)"></a>2、六种状态(Java层面)</h4><p>这是从 Java API 层面来描述的</p>
<p>根据 Thread.State 枚举，分为六种状态</p>
<img src="http://img.louchen.top/2020/05/20200519170638.png" style="zoom: 50%;" />

<ul>
<li><code>NEW</code>  线程刚被创建，但是还没有调用 start() 方法</li>
<li><code>RUNNABLE</code> 当调用了 start() 方法之后，注意，Java API 层面的 RUNNABLE 状态涵盖了 操作系统 层面的 【可运行状态】、【运行状态】和【阻塞状态】（由于 BIO 导致的线程阻塞，在 Java 里无法区分，仍然认为 是可运行） </li>
<li><code>BLOCKED</code> ， <code>WAITING</code>， <code>TIMED_WAITING</code> 都是 Java API 层面对【阻塞状态】的细分，后面会在状态转换一节 详述 </li>
<li><code>TERMINATED</code> 当线程代码运行结束</li>
<li><img src="C:%5CUsers%5C42119%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5C1590227934591.png" alt="1590227934591"></li>
</ul>
<h4 id="3、代码示例六种状态"><a href="#3、代码示例六种状态" class="headerlink" title="3、代码示例六种状态"></a>3、代码示例六种状态</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PeriodTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//       模拟新建状态NEW</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"running..."</span>);</span><br><span class="line">        &#125;, <span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        模拟可运行状态Runnable</span></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="comment">//                即任务的重复执行,执行完后从运行状态又回到可运行状态</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"t2"</span>);</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        模拟终止TERMINATED状态</span></span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"running..."</span>);</span><br><span class="line">        &#125;, <span class="string">"t3"</span>);</span><br><span class="line">        t3.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        模拟有时限的等待状态TIMED WAITING</span></span><br><span class="line">        Thread t4 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line"><span class="comment">//            获得当前对象锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (PeriodTest<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                    足够的睡眠时间</span></span><br><span class="line">                    Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"t4"</span>);</span><br><span class="line">        t4.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        模拟WAITING</span></span><br><span class="line">        Thread t5 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                阻塞状态 都不会得到任务调度器的调度</span></span><br><span class="line">                t2.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"t5"</span>);</span><br><span class="line">        t5.start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        模拟BLOCK</span></span><br><span class="line">        Thread t6 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line"><span class="comment">//            此时的锁已经被t4线程拿到。所以这里拿不到锁</span></span><br><span class="line">            <span class="keyword">synchronized</span> (PeriodTest<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"t6"</span>);</span><br><span class="line">        t6.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            等待t3线程执行完</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">"t1的线程状态为:&#123;&#125;"</span>, t1.getState());</span><br><span class="line">        log.info(<span class="string">"t2的线程状态为:&#123;&#125;"</span>, t2.getState());</span><br><span class="line">        log.info(<span class="string">"t3的线程状态为:&#123;&#125;"</span>, t3.getState());</span><br><span class="line">        log.info(<span class="string">"t4的线程状态为:&#123;&#125;"</span>, t4.getState());</span><br><span class="line">        log.info(<span class="string">"t5的线程状态为:&#123;&#125;"</span>, t5.getState());</span><br><span class="line">        log.info(<span class="string">"t6的线程状态为:&#123;&#125;"</span>, t6.getState());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">16.284</span> [t3] INFO org.lc.interrupt.PeriodTest - running...</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">17.284</span> [main] INFO org.lc.interrupt.PeriodTest - t1的线程状态为:NEW</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">17.285</span> [main] INFO org.lc.interrupt.PeriodTest - t2的线程状态为:RUNNABLE</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">17.285</span> [main] INFO org.lc.interrupt.PeriodTest - t3的线程状态为:TERMINATED</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">17.285</span> [main] INFO org.lc.interrupt.PeriodTest - t4的线程状态为:TIMED_WAITING</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">17.285</span> [main] INFO org.lc.interrupt.PeriodTest - t5的线程状态为:WAITING</span><br><span class="line"><span class="number">17</span>:<span class="number">30</span>:<span class="number">17.285</span> [main] INFO org.lc.interrupt.PeriodTest - t6的线程状态为:BLOCKED</span><br></pre></td></tr></table></figure>

<h3 id="十、习题"><a href="#十、习题" class="headerlink" title="十、习题"></a>十、习题</h3><h4 id="1、烧水泡茶-sleep"><a href="#1、烧水泡茶-sleep" class="headerlink" title="1、烧水泡茶(sleep)"></a>1、烧水泡茶(sleep)</h4><p>阅读华罗庚《统筹方法》，给出烧水泡茶的多线程解决方案</p>
<img src="http://img.louchen.top/2020/05/20200519175203.png" style="zoom:50%;" />



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T8</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"洗水壶..."</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                log.info(<span class="string">"烧水..."</span>);</span><br><span class="line">                Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"张三"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"洗茶壶..."</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                log.info(<span class="string">"洗茶杯..."</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                log.info(<span class="string">"拿茶叶..."</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//                等待t1烧水的线程执行完。</span></span><br><span class="line"><span class="comment">//                WAITING</span></span><br><span class="line">                t1.join();</span><br><span class="line">                log.info(<span class="string">"泡茶叶..."</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"小三"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">18</span>:<span class="number">01</span>:<span class="number">49.779</span> [小三] INFO org.lc.sleep_yield.T8 - 洗茶壶...</span><br><span class="line"><span class="number">18</span>:<span class="number">01</span>:<span class="number">49.780</span> [张三] INFO org.lc.sleep_yield.T8 - 洗水壶...</span><br><span class="line"><span class="number">18</span>:<span class="number">01</span>:<span class="number">50.782</span> [张三] INFO org.lc.sleep_yield.T8 - 烧水...</span><br><span class="line"><span class="number">18</span>:<span class="number">01</span>:<span class="number">50.782</span> [小三] INFO org.lc.sleep_yield.T8 - 洗茶杯...</span><br><span class="line"><span class="number">18</span>:<span class="number">01</span>:<span class="number">51.783</span> [小三] INFO org.lc.sleep_yield.T8 - 拿茶叶...</span><br><span class="line"><span class="number">18</span>:<span class="number">02</span>:<span class="number">00.783</span> [小三] INFO org.lc.sleep_yield.T8 - 泡茶叶...</span><br></pre></td></tr></table></figure>

<h4 id="2、多线程下载图片"><a href="#2、多线程下载图片" class="headerlink" title="2、多线程下载图片"></a>2、多线程下载图片</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadImage</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DownloadImage</span><span class="params">(String url, String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.url=url;</span><br><span class="line">        <span class="keyword">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">downloadImageHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileUtils.copyURLToFile(<span class="keyword">new</span> URL(<span class="keyword">this</span>.url),<span class="keyword">new</span> File(<span class="keyword">this</span>.name));</span><br><span class="line">            System.out.println(<span class="string">"下载文件:"</span>+<span class="keyword">this</span>.name);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.downloadImageHandler();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DownloadImage d1=<span class="keyword">new</span> DownloadImage(<span class="string">"http://img.louchen.top/2020/05/rdb01.png"</span>, <span class="string">"1.png"</span>);</span><br><span class="line">        DownloadImage d2=<span class="keyword">new</span> DownloadImage(<span class="string">"http://img.louchen.top/2020/05/rdb02.png"</span>, <span class="string">"2.png"</span>);</span><br><span class="line">        DownloadImage d3=<span class="keyword">new</span> DownloadImage(<span class="string">"http://img.louchen.top/2020/05/aof01.png"</span>, <span class="string">"3.png"</span>);</span><br><span class="line">        DownloadImage d4=<span class="keyword">new</span> DownloadImage(<span class="string">"http://img.louchen.top/2020/05/aof02.png"</span>, <span class="string">"4.png"</span>);</span><br><span class="line">        d1.start();</span><br><span class="line">        d2.start();</span><br><span class="line">        d3.start();</span><br><span class="line">        d4.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3、龟兔赛跑"><a href="#3、龟兔赛跑" class="headerlink" title="3、龟兔赛跑"></a>3、龟兔赛跑</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Race</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String winner;</span><br><span class="line">    <span class="function"><span class="keyword">protected</span>  <span class="keyword">boolean</span> <span class="title">isOver</span><span class="params">(<span class="keyword">int</span> step)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(winner!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (step == <span class="number">100</span>) &#123;</span><br><span class="line">            winner=Thread.currentThread().getName();</span><br><span class="line">            System.out.println(<span class="string">"胜利者是:"</span>+winner);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;=<span class="number">100</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> over = <span class="keyword">this</span>.isOver(i);</span><br><span class="line">            <span class="keyword">if</span>(over)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(Thread.currentThread().getName()+<span class="string">":跑了"</span>+i+<span class="string">"步;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Race(), <span class="string">"乌龟"</span>);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Race(), <span class="string">"兔子"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Ⅲ、共享线程之管程-悲观锁"><a href="#Ⅲ、共享线程之管程-悲观锁" class="headerlink" title="Ⅲ、共享线程之管程(悲观锁)"></a>Ⅲ、共享线程之管程(悲观锁)</h2><h3 id="1、共享带来的问题"><a href="#1、共享带来的问题" class="headerlink" title="1、共享带来的问题"></a>1、共享带来的问题</h3><h4 id="①、java的体现"><a href="#①、java的体现" class="headerlink" title="①、java的体现"></a>①、java的体现</h4><p>两个线程对初始值为 0 的静态变量一个做自增，一个做自减，各做 5000 次，结果是 0 吗？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                count--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">47</span>:<span class="number">14.620</span> [main] INFO org.lc.synchronized_t.T1 - count:<span class="number">486</span></span><br></pre></td></tr></table></figure>

<p><strong>答案显然不为0</strong></p>
<h4 id="②、问题分析"><a href="#②、问题分析" class="headerlink" title="②、问题分析"></a>②、问题分析</h4><p>以上的结果可能是正数、负数、零。为什么呢？因为 Java 中对静态变量的自增，自减并不是原子操作，要彻底理 解，必须从字节码来进行分析</p>
<p>例如对于 <code>i++</code>而言（i 为静态变量），实际会产生如下的 JVM 字节码指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getstatic     i  <span class="comment">// 获取静态变量i的值</span></span><br><span class="line">iconst_1         <span class="comment">// 准备常量1</span></span><br><span class="line">iadd             <span class="comment">// 自增 </span></span><br><span class="line">putstatic     i  <span class="comment">// 将修改后的值存入静态变量i</span></span><br></pre></td></tr></table></figure>

<p>而对应 <code>i--</code> 也是类似：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getstatic     i  <span class="comment">// 获取静态变量i的值 </span></span><br><span class="line">iconst_1         <span class="comment">// 准备常量1 </span></span><br><span class="line">isub             <span class="comment">// 自减 </span></span><br><span class="line">putstatic     i  <span class="comment">// 将修改后的值存入静态变量i</span></span><br></pre></td></tr></table></figure>

<p>而 Java 的内存模型如下，完成静态变量的自增，自减需要在主存和工作内存中进行数据交换：</p>
<img src="http://img.louchen.top/2020/05/20200519215657.png" style="zoom: 50%;" />

<p>如果是<strong>单线程</strong>以上 8 行代码是顺序执行（不会交错）没有问题：</p>
<img src="http://img.louchen.top/2020/05/20200519215736.png" style="zoom: 67%;" />

<p>但<strong>多线程</strong>下这 8 行代码可能交错运行：<br>出现<strong>负数</strong>的情况：</p>
<img src="http://img.louchen.top/2020/05/20200519220028.png" style="zoom:67%;" />

<p>出现<strong>正数</strong>的情况:</p>
<img src="http://img.louchen.top/2020/05/20200519220155.png" style="zoom: 67%;" />

<h4 id="③、临界区-Critical-Section"><a href="#③、临界区-Critical-Section" class="headerlink" title="③、临界区 Critical Section"></a>③、临界区 Critical Section</h4><ul>
<li>一个程序运行多个线程本身是没有问题的 </li>
<li>问题出在多个线程访问共享资源 <ul>
<li>多个线程读共享资源其实也没有问题 </li>
<li>在多个线程对共享资源读写操作时发生指令交错，就会出现问题</li>
</ul>
</li>
<li>一段代码块内如果存在对共享资源的多线程读写操作，称这段代码块为临界区</li>
</ul>
<p>例如，下面代码中的临界区：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> counter = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> <span class="comment">// 临界区 </span></span></span><br><span class="line"><span class="function"></span>&#123;        </span><br><span class="line">    counter++; </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span> <span class="comment">// 临界区 </span></span></span><br><span class="line"><span class="function"></span>&#123;        </span><br><span class="line">    counter--;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="④、竞态条件-Race-Condition-："><a href="#④、竞态条件-Race-Condition-：" class="headerlink" title="④、竞态条件(Race Condition )："></a>④、竞态条件(Race Condition )：</h4><p>多个线程在临界区内执行，由于代码的执行序列不同而导致结果无法预测，称之为发生了<strong>竞态条件</strong></p>
<h3 id="4、synchronized-也叫互斥锁-解决方案"><a href="#4、synchronized-也叫互斥锁-解决方案" class="headerlink" title="4、synchronized(也叫互斥锁)解决方案"></a>4、synchronized(也叫互斥锁)解决方案</h3><p>为了避免临界区的竞态条件发生，有多种手段可以达到目的。</p>
<ul>
<li>阻塞式的解决方案：synchronized，Lock </li>
<li>非阻塞式的解决方案：原子变量</li>
</ul>
<p><strong>阻塞式的【对象锁】：</strong>它采用互斥的方式让同一 时刻至多只有一个线程能持有【对象锁】，其它线程再想获取这个【对象锁】时就会阻塞住。这样就能保证拥有锁 的线程可以安全的执行临界区内的代码，不用担心线程上下文切换</p>
<blockquote>
<p>注意:</p>
<p>虽然 java 中互斥和同步都可以采用 synchronized 关键字来完成，但它们还是有区别的：</p>
<ul>
<li>互斥是保证临界区的竞态条件发生，同一时刻只能有一个线程执行临界区代码 </li>
<li>同步是由于线程执行的先后、顺序不同、需要一个线程等待其它线程运行到某个点</li>
</ul>
</blockquote>
<h5 id="①语法"><a href="#①语法" class="headerlink" title="①语法"></a>①语法</h5><p>线程1拿到对象锁之后，线程2来访问该临界区会发生blocked阻塞</p>
<p><strong>注意</strong>：锁不能为<strong>基本数据类型</strong>。只能为实例类型或包装类,包括String,且不能为null。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(对象) <span class="comment">// 线程1， 线程2(blocked) </span></span><br><span class="line">&#123;    </span><br><span class="line">    临界区    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="②解决上述1中出现的问题"><a href="#②解决上述1中出现的问题" class="headerlink" title="②解决上述1中出现的问题"></a>②解决上述1中出现的问题</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line"><span class="comment">//    o对象作为锁对象</span></span><br><span class="line">    <span class="keyword">static</span> Object o=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//临界区为count++</span></span><br><span class="line">                <span class="keyword">synchronized</span> (o) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="comment">////临界区为count--</span></span><br><span class="line">                <span class="keyword">synchronized</span> (o) &#123;</span><br><span class="line">                    count--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">15</span>:<span class="number">17.879</span> [main] INFO org.lc.synchronized_t.T1 - count:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>这时我们发现是始终为0</p>
<p>交替执行count++和count–。</p>
<p>假如t1线程中先拿到锁，执行完count++代码块之后，该线程释放锁，然后，t1和t2线程再次同时竞争该锁，谁拿到锁谁先执行，没拿到的等待。直到所有的代码程序执行完毕。</p>
<h5 id="③时序提来解释上述过程"><a href="#③时序提来解释上述过程" class="headerlink" title="③时序提来解释上述过程"></a>③时序提来解释上述过程</h5><img src="http://img.louchen.top/2020/05/批注 2020-05-20 112818.png" style="zoom:67%;" />

<h5 id="④通俗的方式解释"><a href="#④通俗的方式解释" class="headerlink" title="④通俗的方式解释"></a>④通俗的方式解释</h5><img src="http://img.louchen.top/2020/05/20200520111759.png" style="zoom: 80%;" />

<p>你可以做这样的类比：</p>
<ul>
<li>synchronized(对象) 中的对象，可以想象为一个房间（room），有唯一入口（门）房间只能一次进入一人 进行计算，线程 t1，t2 想象成两个人 </li>
<li>当线程 t1 执行到 synchronized(room) 时就好比 t1 进入了这个房间，并锁住了门拿走了钥匙，在门内执行 count++ 代码</li>
<li>这时候如果 t2 也运行到了 synchronized(room) 时，它发现门被锁住了，只能在门外等待，发生了上下文切 换，阻塞住了</li>
<li>这中间即使 <strong>t1 的 cpu 时间片不幸用完</strong>，被踢出了门外（不要错误理解为锁住了对象就能一直执行下去哦）， 这时门还是锁住的，<strong>t1 仍拿着钥匙，t2 线程还在阻塞状态进不来</strong>，只有下次轮到 t1 自己再次获得时间片时才 能开门进入 </li>
<li><strong>当 t1 执行完 synchronized{} 块内的代码，这时候才会从 obj 房间出来并解开门上的锁，</strong>唤醒 t2 线程把钥 匙给他。t2 线程这时才可以进入 obj 房间，锁住了门拿上钥匙，执行它的 count– 代码</li>
</ul>
<h5 id="⑤思考"><a href="#⑤思考" class="headerlink" title="⑤思考"></a>⑤思考</h5><ul>
<li><p>如果把 synchronized(obj) 放在 for 循环的外面，如何理解？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line"><span class="comment">//    o对象作为锁对象</span></span><br><span class="line">    <span class="keyword">static</span> Object o=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (o) &#123;</span><br><span class="line">                <span class="comment">//相当于两条的自增指令，保持原子性执行了200次，该期间不会被其他线程所干扰</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"t1"</span>);</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (o) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"t2"</span>);</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次需要把synchronized(锁){}中的代码块执行完后才会释放锁，即谁先拿到锁，谁先执行完所有for循环的count++或count–操作。</p>
</li>
<li><p>如果 t1 synchronized(obj1) 而 t2 synchronized(obj2) 会怎样运作？</p>
<ul>
<li>锁住的对象不同，没有产生竞争关系。 无效</li>
</ul>
</li>
<li><p>如果 t1 synchronized(obj) 而 t2 没有加会怎么样？如何理解？</p>
<ul>
<li>对象没有产生竞争。无效</li>
</ul>
</li>
</ul>
<h5 id="⑥面向对象改进"><a href="#⑥面向对象改进" class="headerlink" title="⑥面向对象改进"></a>⑥面向对象改进</h5><p>把需要保护的共享变量放入一个类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Room room=<span class="keyword">new</span> Room();</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"t1"</span>);</span><br><span class="line">                    room.increment();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"t2"</span>);</span><br><span class="line">                    room.decrement();</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line"><span class="comment">//        让t1线程跑完</span></span><br><span class="line">        t1.join();</span><br><span class="line"><span class="comment">//        让t2线程跑完</span></span><br><span class="line">        t2.join();</span><br><span class="line">        log.info(<span class="string">"count:&#123;&#125;"</span>,room.getCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="comment">//        锁住当前创建的对象</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrement</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            count--;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//交替执行t1 t2</span></span><br><span class="line"><span class="number">12</span>:<span class="number">56</span>:<span class="number">13.825</span> [main] INFO org.lc.synchronized_t.T1 - count:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="5、方法上的synchronized"><a href="#5、方法上的synchronized" class="headerlink" title="5、方法上的synchronized"></a>5、方法上的synchronized</h3><ul>
<li>非静态方法锁的是对象， 静态方法因为共享性质，锁的是类对象(类对象只能有一份，即无论new多少个对象，其中的类对象只有一份)</li>
<li>类中的非静态成员储存在堆。静态方法储存在方法区，被该类中的对象所共享</li>
</ul>
<h5 id="①加在普通方法"><a href="#①加在普通方法" class="headerlink" title="①加在普通方法"></a>①加在普通方法</h5><p><strong>注意：</strong>这里不叫锁方法，而是叫锁当前this对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">		</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//等价于==&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(<span class="keyword">this</span>)&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="②加在静态方法上"><a href="#②加在静态方法上" class="headerlink" title="②加在静态方法上"></a>②加在静态方法上</h5><p><strong>注意：</strong>这里叫锁类对象，因为在静态方法中无法调用this对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//等价于==&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(Test<span class="class">.<span class="keyword">class</span>)</span>&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="③线程八锁"><a href="#③线程八锁" class="headerlink" title="③线程八锁"></a>③线程八锁</h5><p>其实就是考察 synchronized 锁住的是哪个对象(实例对象，还是类对象)</p>
<p>*<em>情况1： *</em> 结果为1 2 或 2 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number=<span class="keyword">new</span> Number();</span><br><span class="line"><span class="comment">//        使用的同一对象，即锁同一对象，产生互斥</span></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;number.a();&#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;number.b();&#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况2:</strong>  结果为 2 （1秒后） 1    或     (1秒后)  1  2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number=<span class="keyword">new</span> Number();</span><br><span class="line"><span class="comment">//        使用的同一对象，即锁同一对象，产生互斥</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;number.a();&#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;number.b();&#125;,<span class="string">"t2"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//如果线程首先运行此代码，则后序线程使用该对象(是对象，不是方法)时，会阻塞。</span></span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">"1"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况3：</strong> </p>
<p>结果为： 3   (1秒后) 1 2   或   3  2  (1秒后)  1   或    2   3  (1秒后)  1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number=<span class="keyword">new</span> Number();</span><br><span class="line"><span class="comment">//        t1,t2使用的同一对象，即锁同一对象，产生互斥</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;number.a();&#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;number.b();&#125;,<span class="string">"t2"</span>);</span><br><span class="line"><span class="comment">//        t3与(t1,t2)并行，t1与t2产生竞争关系</span></span><br><span class="line">        Thread t3=<span class="keyword">new</span> Thread(()-&gt;&#123;number.c();&#125;,<span class="string">"t3"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">"1"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">c</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"3"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况4：</strong>结果为 2 （1秒后） 1  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number1=<span class="keyword">new</span> Number();</span><br><span class="line">        Number number2=<span class="keyword">new</span> Number();</span><br><span class="line"><span class="comment">//        t1,t2使用的不同对象，即不互斥  并行关系</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;number1.a();&#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;number2.b();&#125;,<span class="string">"t2"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.debug(<span class="string">"1"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况5：</strong>  结果为 2 （1秒后） 1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number1=<span class="keyword">new</span> Number();</span><br><span class="line"><span class="comment">//        t1执行的为类对象  t2为this实例对象。即为并行关系</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;number1.a();&#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;number1.b();&#125;,<span class="string">"t2"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span></span>&#123;</span><br><span class="line"><span class="comment">//    锁的为类对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            log.debug(<span class="string">"1"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    锁的为this对象实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况6：</strong> 结果为 2 （1秒后） 1    或     (1秒后)  1  2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number1=<span class="keyword">new</span> Number();</span><br><span class="line"><span class="comment">//        t1与t2执行的都是同一类对象。即为互斥关系</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;number1.a();&#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;number1.b();&#125;,<span class="string">"t2"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span></span>&#123;</span><br><span class="line"><span class="comment">//    锁的为类对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.debug(<span class="string">"1"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    锁的为类对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况7：</strong> 2  （1秒后)   1</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number1=<span class="keyword">new</span> Number();</span><br><span class="line">        Number number2=<span class="keyword">new</span> Number();</span><br><span class="line"><span class="comment">//        t1锁的为类对象Number，无论new多少个对象，类对象只有一个。</span></span><br><span class="line"><span class="comment">//        t2锁的为this对象实例</span></span><br><span class="line"><span class="comment">//        t1与t2并行关系</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;number1.a();&#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;number2.b();&#125;,<span class="string">"t2"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span></span>&#123;</span><br><span class="line"><span class="comment">//    锁的为类对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.debug(<span class="string">"1"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    锁的为this实例对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span>  <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>情况8：</strong>  结果为 2 （1秒后） 1    或     (1秒后)  1  2</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Number number1=<span class="keyword">new</span> Number();</span><br><span class="line">        Number number2=<span class="keyword">new</span> Number();</span><br><span class="line"><span class="comment">//        t1锁的为类对象Number，无论new多少个对象，类对象只有一个Number.class。</span></span><br><span class="line"><span class="comment">//        t1锁的为类对象Number，无论new多少个对象，类对象只有一个Number.class。</span></span><br><span class="line"><span class="comment">//        t1与t2互斥关系</span></span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;number1.a();&#125;,<span class="string">"t1"</span>);</span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;number2.b();&#125;,<span class="string">"t2"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Number</span></span>&#123;</span><br><span class="line"><span class="comment">//    锁的为类对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">a</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            log.debug(<span class="string">"1"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    锁的为类对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">b</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.debug(<span class="string">"2"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="结论："><a href="#结论：" class="headerlink" title="结论："></a>结论：</h6><ul>
<li><p><strong>锁类对象</strong>：首先判断是否为同一类对象，若为同一类对象，无论new多少次，类对象只有一份。即产生互斥 </p>
<ul>
<li><pre><code class="java"><span class="function"><span class="keyword">static</span> <span class="keyword">synchronized</span>  <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>{}
&lt;!--￼<span class="number">63</span>--&gt;</code></pre>
</li>
</ul>
</li>
<li><p><strong>锁this类对象：</strong> 若使用的同一实例对象(需要在临界区加synchronized)，则产生互斥。</p>
<ul>
<li><pre><code class="java"><span class="function"><span class="keyword">synchronized</span>  <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span></span>{}
&lt;!--￼<span class="number">64</span>--&gt;
</code></pre>
</li>
</ul>
</li>
</ul>
<h3 id="6、变量的线程安全分析"><a href="#6、变量的线程安全分析" class="headerlink" title="6、变量的线程安全分析"></a>6、变量的线程安全分析</h3><h5 id="①成员变量和静态变量是否线程安全"><a href="#①成员变量和静态变量是否线程安全" class="headerlink" title="①成员变量和静态变量是否线程安全"></a>①成员变量和静态变量是否线程安全</h5><ul>
<li>如果它们没有共享，则线程安全 </li>
<li>如果它们被共享了，根据它们的状态是否能够改变，又分两种情况 <ul>
<li>如果只有读操作，则线程安全</li>
<li>如果有读写操作，则这段代码是临界区，需要考虑线程安全</li>
</ul>
</li>
</ul>
<h5 id="②局部变量是否线程安全？"><a href="#②局部变量是否线程安全？" class="headerlink" title="②局部变量是否线程安全？"></a>②局部变量是否线程安全？</h5><ul>
<li>局部变量是线程安全的</li>
<li>但局部变量引用的对象则未必 <ul>
<li>如果该对象没有逃离方法的作用访问，它是线程安全的 </li>
<li>如果该对象逃离方法的作用范围(即该对象为方法外的变量)，需要考虑线程安全</li>
</ul>
</li>
</ul>
<h6 id="局部变量线程安全分析"><a href="#局部变量线程安全分析" class="headerlink" title="局部变量线程安全分析"></a>局部变量线程安全分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">10</span>;</span><br><span class="line">        i++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每个线程调用 test1() 方法时局部变量 i，会在每个线程的栈帧内存中被创建多份，<strong>因此不存在共享</strong>。<strong>即每个线程在栈中的独立栈帧都会创建一个新的i变量内存</strong></p>
<img src="http://img.louchen.top/2020/05/20200520200704.png" style="zoom:50%;" />

<h5 id="③引用的变量在方法外-产生线程安全问题"><a href="#③引用的变量在方法外-产生线程安全问题" class="headerlink" title="③引用的变量在方法外(产生线程安全问题)"></a>③引用的变量在方法外(产生线程安全问题)</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line"><span class="comment">//    线程个数</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span>  <span class="keyword">int</span> THRUED_NUMBER=<span class="number">2</span>;</span><br><span class="line"><span class="comment">//    循环次数</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOOP_NUMBER=<span class="number">200</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadUnSafe test=<span class="keyword">new</span> ThreadUnSafe();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THRUED_NUMBER; i++) &#123;</span><br><span class="line"><span class="comment">//            这里两个线程共用同一个对象中的list成员变量。所以会发生remove异常(未添加元素就移除)</span></span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                test.method1(LOOP_NUMBER);</span><br><span class="line">            &#125;,<span class="string">"Thread:"</span>+i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadUnSafe</span></span>&#123;</span><br><span class="line"><span class="comment">//    成员变量</span></span><br><span class="line">    ArrayList&lt;String&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="comment">//临界区 产生竞争条件</span></span><br><span class="line">            <span class="keyword">this</span>.method2();</span><br><span class="line">            <span class="keyword">this</span>.method3();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        list.add(<span class="string">"1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"Thread:0"</span> java.lang.IndexOutOfBoundsException: Index: <span class="number">0</span>, Size: <span class="number">0</span></span><br><span class="line">	at java.util.ArrayList.rangeCheck(ArrayList.java:<span class="number">657</span>)</span><br><span class="line">	at java.util.ArrayList.remove(ArrayList.java:<span class="number">496</span>)</span><br><span class="line">	at org.lc.synchronized_t.ThreadUnSafe.method3(T3.java:<span class="number">45</span>)</span><br><span class="line">	at org.lc.synchronized_t.ThreadUnSafe.method1(T3.java:<span class="number">36</span>)</span><br><span class="line">	at org.lc.synchronized_t.T3.lambda$main$<span class="number">0</span>(T3.java:<span class="number">21</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br></pre></td></tr></table></figure>

<p><strong>分析：</strong>即某一个线程先执行add,我们发现add源码中有一个size++，该size是成员变量，多个线程共享size操作，即会出现线程不安全的问题。即不同的线程操作add时，可能size可能出现竞争导致size写回的时候不会添加或者添加被覆盖的情况。即会出现索引越界的异常</p>
<img src="http://img.louchen.top/2020/05/20200520203425.png" style="zoom: 67%;" />

<h5 id="④引用的变量在方法内-线程安全"><a href="#④引用的变量在方法内-线程安全" class="headerlink" title="④引用的变量在方法内(线程安全)"></a>④引用的变量在方法内(线程安全)</h5><p>将 list 修改为局部变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line"><span class="comment">//    线程个数</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span>  <span class="keyword">int</span> THRUED_NUMBER=<span class="number">2</span>;</span><br><span class="line"><span class="comment">//    循环次数</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LOOP_NUMBER=<span class="number">200</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadUnSafe test=<span class="keyword">new</span> ThreadUnSafe();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; THRUED_NUMBER; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                test.method1(LOOP_NUMBER);</span><br><span class="line">            &#125;,<span class="string">"Thread:"</span>+i).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadUnSafe</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//    局部变量</span></span><br><span class="line">        ArrayList&lt;String&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="keyword">this</span>.method2(list);</span><br><span class="line">            <span class="keyword">this</span>.method3(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        list.add(<span class="string">"1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>分析：</strong></p>
<ul>
<li>list 是局部变量，每个线程调用时会创建其不同实例，没有共享 </li>
<li>不同线程为list变量创建不同的栈帧内存。即不共享</li>
<li>而 method2 的参数是从 method1 中传递过来的，与 method1 中引用同一个对象 </li>
</ul>
<img src="http://img.louchen.top/2020/05/20200520204110.png" style="zoom: 67%;" />

<p>方法访问修饰符带来的思考，如果把 method2 和 method3 的方法修改为 public 会不会代理线程安全问题？</p>
<ul>
<li>情况1：有其它线程调用 method2 和 method3</li>
<li>情况2：在 情况1 的基础上，为 ThreadSafe 类添加子类，子类覆盖 method2 或 method3 方法，即</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadUnSafe</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method1</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        ArrayList&lt;String&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            method2(list);</span><br><span class="line">            method3(list);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method2</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        list.add(<span class="string">"1"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        list.remove(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadSafeSubClass</span> <span class="keyword">extends</span> <span class="title">ThreadUnSafe</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method3</span><span class="params">(ArrayList&lt;String&gt; list)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            list.remove(<span class="number">0</span>);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结论：从这个例子可以看出 <strong>private</strong> 或 <strong>ﬁnal</strong> 提供【安全】的意义所在，请体会开闭原则中的【闭】</p>
<h3 id="7、常见线程安全类"><a href="#7、常见线程安全类" class="headerlink" title="7、常见线程安全类"></a>7、常见线程安全类</h3><ul>
<li><p>String </p>
</li>
<li><p>Integer </p>
</li>
<li><p>StringBuﬀer </p>
</li>
<li><p>Random </p>
</li>
<li><p>Vector </p>
</li>
<li><p>Hashtable</p>
</li>
<li><p>java.util.concurrent 包下的类</p>
</li>
</ul>
<p>这里说它们是线程安全的是指，多个线程调用它们同一个实例的某个方法时，是线程安全的。也可以理解为：</p>
<blockquote>
<p>HashTable给每个方法加上synchronized给对象上锁。即多个线程操作同一个对象会产生互斥，只要是操作了对象中的任意synchronized方法</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Hashtable hashtable=<span class="keyword">new</span> Hashtable();</span><br><span class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">    hashtable.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">&#125;,<span class="string">"t1"</span>).start();</span><br><span class="line"><span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">    hashtable.put(<span class="string">"k2"</span>, <span class="string">"v2"</span>);</span><br><span class="line">&#125;,<span class="string">"t2"</span>).start();</span><br></pre></td></tr></table></figure>

<ul>
<li>它们的每个方法是原子的</li>
</ul>
<h5 id="①线程安全类方法的组合-非线程安全"><a href="#①线程安全类方法的组合-非线程安全" class="headerlink" title="①线程安全类方法的组合(非线程安全)"></a>①线程安全类方法的组合(非线程安全)</h5><p>这种组合方式，并不能保证原子性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hashtable hashtable=<span class="keyword">new</span> Hashtable();</span><br><span class="line"><span class="comment">//多个线程操作 t1,t2</span></span><br><span class="line"><span class="keyword">if</span>(hashtable.get(<span class="string">"k1"</span>)==<span class="keyword">null</span>)&#123;</span><br><span class="line">    hashtable.put(<span class="string">"k1"</span>, <span class="string">"v1"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>假设线程1先拿到锁，先执行get操作，执行完后会释放锁。此时t2线程开始执行get操作，执行完后释放锁，恰巧t2线程又拿到了锁执行put操作，执行完后释放锁。然后t1线程拿到锁执行put操作，此时t2线程的put操作已被t1线程覆盖</p>
<img src="http://img.louchen.top/2020/05/20200521100207.png" style="zoom:67%;" />

<h5 id="②不可变类线程安全性"><a href="#②不可变类线程安全性" class="headerlink" title="②不可变类线程安全性"></a>②不可变类线程安全性</h5><p>String、Integer 等都是不可变类，因为其内部的状态不可以改变，因此它们的方法都是线程安全的 </p>
<p>String 有 replace，substring 等方法【可以】改变值啊，那么这些方法又是如何保证线程安 全的呢？</p>
<p><strong>因为我们从源码可以发现，replace和substring 都是对其原来的字符串进行修改拷贝后重新new了一个新的字符串</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">substring</span><span class="params">(<span class="keyword">int</span> beginIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beginIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(beginIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> subLen = value.length - beginIndex;</span><br><span class="line">        <span class="keyword">if</span> (subLen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(subLen);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (beginIndex == <span class="number">0</span>) ? <span class="keyword">this</span> : <span class="keyword">new</span> String(value, beginIndex, subLen);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="8、习题"><a href="#8、习题" class="headerlink" title="8、习题"></a>8、习题</h3><h5 id="①买票"><a href="#①买票" class="headerlink" title="①买票"></a>①买票</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4</span> </span>&#123;</span><br><span class="line"><span class="comment">//    random线程安全</span></span><br><span class="line">    <span class="keyword">static</span> Random random=<span class="keyword">new</span> Random();</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 随机获取买票数量 1-5</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">randomAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> random.nextInt(<span class="number">5</span>)+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        TicketWindow ticketWindow = <span class="keyword">new</span> TicketWindow(<span class="number">2000</span>);</span><br><span class="line"><span class="comment">//        储存线程</span></span><br><span class="line">        List&lt;Thread&gt; threadList=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//        存储每个线程卖的票数</span></span><br><span class="line"><span class="comment">//        这里需要使用Vector来保证线程安全，因为多个线程多同一个集合进行操作</span></span><br><span class="line">        List&lt;Integer&gt; sellCount=<span class="keyword">new</span> Vector&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            Thread thread=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                    模拟线程创建延迟</span></span><br><span class="line">                    Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//              多个线程对同一ticketWindow对象操作，产生线程安全问题</span></span><br><span class="line">                <span class="keyword">int</span> sell = ticketWindow.sell(randomAmount());</span><br><span class="line"><span class="comment">//                多个线程对同一集合操作，产生线程安全问题</span></span><br><span class="line">                sellCount.add(sell);</span><br><span class="line">            &#125;);</span><br><span class="line"><span class="comment">//            这里的集合线程安全，因为只是对thread变量的引用进行添加操作，线程没有对threadList集合操作</span></span><br><span class="line">            threadList.add(thread);</span><br><span class="line"><span class="comment">//            启动线程</span></span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        遍历所有线程</span></span><br><span class="line">        threadList.forEach(t-&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                保证所有线程执行完毕</span></span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//        遍历集合进行买票求和操作</span></span><br><span class="line">        <span class="keyword">int</span> sum = sellCount.stream().mapToInt(t -&gt; t).sum();</span><br><span class="line">        log.info(<span class="string">"卖的总票数为:&#123;&#125;"</span>,sum);</span><br><span class="line">        log.info(<span class="string">"剩余总票数为:&#123;&#125;"</span>,ticketWindow.getCount());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//模拟售票窗口</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TicketWindow</span></span>&#123;</span><br><span class="line">    <span class="comment">//余票</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TicketWindow</span><span class="params">(<span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取余票</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *售票方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 售票数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功售票,返回售票数量。售票失败。返回0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">sell</span><span class="params">(<span class="keyword">int</span> amount)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.count &gt;= amount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.count -= amount;</span><br><span class="line">            <span class="keyword">return</span> amount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> <strong>结果</strong>  售票数量和初始余票数量(2000)不一致。线程不安全。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">57</span>:<span class="number">03.578</span> [main] INFO org.lc.synchronized_t.T4 - 卖的总票数为:<span class="number">2048</span></span><br><span class="line"><span class="number">12</span>:<span class="number">57</span>:<span class="number">03.582</span> [main] INFO org.lc.synchronized_t.T4 - 剩余总票数为:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>解决方法：</strong> 给售票方法(临界区)加<strong>synchornized</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     *售票方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 售票数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 成功售票,返回售票数量。售票失败。返回0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">sell</span><span class="params">(<span class="keyword">int</span> amount)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.count &gt;= amount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.count -= amount;</span><br><span class="line">            <span class="keyword">return</span> amount;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="②转账"><a href="#②转账" class="headerlink" title="②转账"></a>②转账</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T5</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//随机转账1到100</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">randomInt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> random.nextInt(<span class="number">100</span>) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line"><span class="comment">//        账户a 1000</span></span><br><span class="line">        Account a = <span class="keyword">new</span> Account(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//        账户b 1000</span></span><br><span class="line">        Account b = <span class="keyword">new</span> Account(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//        线程t1实现a对b的多次随机转账</span></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line"><span class="comment">//                线程不安全</span></span><br><span class="line">                a.transfer(b, randomInt());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"><span class="comment">//        线程2实现b对a的多次随机转账</span></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line"><span class="comment">//                线程不安全</span></span><br><span class="line">                b.transfer(a, randomInt());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        log.info(<span class="string">"账户a:&#123;&#125;"</span>,a.getMoney());</span><br><span class="line">        log.info(<span class="string">"账户b:&#123;&#125;"</span>,b.getMoney());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//账户类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="comment">//    账户余额</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> money;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Account</span><span class="params">(<span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getMoney</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> money;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setMoney</span><span class="params">(<span class="keyword">int</span> money)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.money = money;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 转账操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> target 目标转账用户</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> amount 转账金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.money &gt;= amount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setMoney(<span class="keyword">this</span>.getMoney() - amount);</span><br><span class="line">            target.setMoney(target.getMoney() + amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 结果为：账户完全紊乱。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">42</span>:<span class="number">02.613</span> [main] INFO org.lc.synchronized_t.T5 - 账户a:<span class="number">1607</span></span><br><span class="line"><span class="number">15</span>:<span class="number">42</span>:<span class="number">02.617</span> [main] INFO org.lc.synchronized_t.T5 - 账户b:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>首先我们可以想到给方法加锁:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.money &gt;= amount) &#123;</span><br><span class="line">            <span class="keyword">this</span>.setMoney(<span class="keyword">this</span>.getMoney() - amount);</span><br><span class="line">            target.setMoney(target.getMoney() + amount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>上述方法是给<strong>当前对象加锁</strong>，即当前调用transfer方法的对象加锁，但是传过来的Account对象还是两个线程在共享使用，即会出现问题。</p>
<p><strong>最终解决</strong>：我们给当前类对象加锁，尽管你创建多个账户对象，但是对个线程进行转账的时候，只有一个线程能执行该方法。即类对象只有一个，给类对象加锁，被多个线程使用时互斥。但是这会出现一个缺点，同一个时间只有一个线程能做此事，导致效率非常低。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transfer</span><span class="params">(Account target, <span class="keyword">int</span> amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Account<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.money &gt;= amount) &#123;</span><br><span class="line">                <span class="keyword">this</span>.setMoney(<span class="keyword">this</span>.getMoney() - amount);</span><br><span class="line">                target.setMoney(target.getMoney() + amount);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">10.728</span> [main] INFO org.lc.synchronized_t.T5 - 账户a:<span class="number">1999</span></span><br><span class="line"><span class="number">15</span>:<span class="number">46</span>:<span class="number">10.733</span> [main] INFO org.lc.synchronized_t.T5 - 账户b:<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="9、Monitor概念"><a href="#9、Monitor概念" class="headerlink" title="9、Monitor概念"></a>9、Monitor概念</h3><h5 id="①java对象头"><a href="#①java对象头" class="headerlink" title="①java对象头"></a>①java对象头</h5><blockquote>
<p> 例如：</p>
<ul>
<li><p>Integer对象大小=8字节(Object Header)+储存值的4字节</p>
</li>
<li><p>int 大小=4字节</p>
</li>
</ul>
</blockquote>
<p>以 32 位虚拟机为例</p>
<p><strong>普通对象：</strong></p>
<img src="http://img.louchen.top/2020/05/20200521205415.png" style="zoom:67%;" />

<p>Klass Word 存储的是对象的类型，即类对象的指针</p>
<p>Mark Word 包含的为对象的详细信息，即对象的成员</p>
<img src="http://img.louchen.top/2020/05/20200521161247.png" style="zoom: 67%;" />

<p><strong>Mark Word结构：</strong></p>
<img src="http://img.louchen.top/2020/05/20200521161200.png" style="zoom:67%;" />

<img src="http://img.louchen.top/2020/05/20200521161218.png" style="zoom:67%;" />

<p><img src="http://img.louchen.top/2020/05/20200521211404.png" alt=""></p>
<h3 id="10、wait、notify"><a href="#10、wait、notify" class="headerlink" title="10、wait、notify"></a>10、wait、notify</h3><h4 id="①为什么需要wait"><a href="#①为什么需要wait" class="headerlink" title="①为什么需要wait"></a>①为什么需要wait</h4><img src="http://img.louchen.top/2020/05/20200524105942.png" style="zoom:80%;" />

<h4 id="②wait原理"><a href="#②wait原理" class="headerlink" title="②wait原理"></a>②wait原理</h4><p><img src="http://img.louchen.top/2020/05/20200524105843.png" alt=""></p>
<ul>
<li><p>Owner 线程发现条件(<strong>即该线程已经获得了锁</strong>)不满足，调用 wait 方法，即可进入 WaitSet 变为 WAITING 状态 </p>
</li>
<li><p>BLOCKED 和 WAITING 的线程都处于阻塞状态，<strong>不占用 CPU 时间片</strong></p>
</li>
<li><p>BLOCKED 线程会在 Owner 线程释放锁时唤醒</p>
</li>
</ul>
<h4 id="③API介绍"><a href="#③API介绍" class="headerlink" title="③API介绍"></a>③API介绍</h4><p><strong>调用wait方法，会取消偏量锁撤销，升级为重量锁</strong></p>
<ul>
<li><p>WAITING 线程会在 Owner 线程调用 notify 或 notifyAll 时唤醒，<strong>但唤醒后并不意味者立刻获得锁，仍需进入 EntryList 重新竞争</strong> </p>
</li>
<li><p>obj.wait() 让进入 object 监视器的线程到 waitSet 等待 </p>
</li>
<li><p>obj.notify() 在 object 上正在 waitSet 等待的线程中挑一个唤醒 </p>
</li>
<li><p>obj.notifyAll() 让 object 上正在 waitSet 等待的线程全部唤醒</p>
</li>
</ul>
<p>它们都是线程之间进行协作的手段，都属于 <strong>Object 对象</strong>的方法。<strong>必须获得此对象的锁，才能调用这几个方法</strong></p>
<p>即必须为锁的这个对象才能调用wait/notify。即<strong>synchronized(lock)中的 lock对象调用wait/notify</strong></p>
<blockquote>
<p>注意：没有获得锁的线程执行wait/notify方法会报错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object object=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            object.wait();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"main"</span> java.lang.IllegalMonitorStateException</span><br><span class="line">	at java.lang.Object.wait(Native Method)</span><br><span class="line">	at java.lang.Object.wait(Object.java:<span class="number">502</span>)</span><br><span class="line">	at org.lc.wait_notify.T1.main(T1.java:<span class="number">14</span>)</span><br></pre></td></tr></table></figure>

<p>正确的姿势：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object object=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                object.wait();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h5 id="wait-notify-notifyAll"><a href="#wait-notify-notifyAll" class="headerlink" title="wait(),notify(),notifyAll()"></a>wait(),notify(),notifyAll()</h5><p><strong>实例：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object object=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                log.info(<span class="string">"开始执行..."</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//线程进入waiting阻塞</span></span><br><span class="line">                    object.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"其他代码..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                log.info(<span class="string">"开始执行..."</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//线程进入waiting阻塞</span></span><br><span class="line">                    object.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"其他代码..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">        </span><br><span class="line"><span class="comment">//        先让其他线程执行</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line"><span class="comment">//            唤醒一个线程(唤醒的线程竞争)</span></span><br><span class="line"><span class="comment">//            object.notify();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//            唤醒所有waiting线程</span></span><br><span class="line">            object.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">28</span>:<span class="number">06.797</span> [t1] INFO org.lc.wait_notify.T1 - 开始执行...</span><br><span class="line"><span class="number">11</span>:<span class="number">28</span>:<span class="number">06.799</span> [t2] INFO org.lc.wait_notify.T1 - 开始执行...</span><br><span class="line"><span class="number">11</span>:<span class="number">28</span>:<span class="number">08.795</span> [t2] INFO org.lc.wait_notify.T1 - 其他代码...</span><br><span class="line"><span class="number">11</span>:<span class="number">28</span>:<span class="number">08.795</span> [t1] INFO org.lc.wait_notify.T1 - 其他代码...</span><br></pre></td></tr></table></figure>

<h5 id="wait-long-n"><a href="#wait-long-n" class="headerlink" title="wait(long n)"></a>wait(long n)</h5><p>有时限的等待, 到 n 毫秒后结束等待，重新争抢锁。或是被 notify/notifyAll</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Object object=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (object) &#123;</span><br><span class="line">                log.info(<span class="string">"开始执行..."</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//线程进入waiting阻塞</span></span><br><span class="line">                    object.wait(<span class="number">3000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"其他代码..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"t1"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span>:<span class="number">32</span>:<span class="number">31.444</span> [t1] INFO org.lc.wait_notify.T2 - 开始执行...</span><br><span class="line"><span class="number">11</span>:<span class="number">32</span>:<span class="number">34.447</span> [t1] INFO org.lc.wait_notify.T2 - 其他代码...</span><br></pre></td></tr></table></figure>

<p><strong>3秒后自动被唤醒</strong></p>
<h4 id="④wait-long-n-和sleep-long-n-的区别"><a href="#④wait-long-n-和sleep-long-n-的区别" class="headerlink" title="④wait(long n)和sleep(long n)的区别"></a>④wait(long n)和sleep(long n)的区别</h4><p>1) sleep 是 Thread 方法，而 wait 是 Object 的方法 </p>
<p>2) sleep 不需要强制和 synchronized 配合使用，但 wait 需要 和 synchronized 一起用 </p>
<p>3) <strong>sleep 在睡眠的同时，不会释放对象锁的</strong>，但 <strong>wait 在等待的时候会释放对象锁</strong> </p>
<p>4) 它们 状态都是 <strong>TIMED_WAITING</strong></p>
<h4 id="⑤唤醒占用同一锁的其他指定线程-实例"><a href="#⑤唤醒占用同一锁的其他指定线程-实例" class="headerlink" title="⑤唤醒占用同一锁的其他指定线程-实例"></a>⑤唤醒占用同一锁的其他指定线程-实例</h4><p><strong>注意：</strong>这里不能用sleep，因为sleep不会释放锁，而要用wiat,wait会释放锁</p>
<ul>
<li><p>用 notifyAll 仅解决某个线程的唤醒问题，但使用 if + wait 判断仅有一次机会，一旦条件不成立，就没有重新 判断的机会了</p>
</li>
<li><p>解决方法，用 while + wait，当条件不成立，再次 wait</p>
</li>
</ul>
<p><strong>虚假唤醒：</strong>notify 只能随机唤醒一个 WaitSet 中的线程，这时如果有其它线程也在等待，那么就可能唤醒不了正确的线 程，称之为【虚假唤醒】 解决方法，<strong>改为 notifyAll</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="comment">//    锁</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">static</span> Object room = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="comment">//    是否有烟</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> hasSomke = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//    是否有外卖</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> hasLunch = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.info(<span class="string">"有烟没？&#123;&#125;"</span>,hasSomke);</span><br><span class="line">                <span class="keyword">while</span> (!hasSomke) &#123;</span><br><span class="line">                    log.info(<span class="string">"先休息一下..."</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                        若错误被唤醒，那么会重新判断条件</span></span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"有烟没?&#123;&#125;"</span>,hasSomke);</span><br><span class="line">                <span class="keyword">if</span> (hasSomke) &#123;</span><br><span class="line">                    log.info(<span class="string">"开始干活..."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"烟枪王"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.info(<span class="string">"午饭到没？&#123;&#125;"</span>,hasLunch);</span><br><span class="line">                <span class="keyword">if</span> (!hasLunch) &#123;</span><br><span class="line">                    log.info(<span class="string">"做等饭来..."</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"午饭到没？&#123;&#125;"</span>, hasLunch);</span><br><span class="line">                <span class="keyword">if</span> (hasLunch) &#123;</span><br><span class="line">                    log.info(<span class="string">"开吃..."</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"大胃王"</span>).start();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        先执行其他线程</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line"><span class="comment">//            预先送饭</span></span><br><span class="line">            hasLunch=<span class="keyword">true</span>;</span><br><span class="line">            log.info(<span class="string">"送饭了..."</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//            当我们使用notity()时，这是可能会唤醒送烟线程，导致虚假唤醒</span></span><br><span class="line"><span class="comment">//             notify 只能随机唤醒一个 WaitSet 中的线程</span></span><br><span class="line"><span class="comment">//             room.notify();</span></span><br><span class="line"></span><br><span class="line">            room.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">36</span>:<span class="number">46.600</span> [烟枪王] INFO org.lc.wait_notify.T3 - 有烟没？<span class="keyword">false</span></span><br><span class="line"><span class="number">12</span>:<span class="number">36</span>:<span class="number">46.605</span> [烟枪王] INFO org.lc.wait_notify.T3 - 先休息一下...</span><br><span class="line"><span class="number">12</span>:<span class="number">36</span>:<span class="number">46.605</span> [大胃王] INFO org.lc.wait_notify.T3 - 午饭到没？<span class="keyword">false</span></span><br><span class="line"><span class="number">12</span>:<span class="number">36</span>:<span class="number">46.605</span> [大胃王] INFO org.lc.wait_notify.T3 - 做等饭来...</span><br><span class="line"><span class="number">12</span>:<span class="number">36</span>:<span class="number">48.600</span> [main] INFO org.lc.wait_notify.T3 - 送饭了...</span><br><span class="line"><span class="number">12</span>:<span class="number">36</span>:<span class="number">48.600</span> [大胃王] INFO org.lc.wait_notify.T3 - 午饭到没？<span class="keyword">true</span></span><br><span class="line"><span class="number">12</span>:<span class="number">36</span>:<span class="number">48.600</span> [大胃王] INFO org.lc.wait_notify.T3 - 开吃...</span><br><span class="line"><span class="number">12</span>:<span class="number">36</span>:<span class="number">48.600</span> [烟枪王] INFO org.lc.wait_notify.T3 - 先休息一下...</span><br></pre></td></tr></table></figure>

<h3 id="11、同步模式之保护性暂停"><a href="#11、同步模式之保护性暂停" class="headerlink" title="11、同步模式之保护性暂停"></a>11、同步模式之保护性暂停</h3><h4 id="①-定义"><a href="#①-定义" class="headerlink" title="①.定义"></a>①.定义</h4><p>即 Guarded Suspension，用在一个线程等待另一个线程的执行结果<br>要点</p>
<ul>
<li><p>有一个结果需要从一个线程传递到另一个线程，让他们关联同一个 GuardedObject</p>
</li>
<li><p>如果有结果不断从一个线程到另一个线程那么可以使用消息队列（见生产者/消费者）</p>
</li>
<li><p>JDK 中，join 的实现、Future 的实现，采用的就是此模式 </p>
</li>
<li><p>因为要等待另一方的结果，因此归类到同步模式</p>
</li>
</ul>
<img src="http://img.louchen.top/2020/05/20200524150638.png" style="zoom: 50%;" />

<h4 id="②应用-超时效果"><a href="#②应用-超时效果" class="headerlink" title="②应用- 超时效果"></a>②应用- 超时效果</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//下载返回读取的网页</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Downloader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">download</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        HttpsURLConnection connection= (HttpsURLConnection) <span class="keyword">new</span> URL(<span class="string">"https://www.baidu.com/"</span>).openConnection();</span><br><span class="line">        List&lt;String&gt; list=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span>(BufferedReader reader=<span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(connection.getInputStream(), StandardCharsets.UTF_8))) &#123;</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                list.add(line);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        线程1等待线程2的下载结果</span></span><br><span class="line">        GuardedObject guardedObject=<span class="keyword">new</span> GuardedObject();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line"><span class="comment">//            等待结果</span></span><br><span class="line">            log.info(<span class="string">"等待结果..."</span>);</span><br><span class="line"><span class="comment">//            设置超时时间</span></span><br><span class="line">            List&lt;String&gt; o = (List&lt;String&gt;) guardedObject.get(<span class="number">2000</span>);</span><br><span class="line">            log.info(<span class="string">"下载的内容:&#123;&#125;"</span>, o==<span class="keyword">null</span>?<span class="string">"已超时..."</span>:o.toString());</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"执行下载"</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                下载</span></span><br><span class="line">                List&lt;String&gt; download = Downloader.download();</span><br><span class="line"><span class="comment">//                传入下载的结果</span></span><br><span class="line"><span class="comment">//                这时会唤醒阻塞的线程</span></span><br><span class="line">                guardedObject.complete(download);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GuardedObject</span></span>&#123;</span><br><span class="line"><span class="comment">//    结果</span></span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 超时的时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回的结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line"><span class="comment">//            开始时间</span></span><br><span class="line">            <span class="keyword">long</span> start=System.currentTimeMillis();</span><br><span class="line"><span class="comment">//            经历的时间</span></span><br><span class="line">            <span class="keyword">long</span> passedTime=<span class="number">0</span>;</span><br><span class="line"><span class="comment">//            是否得到结果</span></span><br><span class="line">            <span class="keyword">while</span> (response==<span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//                这一轮循环应该等待的时间</span></span><br><span class="line">                <span class="keyword">long</span> waitTime=timeout-passedTime;</span><br><span class="line"><span class="comment">//                如果经历时间超过 预设的超时时间</span></span><br><span class="line">                <span class="keyword">if</span> (waitTime&lt;=<span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//                    直接退出</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                    防止虚假唤醒</span></span><br><span class="line">                    <span class="keyword">this</span>.wait(waitTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">//                求得经历的时间</span></span><br><span class="line">                passedTime=System.currentTimeMillis()-start;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            不为空 返回此结果</span></span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    产生结果</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">complete</span><span class="params">(Object response)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.response=response;</span><br><span class="line"><span class="comment">//            唤醒等待结果的线程</span></span><br><span class="line">            <span class="keyword">this</span>.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>设置超时时间：2000(2s)</strong></p>
<p><code>guardedObject.get(2000);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">48</span>:<span class="number">00.528</span> [t1] INFO org.lc.wait_notify.T4 - 等待结果...</span><br><span class="line"><span class="number">15</span>:<span class="number">48</span>:<span class="number">00.528</span> [t2] INFO org.lc.wait_notify.T4 - 执行下载</span><br><span class="line"><span class="number">15</span>:<span class="number">48</span>:<span class="number">02.081</span> [t1] INFO org.lc.wait_notify.T4 - 下载的内容:[&lt;!DOCTYPE html&gt;, &lt;!--STATUS OK--&gt;&lt;html&gt; &lt;head&gt;&lt;meta http-equiv=content-type content=text/html;charset=utf-<span class="number">8</span>&gt;&lt;meta http-..</span><br></pre></td></tr></table></figure>

<p><strong>设置超时时间：1000(1s)</strong> </p>
<p><code>guardedObject.get(1000);</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">15</span>:<span class="number">53</span>:<span class="number">50.537</span> [t2] INFO org.lc.wait_notify.T4 - 执行下载</span><br><span class="line"><span class="number">15</span>:<span class="number">53</span>:<span class="number">50.537</span> [t1] INFO org.lc.wait_notify.T4 - 等待结果...</span><br><span class="line"><span class="number">15</span>:<span class="number">53</span>:<span class="number">51.541</span> [t1] INFO org.lc.wait_notify.T4 - 下载的内容:已超时...</span><br></pre></td></tr></table></figure>

<h4 id="③应用-join原理"><a href="#③应用-join原理" class="headerlink" title="③应用 - join原理"></a>③应用 - join原理</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;&#125;);</span><br><span class="line">t1.join(<span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<p><strong>源码如下：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">join</span><span class="params">(<span class="keyword">long</span> millis)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> base = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">long</span> now = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (millis &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"timeout value is negative"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="comment">//如果没有传入过期时间</span></span><br><span class="line">        <span class="keyword">if</span> (millis == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">//轮询  查询该t1线程是否消亡</span></span><br><span class="line">            <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">                <span class="comment">//主线程一直阻塞</span></span><br><span class="line">                wait(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//调用者线程进入t1的waitSet等待，直到t1运行结束</span></span><br><span class="line">            <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">                <span class="keyword">long</span> delay = millis - now;</span><br><span class="line">                <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//休眠指定的实现</span></span><br><span class="line">                wait(delay);</span><br><span class="line">                now = System.currentTimeMillis() - base;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​        join方法的本质调用的是Object中的wait方法实现线程的阻塞，但是我们需要知道的是，调用wait方法必须要获取锁，所以join方法是被synchronized修饰的，synchronized修饰在方法层面相当于<strong>synchronized(this)</strong>,this就是<strong>t1</strong>本身的实例。<br>​        实际上<strong>主线程会持有t1这个对象的锁</strong>（即把当前线程对象当锁），然后调用wait方法去阻塞，而<strong>这个方法的调用者是在主线程中</strong>的。所<strong>以造成主线程阻塞</strong>。</p>
<h4 id="④应用-多任务版-GuardedObject"><a href="#④应用-多任务版-GuardedObject" class="headerlink" title="④应用- 多任务版 GuardedObject"></a>④应用- 多任务版 GuardedObject</h4><h3 id="12、异步模式之生产者-消费者"><a href="#12、异步模式之生产者-消费者" class="headerlink" title="12、异步模式之生产者/消费者"></a>12、异步模式之生产者/消费者</h3><h4 id="①定义"><a href="#①定义" class="headerlink" title="①定义"></a>①定义</h4><p>要点</p>
<ul>
<li>与前面的保护性暂停中的 GuardObject 不同，不需要产生结果和消费结果的线程一一对应 </li>
<li>消费队列可以用来平衡生产和消费的线程资源</li>
<li>生产者仅负责产生结果数据，不关心数据该如何处理，而消费者专心处理结果数据</li>
<li>消息队列是有容量限制的，满时不会再加入数据，空时不会再消耗数据</li>
<li>JDK 中各种阻塞队列，采用的就是这种模式</li>
</ul>
<img src="http://img.louchen.top/2020/05/20200524170608.png" style="zoom: 67%;" />

<h4 id="②实例"><a href="#②实例" class="headerlink" title="②实例"></a>②实例</h4><ul>
<li>定义消息</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义消息</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> Object value;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(<span class="keyword">int</span> id, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Message&#123;"</span> +</span><br><span class="line">                <span class="string">"id="</span> + id +</span><br><span class="line">                <span class="string">", value="</span> + value +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>消息队列</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageQueue</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    消息的队列集合</span></span><br><span class="line">    <span class="comment">//双向队列</span></span><br><span class="line">    <span class="keyword">private</span> LinkedList&lt;Message&gt; list=<span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//队列容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capcity;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MessageQueue</span><span class="params">(<span class="keyword">int</span> capcity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.capcity = capcity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取消息</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">take</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line"><span class="comment">//        判断队列是否为空</span></span><br><span class="line">            <span class="keyword">while</span> (list.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(<span class="string">"队列为空,消费者线程等待..."</span>);</span><br><span class="line"><span class="comment">//                    为空一直等待</span></span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//           从队列的头部取</span></span><br><span class="line">            Message message = list.removeFirst();</span><br><span class="line">            log.info(<span class="string">"已消费消息&#123;&#125;"</span>,message);</span><br><span class="line"><span class="comment">//            唤醒存入消息的线程</span></span><br><span class="line">            list.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存入消息</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line"><span class="comment">//            检查队列是否已满</span></span><br><span class="line">            <span class="keyword">while</span> (list.size() == capcity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(<span class="string">"队列已满,生产者等待..."</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            从队列的尾部加</span></span><br><span class="line">            list.addLast(message);</span><br><span class="line">            log.info(<span class="string">"已生产消息&#123;&#125;"</span>,message);</span><br><span class="line"><span class="comment">//            唤醒取出消息的线程</span></span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T6</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        MessageQueue queue=<span class="keyword">new</span> MessageQueue(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> id=i+<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                queue.put(<span class="keyword">new</span> Message(id,<span class="string">"值:"</span>+id ));</span><br><span class="line">            &#125;,<span class="string">"生产者:"</span>+id).start();</span><br><span class="line">        &#125;</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                queue.take();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"消费者"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">02.285</span> [生产者:<span class="number">1</span>] INFO org.lc.wait_notify.MessageQueue - 已生产消息Message&#123;id=<span class="number">1</span>, value=值:<span class="number">1</span>&#125;</span><br><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">02.290</span> [生产者:<span class="number">3</span>] INFO org.lc.wait_notify.MessageQueue - 已生产消息Message&#123;id=<span class="number">3</span>, value=值:<span class="number">3</span>&#125;</span><br><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">02.290</span> [生产者:<span class="number">2</span>] INFO org.lc.wait_notify.MessageQueue - 队列已满,生产者等待...</span><br><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">04.285</span> [消费者] INFO org.lc.wait_notify.MessageQueue - 已消费消息Message&#123;id=<span class="number">1</span>, value=值:<span class="number">1</span>&#125;</span><br><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">04.285</span> [生产者:<span class="number">2</span>] INFO org.lc.wait_notify.MessageQueue - 已生产消息Message&#123;id=<span class="number">2</span>, value=值:<span class="number">2</span>&#125;</span><br><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">05.286</span> [消费者] INFO org.lc.wait_notify.MessageQueue - 已消费消息Message&#123;id=<span class="number">3</span>, value=值:<span class="number">3</span>&#125;</span><br><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">06.287</span> [消费者] INFO org.lc.wait_notify.MessageQueue - 已消费消息Message&#123;id=<span class="number">2</span>, value=值:<span class="number">2</span>&#125;</span><br><span class="line"><span class="number">20</span>:<span class="number">52</span>:<span class="number">07.287</span> [消费者] INFO org.lc.wait_notify.MessageQueue - 队列为空,消费者线程等待...</span><br></pre></td></tr></table></figure>

<h3 id="13、park和unpark"><a href="#13、park和unpark" class="headerlink" title="13、park和unpark"></a>13、park和unpark</h3><h4 id="①基本使用"><a href="#①基本使用" class="headerlink" title="①基本使用"></a>①基本使用</h4><p>它们是 LockSupport 类中的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 暂停当前线程 </span></span><br><span class="line">LockSupport.park();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 恢复某个线程的运行 </span></span><br><span class="line">LockSupport.unpark(暂停线程对象)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>先 park 后 unpark</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"start..."</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">"park..."</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.info(<span class="string">"resume..."</span>);</span><br><span class="line">        &#125;, <span class="string">"t1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        log.info(<span class="string">"unpark"</span>);</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">09</span>:<span class="number">20.417</span> [t1] INFO org.lc.park_unpark.T1 - start...</span><br><span class="line"><span class="number">21</span>:<span class="number">09</span>:<span class="number">21.421</span> [t1] INFO org.lc.park_unpark.T1 - park...</span><br><span class="line"><span class="number">21</span>:<span class="number">09</span>:<span class="number">22.415</span> [main] INFO org.lc.park_unpark.T1 - unpark</span><br><span class="line"><span class="number">21</span>:<span class="number">09</span>:<span class="number">22.415</span> [t1] INFO org.lc.park_unpark.T1 - resume...</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>先 unpark 后 park 。也能唤醒park进程</strong></li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">"start..."</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">"park..."</span>);</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.info(<span class="string">"resume..."</span>);</span><br><span class="line">        &#125;, <span class="string">"t1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"unpark"</span>);</span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">11</span>:<span class="number">05.473</span> [t1] INFO org.lc.park_unpark.T1 - start...</span><br><span class="line"><span class="number">21</span>:<span class="number">11</span>:<span class="number">06.473</span> [main] INFO org.lc.park_unpark.T1 - unpark</span><br><span class="line"><span class="number">21</span>:<span class="number">11</span>:<span class="number">07.476</span> [t1] INFO org.lc.park_unpark.T1 - park...</span><br><span class="line"><span class="number">21</span>:<span class="number">11</span>:<span class="number">07.476</span> [t1] INFO org.lc.park_unpark.T1 - resume...</span><br></pre></td></tr></table></figure>

<h4 id="②基本原理"><a href="#②基本原理" class="headerlink" title="②基本原理"></a>②基本原理</h4><p>每个线程都有自己的一个 Parker 对象，由三部分组成<code>_counter</code> ， <code>_cond</code>和 <code>_mutex</code>打个比喻 </p>
<ul>
<li><p>线程就像一个旅人，Parker 就像他随身携带的背包，条件变量就好比背包中的帐篷。_counter 就好比背包中 的备用干粮（0 为耗尽，1 为充足） </p>
</li>
<li><p>调用 park 就是要看需不需要停下来歇息 </p>
<ul>
<li>如果备用干粮耗尽，那么钻进帐篷歇息 </li>
<li>如果备用干粮充足，那么不需停留，继续前进</li>
</ul>
</li>
<li><p>调用 unpark，就好比令干粮充足</p>
<ul>
<li>如果这时线程还在帐篷，就唤醒让他继续前进 </li>
<li>如果这时线程还在运行，那么下次他调用 park 时，仅是消耗掉备用干粮，不需停留继续前进 <ul>
<li>因为背包空间有限，多次调用 unpark 仅会补充一份备用干粮</li>
</ul>
</li>
</ul>
</li>
</ul>
<img src="http://img.louchen.top/2020/05/20200526170517.png" style="zoom:67%;" />

<p><img src="http://img.louchen.top/2020/05/20200526170543.png" style="zoom:67%;" /><img src="http://img.louchen.top/2020/05/20200526170609.png" alt=""></p>
<p><img src="http://img.louchen.top/2020/05/20200526170543.png" style="zoom:67%;" /><img src="http://img.louchen.top/2020/05/20200526170609.png" alt=""></p>
<h4 id="③与Object的wait-amp-notify相比"><a href="#③与Object的wait-amp-notify相比" class="headerlink" title="③与Object的wait&amp;notify相比"></a>③与Object的wait&amp;notify相比</h4><ul>
<li>wait，notify 和 notifyAll 必须配合 Object Monitor 一起使用，而 park，unpark 不必</li>
<li>park &amp; unpark 是以线程为单位来【阻塞】和【唤醒】线程，而 notify 只能随机唤醒一个等待线程，notifyAll 是唤醒所有等待线程，就不那么【精确】 </li>
<li>park &amp; unpark 可以先 unpark，而 wait &amp; notify 不能先 notify</li>
</ul>
<h3 id="14、活跃性"><a href="#14、活跃性" class="headerlink" title="14、活跃性"></a>14、活跃性</h3><h4 id="①多把不相干的锁"><a href="#①多把不相干的锁" class="headerlink" title="①多把不相干的锁"></a>①多把不相干的锁</h4><p>将锁的粒度细分</p>
<ul>
<li>好处，是可以增强并发度</li>
<li>坏处，如果一个线程需要同时获得多把锁，就容易发生<strong>死锁</strong> </li>
</ul>
<blockquote>
<p><strong>共用一把锁this：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Room room=<span class="keyword">new</span> Room();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                room.sleep();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                room.study();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"sleep..."</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">study</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"study..."</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">03</span>:<span class="number">29.176</span> [t2] INFO org.lc.deathLock.Room - study...</span><br><span class="line"><span class="number">20</span>:<span class="number">03</span>:<span class="number">31.176</span> [t1] INFO org.lc.deathLock.Room - sleep...</span><br></pre></td></tr></table></figure>

<p>我们发现始终是顺序执行的，即是互斥的。但是两个线程业务并不相干。所有我们可以使用不同的锁。</p>
</blockquote>
<blockquote>
<p><strong>多个锁：</strong></p>
<p>修改Room类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Room</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Object sleepRoom=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> Object studyRoom=<span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sleep</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sleepRoom) &#123;</span><br><span class="line">            log.info(<span class="string">"sleep..."</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">study</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (studyRoom) &#123;</span><br><span class="line">            log.info(<span class="string">"study..."</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">03</span>:<span class="number">29.176</span> [t2] INFO org.lc.deathLock.Room - study...</span><br><span class="line"><span class="number">20</span>:<span class="number">03</span>:<span class="number">29.176</span> [t1] INFO org.lc.deathLock.Room - sleep...</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="②死锁"><a href="#②死锁" class="headerlink" title="②死锁"></a>②死锁</h4><p>一个线程需要同时获取多把锁，这时就容易发生死锁</p>
<ul>
<li><p>t1 线程 获得 o1对象 锁，接下来想获取 o2对象 的锁</p>
</li>
<li><p>t2 线程 获得 o2对象 锁,接下来想获取 o1对象 的锁 </p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Object o1=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">static</span> Object o2=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (o1)&#123;</span><br><span class="line">                log.info(<span class="string">"get lock o1"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (o2)&#123;</span><br><span class="line">                    log.info(<span class="string">"get lock o2"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (o2)&#123;</span><br><span class="line">                log.info(<span class="string">"get lock o2"</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">synchronized</span> (o1)&#123;</span><br><span class="line">                    log.info(<span class="string">"get lock o1"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">08</span>:<span class="number">51.708</span> [t2] INFO org.lc.deathLock.T2 - get lock o2</span><br><span class="line"><span class="number">20</span>:<span class="number">08</span>:<span class="number">51.708</span> [t1] INFO org.lc.deathLock.T2 - get lock o1</span><br><span class="line"><span class="comment">//程序未终止..</span></span><br></pre></td></tr></table></figure>

<h4 id="③活锁"><a href="#③活锁" class="headerlink" title="③活锁"></a>③活锁</h4><p>活锁出现在两个线程互相改变对方的结束条件，后谁也无法结束</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> count=<span class="number">10</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="comment">//期望到0就退出</span></span><br><span class="line">            <span class="keyword">while</span> (count&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"count:&#123;&#125;"</span>, count);</span><br><span class="line">                count--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="comment">//期望到20就退出循环</span></span><br><span class="line">            <span class="keyword">while</span> (count&lt;<span class="number">20</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"count:&#123;&#125;"</span>,count);</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">17</span>:<span class="number">59.724</span> [t1] INFO org.lc.deathLock.T3 - count:<span class="number">11</span></span><br><span class="line"><span class="number">20</span>:<span class="number">17</span>:<span class="number">59.811</span> [t2] INFO org.lc.deathLock.T3 - count:<span class="number">10</span></span><br><span class="line"><span class="number">20</span>:<span class="number">17</span>:<span class="number">59.825</span> [t1] INFO org.lc.deathLock.T3 - count:<span class="number">11</span></span><br><span class="line"><span class="comment">//一值循环的增减</span></span><br></pre></td></tr></table></figure>

<h4 id="④饥饿"><a href="#④饥饿" class="headerlink" title="④饥饿"></a>④饥饿</h4><p>很多教程中把饥饿定义为，一个线程由于优先级太低，始终得不到 CPU 调度执行，也不能够结束，饥饿的情况不 易演示，讲读写锁时会涉及饥饿问题</p>
<p><strong>看使用顺序加锁的方式解决之前的死锁问题</strong></p>
<img src="http://img.louchen.top/2020/05/20200525214057.png" style="zoom:67%;" />

<p><strong>顺序加锁的解决方案</strong></p>
<img src="http://img.louchen.top/2020/05/20200525214258.png" style="zoom: 67%;" />



<h3 id="15、ReentrantLock-可重入锁"><a href="#15、ReentrantLock-可重入锁" class="headerlink" title="15、ReentrantLock(可重入锁)"></a>15、ReentrantLock(可重入锁)</h3><p>相对于 synchronized 它具备如下特点</p>
<ul>
<li><strong>可中断</strong><ul>
<li>在阻塞中没有获得锁的线程可中断阻塞。</li>
</ul>
</li>
<li><strong>可以设置超时时间</strong> <ul>
<li>没有获得锁的线程，最多等待的时间则会放弃获得锁</li>
</ul>
</li>
<li><strong>可以设置为公平锁</strong></li>
<li><strong>支持多个条件变量</strong></li>
</ul>
<p><strong>与 synchronized 一样，都支持可重入</strong> (轻量级锁)</p>
<p>基本语法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">        ReentrantLock reentrantLock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="comment">//        获得锁</span></span><br><span class="line">        reentrantLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//临界区...</span></span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            reentrantLock.unlock();</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="①可重入"><a href="#①可重入" class="headerlink" title="①可重入"></a>①可重入</h4><p>可重入是指同一个线程如果首次获得了这把锁，那么因为它是这把锁的拥有者，因此<strong>有权利再次获取这把锁</strong></p>
<p>如果是不可重入锁，那么第二次获得锁时，自己也会被锁挡住</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        m1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">"m1..."</span>);</span><br><span class="line">            m2();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">         lock.lock();</span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">             log.info(<span class="string">"m2..."</span>);</span><br><span class="line">             m3();</span><br><span class="line">         &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">             lock.unlock();</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">m3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.info(<span class="string">"m3..."</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">00</span>:<span class="number">10.170</span> [main] INFO org.lc.Reentrant_Lock.T2 - m1...</span><br><span class="line"><span class="number">12</span>:<span class="number">00</span>:<span class="number">10.173</span> [main] INFO org.lc.Reentrant_Lock.T2 - m2...</span><br><span class="line"><span class="number">12</span>:<span class="number">00</span>:<span class="number">10.173</span> [main] INFO org.lc.Reentrant_Lock.T2 - m3...</span><br></pre></td></tr></table></figure>

<h4 id="②可打断"><a href="#②可打断" class="headerlink" title="②可打断"></a>②可打断</h4><p>让没有获得锁的线程中在阻塞的线程被打断</p>
<blockquote>
<p><code>lock.lockInterruptibly()</code>  可打断获得锁的模式</p>
</blockquote>
<blockquote>
<p>可中断模式：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//如果没有竞争那么此方法就会获取lock锁</span></span><br><span class="line">                <span class="comment">//如果有竞争就进入阻塞队列，可以被其他线程用interrupt打断</span></span><br><span class="line">                log.info(<span class="string">"尝试获取锁..."</span>);</span><br><span class="line">                lock.lockInterruptibly();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.info(<span class="string">"没有获得到锁...返回"</span>);</span><br><span class="line">                <span class="comment">//这里我们被打断，后面的代码也就无需执行了</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"获取到锁..."</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//主线程先获取到锁</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">//打断t1线程</span></span><br><span class="line">        t1.interrupt();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">23</span>:<span class="number">27.170</span> [t1] INFO org.lc.Reentrant_Lock.T3 - 尝试获取锁...</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">	at ....</span><br><span class="line"><span class="number">12</span>:<span class="number">23</span>:<span class="number">28.168</span> [t1] INFO org.lc.Reentrant_Lock.T3 - 没有获得到锁...返回</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不可中断模式，那么即使使用了 interrupt 也不会让等待中断</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//如果没有竞争那么此方法就会获取lock锁</span></span><br><span class="line">                <span class="comment">//如果有竞争就进入阻塞队列，可以被其他线程用interrupt打断</span></span><br><span class="line">                log.info(<span class="string">"尝试获取锁..."</span>);</span><br><span class="line">                lock.lock();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line">        <span class="comment">//主线程先获取到锁</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"打断..."</span>);</span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">34</span>:<span class="number">20.364</span> [t1] INFO org.lc.Reentrant_Lock.T3 - 尝试获取锁...</span><br><span class="line"><span class="number">12</span>:<span class="number">34</span>:<span class="number">21.361</span> [main] INFO org.lc.Reentrant_Lock.T3 - 打断...</span><br><span class="line"><span class="comment">//阻塞的线程并没有被打断。</span></span><br></pre></td></tr></table></figure>

<h4 id="③锁超时"><a href="#③锁超时" class="headerlink" title="③锁超时"></a>③锁超时</h4><blockquote>
<p><strong>如果没有获得到锁，立刻失败返回</strong></p>
<p><strong><code>tryLock()</code> 获取到锁返回true,否则返回false</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"尝试获取锁..."</span>);</span><br><span class="line">            <span class="keyword">if</span>(!lock.tryLock())&#123;</span><br><span class="line">                <span class="comment">//没有获得锁 返回false</span></span><br><span class="line">                log.info(<span class="string">"没有获得到锁..."</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"获得了锁..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//主线程先获取到锁</span></span><br><span class="line">        lock.lock();</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">43</span>:<span class="number">47.121</span> [t1] INFO org.lc.Reentrant_Lock.T4 - 尝试获取锁...</span><br><span class="line"><span class="number">12</span>:<span class="number">43</span>:<span class="number">47.123</span> [t1] INFO org.lc.Reentrant_Lock.T4 - 没有获得到锁...</span><br></pre></td></tr></table></figure>

<blockquote>
<p>在指定的时间内等待锁，等待的时候可被打断。</p>
<p><code>tryLock(long timeout, TimeUnit unit)</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread t1=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"尝试获取锁..."</span>);</span><br><span class="line">                <span class="comment">//最多等待3秒，没有获得到锁返回false</span></span><br><span class="line">                <span class="keyword">if</span> (!lock.tryLock(<span class="number">3</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                    <span class="comment">//没有获得锁 返回false</span></span><br><span class="line">                    log.info(<span class="string">"没有获得到锁..."</span>);</span><br><span class="line">                    <span class="comment">//直接退出</span></span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                log.info(<span class="string">"被打断...没有获得到锁"</span>);</span><br><span class="line"><span class="comment">//                打断后也应该返回</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"获得了锁..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//主线程先获取到锁</span></span><br><span class="line">        lock.lock();</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="comment">//主线程获得锁1s后打断在阻塞等待的t1线程</span></span><br><span class="line">        t1.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">12</span>:<span class="number">53</span>:<span class="number">08.668</span> [t1] INFO org.lc.Reentrant_Lock.T4 - 尝试获取锁...</span><br><span class="line">java.lang.InterruptedException</span><br><span class="line">	at ....</span><br><span class="line"><span class="number">12</span>:<span class="number">53</span>:<span class="number">09.666</span> [t1] INFO org.lc.Reentrant_Lock.T4 - 被打断...没有获得到锁</span><br></pre></td></tr></table></figure>

<h4 id="④公平锁"><a href="#④公平锁" class="headerlink" title="④公平锁"></a>④公平锁</h4><p>即在WaitSet中阻塞的线程争抢锁的时候是非公平的，即随机争抢。</p>
<p>而公平锁，阻塞线程在争抢锁的时候是按照阻塞队列的顺序来的。</p>
<p><strong>ReentrantLock默认是不公平的</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//设置公平锁</span></span><br><span class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<p>公平锁一般没有必要，会降低并发度。</p>
<h4 id="⑤条件变量"><a href="#⑤条件变量" class="headerlink" title="⑤条件变量"></a>⑤条件变量</h4><p>​        synchronized 中也有条件变量，就是我们讲原理时那个 waitSet 休息室，当条件不满足时进入 waitSet 等待 </p>
<p>ReentrantLock 的条件变量比 synchronized 强大之处在于，它是支持多个条件变量的，这就好比 </p>
<ul>
<li>synchronized 是那些不满足条件的线程<strong>都在一间休息室</strong>等消息 </li>
<li>而 ReentrantLock <strong>支持多间休息室</strong>，有专门等烟的休息室、专门等早餐的休息室、唤醒时也是按休息室来唤 醒，即阻塞队列的存放位置可以分组，</li>
</ul>
<p>使用要点(和synchronized类似，<strong>只是阻塞队列做了区分，然后需要手动释放锁</strong>)</p>
<ul>
<li>await 前需要获得锁 </li>
<li>await 执行后，会释放锁，进入 conditionObject 等待</li>
<li>await 的线程被唤醒(signal)（或打断、或超时）取重新竞争 lock 锁 </li>
<li>竞争 lock 锁成功后，从 await 后继续执行 </li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T6</span> </span>&#123;</span><br><span class="line"><span class="comment">//    是否有烟</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> hasSmoke=<span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//    是否有饭</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> hasLunch=<span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//    可重入锁</span></span><br><span class="line">    <span class="keyword">static</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line"><span class="comment">//    抽烟的队列</span></span><br><span class="line">    <span class="keyword">static</span> Condition somekRoom=lock.newCondition();</span><br><span class="line"><span class="comment">//    吃饭的队列</span></span><br><span class="line">    <span class="keyword">static</span> Condition lunchRoom=lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line"><span class="comment">//            尝试获得锁</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"有烟没？&#123;&#125;"</span>,hasSmoke);</span><br><span class="line">                <span class="keyword">while</span> (!hasSmoke) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        log.info(<span class="string">"烟没到，休息下..."</span>);</span><br><span class="line">                        <span class="comment">//没烟。等烟</span></span><br><span class="line">                        somekRoom.await();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="comment">//可打断</span></span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//有烟</span></span><br><span class="line">                log.info(<span class="string">"有烟，开始干活！"</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//                释放锁</span></span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"烟杆子"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line"><span class="comment">//            尝试获得锁</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.info(<span class="string">"有饭没？&#123;&#125;"</span>,hasLunch);</span><br><span class="line">                <span class="keyword">while</span> (!hasLunch) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        log.info(<span class="string">"没饭，睡一会..."</span>);</span><br><span class="line">                        lunchRoom.await();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line"><span class="comment">//                        可被打断</span></span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"饭来了，恰饭!"</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">//                释放锁</span></span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"饭桶"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line"><span class="comment">//            获取锁</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                送烟</span></span><br><span class="line">                hasSmoke=<span class="keyword">true</span>;</span><br><span class="line"><span class="comment">//                唤醒阻塞的烟杆子</span></span><br><span class="line"><span class="comment">//                这里signal()只会唤醒somkeRoom中的一个</span></span><br><span class="line">                somekRoom.signal();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">              lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"工具人1"</span>).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line"><span class="comment">//            获得锁</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                送饭</span></span><br><span class="line">                hasLunch=<span class="keyword">true</span>;</span><br><span class="line"><span class="comment">//                关系lunchRoom中等待的队列</span></span><br><span class="line">                lunchRoom.signal();</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"工具人2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">44.550</span> [烟杆子] INFO org.lc.Reentrant_Lock.T6 - 有烟没？<span class="keyword">false</span></span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">44.554</span> [烟杆子] INFO org.lc.Reentrant_Lock.T6 - 烟没到，休息下...</span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">44.554</span> [饭桶] INFO org.lc.Reentrant_Lock.T6 - 有饭没？<span class="keyword">false</span></span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">44.554</span> [饭桶] INFO org.lc.Reentrant_Lock.T6 - 没饭，睡一会...</span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">44.554</span> [烟杆子] INFO org.lc.Reentrant_Lock.T6 - 有烟，开始干活！</span><br><span class="line"><span class="number">16</span>:<span class="number">27</span>:<span class="number">46.548</span> [饭桶] INFO org.lc.Reentrant_Lock.T6 - 饭来了，恰饭!</span><br></pre></td></tr></table></figure>

<h3 id="16、设计模式-同步模式之顺序控制"><a href="#16、设计模式-同步模式之顺序控制" class="headerlink" title="16、设计模式-同步模式之顺序控制"></a>16、设计模式-同步模式之顺序控制</h3><h4 id="①固定运行顺序"><a href="#①固定运行顺序" class="headerlink" title="①固定运行顺序"></a>①固定运行顺序</h4><h5 id="题目：必须先打印2后打印1"><a href="#题目：必须先打印2后打印1" class="headerlink" title="题目：必须先打印2后打印1"></a>题目：必须先打印2后打印1</h5><h6 id="1、使用wait-notify"><a href="#1、使用wait-notify" class="headerlink" title="1、使用wait/notify"></a>1、使用wait/notify</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Object lock=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> isRun=<span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">while</span> (!isRun) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"RunWith 1..."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"t1"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t2=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                log.info(<span class="string">"RunWith 2..."</span>);</span><br><span class="line">                <span class="keyword">if</span>(!isRun)&#123;</span><br><span class="line">                    isRun=<span class="keyword">true</span>;</span><br><span class="line">                    lock.notify();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t2"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">48</span>:<span class="number">20.774</span> [t2] INFO org.lc.desiger_.T1 - RunWith <span class="number">2</span>...</span><br><span class="line"><span class="number">16</span>:<span class="number">48</span>:<span class="number">20.776</span> [t1] INFO org.lc.desiger_.T1 - RunWith <span class="number">1</span>...</span><br></pre></td></tr></table></figure>

<h6 id="2、使用ReentrantLock"><a href="#2、使用ReentrantLock" class="headerlink" title="2、使用ReentrantLock"></a>2、使用ReentrantLock</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="keyword">static</span> Condition waitSet=lock.newCondition();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> isRun=<span class="keyword">false</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (!isRun)&#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        waitSet.await();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"runwith 1"</span>);</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!isRun) &#123;</span><br><span class="line">                    isRun=<span class="keyword">true</span>;</span><br><span class="line">                    log.info(<span class="string">"runwith 2"</span>);</span><br><span class="line">                    waitSet.signal();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">59</span>:<span class="number">17.669</span> [t1] INFO org.lc.desiger_.T2 - runwith <span class="number">2</span></span><br><span class="line"><span class="number">16</span>:<span class="number">59</span>:<span class="number">17.671</span> [t1] INFO org.lc.desiger_.T2 - runwith <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h6 id="3、使用park和unpark"><a href="#3、使用park和unpark" class="headerlink" title="3、使用park和unpark"></a>3、使用park和unpark</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Thread t1= <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            LockSupport.park();</span><br><span class="line">            log.info(<span class="string">"runwith 1"</span>);</span><br><span class="line">        &#125;, <span class="string">"t1"</span>);</span><br><span class="line">        t1.start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"runwith 2"</span>);</span><br><span class="line">            LockSupport.unpark(t1);</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="②交替输出"><a href="#②交替输出" class="headerlink" title="②交替输出"></a>②交替输出</h4><h5 id="题目：线程-1-输出-a-5-次，线程-2-输出-b-5-次，线程-3-输出-c-5-次。"><a href="#题目：线程-1-输出-a-5-次，线程-2-输出-b-5-次，线程-3-输出-c-5-次。" class="headerlink" title="题目：线程 1 输出 a 5 次，线程 2 输出 b 5 次，线程 3 输出 c 5 次。"></a>题目：线程 1 输出 a 5 次，线程 2 输出 b 5 次，线程 3 输出 c 5 次。</h5><p>现在要求输出 abcabcabcabcabc 怎么实现 </p>
<h6 id="1、使用wait-notify-1"><a href="#1、使用wait-notify-1" class="headerlink" title="1、使用wait/notify"></a>1、使用wait/notify</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//          下一定义标记为1   即先打印a</span></span><br><span class="line">        PrintABC printABC = <span class="keyword">new</span> PrintABC(<span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            printABC.print(<span class="string">"a"</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            printABC.print(<span class="string">"b"</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            printABC.print(<span class="string">"c"</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">        &#125;,<span class="string">"t3"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**依次打印abc五次</span></span><br><span class="line"><span class="comment"> *     当前打印标记   下一打印标记</span></span><br><span class="line"><span class="comment"> * a       1            2</span></span><br><span class="line"><span class="comment"> * b       2            3</span></span><br><span class="line"><span class="comment"> * c       3            1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrintABC</span></span>&#123;</span><br><span class="line"><span class="comment">//    当前打印标记</span></span><br><span class="line">    <span class="keyword">int</span> flag;</span><br><span class="line"><span class="comment">//    下一打印标记</span></span><br><span class="line">    <span class="keyword">int</span> nextFlag;</span><br><span class="line"><span class="comment">//    循环次数</span></span><br><span class="line">    <span class="keyword">int</span> loopNumber;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PrintABC</span><span class="params">(<span class="keyword">int</span> nextFlag, <span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextFlag = nextFlag;</span><br><span class="line">        <span class="keyword">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String word, <span class="keyword">int</span> flag, <span class="keyword">int</span> nextFlag)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line"><span class="comment">//                如果当前传过来的标记和下一打印标记不一致</span></span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">this</span>.nextFlag!=flag) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                        等待</span></span><br><span class="line">                        <span class="keyword">this</span>.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.print(word);</span><br><span class="line">                <span class="keyword">this</span>.nextFlag=nextFlag;</span><br><span class="line"><span class="comment">//                唤醒所有进程</span></span><br><span class="line">                <span class="keyword">this</span>.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abcabcabcabcabc</span><br></pre></td></tr></table></figure>

<h6 id="2、使用ReentrantLock-1"><a href="#2、使用ReentrantLock-1" class="headerlink" title="2、使用ReentrantLock"></a>2、使用ReentrantLock</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T5</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ReentrantPrint reentrantPrint = <span class="keyword">new</span> ReentrantPrint(<span class="number">5</span>);</span><br><span class="line">        Condition a = reentrantPrint.newCondition();</span><br><span class="line">        Condition b = reentrantPrint.newCondition();</span><br><span class="line">        Condition c = reentrantPrint.newCondition();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            reentrantPrint.print(<span class="string">"a"</span>, a, b);</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            reentrantPrint.print(<span class="string">"b"</span>, b, c);</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            reentrantPrint.print(<span class="string">"c"</span>, c, a);</span><br><span class="line">        &#125;,<span class="string">"t3"</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//先让上述线程都进入各自的阻塞队列</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        主线程启动 先唤醒t1打印a</span></span><br><span class="line">        reentrantPrint.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            唤醒a队列</span></span><br><span class="line">            a.signal();</span><br><span class="line">            System.out.println(<span class="string">"start..."</span>);</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">//释放锁</span></span><br><span class="line">            reentrantPrint.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReentrantPrint</span> <span class="keyword">extends</span> <span class="title">ReentrantLock</span> </span>&#123;</span><br><span class="line"><span class="comment">//    循环次数</span></span><br><span class="line">    <span class="keyword">int</span> loopNumber;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ReentrantPrint</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 打印的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> word 打印的内容</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cond 当前线程睡眠的队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nextCond 下一个唤醒的队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String word,Condition cond,Condition nextCond)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line"><span class="comment">//        尝试获得锁</span></span><br><span class="line">            lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//a等待的队列</span></span><br><span class="line">                    cond.await();</span><br><span class="line"><span class="comment">//                    打印单词</span></span><br><span class="line">                    System.out.print(word);</span><br><span class="line"><span class="comment">//                    下一个唤醒的队列</span></span><br><span class="line">                    nextCond.signal();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start...</span><br><span class="line">abcabcabcabcabc</span><br></pre></td></tr></table></figure>

<h6 id="3、park和unpark"><a href="#3、park和unpark" class="headerlink" title="3、park和unpark"></a>3、park和unpark</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T6</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> Thread t1;</span><br><span class="line">    <span class="keyword">static</span> Thread t2;</span><br><span class="line">    <span class="keyword">static</span> Thread t3;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        ParkPrint parkPrint = <span class="keyword">new</span> ParkPrint(<span class="number">5</span>);</span><br><span class="line">        t1 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            parkPrint.print(<span class="string">"a"</span>, t2);</span><br><span class="line">        &#125;, <span class="string">"t1"</span>);</span><br><span class="line">        t2 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            parkPrint.print(<span class="string">"b"</span>, t3);</span><br><span class="line">        &#125;, <span class="string">"t2"</span>);</span><br><span class="line">        t3 = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            parkPrint.print(<span class="string">"c"</span>, t1);</span><br><span class="line">        &#125;, <span class="string">"t3"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line"><span class="comment">//      保证上述线程启动完毕</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"><span class="comment">//        先唤醒t1线程 打印a</span></span><br><span class="line">        LockSupport.unpark(t1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParkPrint</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> loopNumber;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ParkPrint</span><span class="params">(<span class="keyword">int</span> loopNumber)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">(String word,Thread nextThread)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line"><span class="comment">//          先阻塞</span></span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.print(word);</span><br><span class="line">            LockSupport.unpark(nextThread);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abcabcabcabcabc</span><br></pre></td></tr></table></figure>

<h3 id="17、本章小结"><a href="#17、本章小结" class="headerlink" title="17、本章小结"></a>17、本章小结</h3><img src="http://img.louchen.top/2020/05/20200526212626.png" style="zoom: 80%;" />

<h2 id="Ⅳ、共享模型之内存"><a href="#Ⅳ、共享模型之内存" class="headerlink" title="Ⅳ、共享模型之内存"></a>Ⅳ、共享模型之内存</h2><h3 id="1、java内存模型"><a href="#1、java内存模型" class="headerlink" title="1、java内存模型"></a>1、java内存模型</h3><p><strong>JMM: java memory model</strong>  它定义了<strong>主存(线程共享的数据、静态成员变量，成员变量)</strong>、<strong>工作内存(局部变量</strong>)抽象概念，底层对应着 CPU 寄存器、缓存、硬件内存、 CPU 指令优化等。 </p>
<p>JMM 体现在以下几个方面</p>
<ul>
<li>原子性 - 保证指令不会受到线程上下文切换的影响 </li>
<li>可见性 - 保证指令不会受 cpu 缓存的影响 </li>
<li>有序性 - 保证指令不会受 cpu 指令并行优化的影响</li>
</ul>
<h3 id="2、可见性"><a href="#2、可见性" class="headerlink" title="2、可见性"></a>2、可见性</h3><h4 id="①退不出的循环"><a href="#①退不出的循环" class="headerlink" title="①退不出的循环"></a>①退不出的循环</h4><p>先来看一个现象，按道理来说，主线程经过1秒后修改flag变量，线程t1终止，但是main 线程对 flag变量的修改对于 t1 <strong>线程不可见</strong>，导致了 t 1线程无法停止：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (flag) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">		</span><br><span class="line">        flag=<span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>原因：</strong></p>
<ul>
<li><p>初始状态t1线程开始从主存flag的值到工作内存中</p>
</li>
<li><img src="http://img.louchen.top/2020/05/20200527172826.png" style="zoom:50%;" />
</li>
<li><p>因为<strong>t1线程要频繁的从主存中读取flag的值</strong>，JIT(just-in-time compilation)即时编译器会将flag的值缓存到自己的工作内存中的高速缓存中，减少对主存中flag的访问，以提高效率</p>
</li>
<li><img src="http://img.louchen.top/2020/05/20200527173229.png" style="zoom:50%;" />

</li>
</ul>
<p>1 秒之后，main 线程修改了 flag的值，并同步至主存，而 t1线程 是从自己工作内存中的高速缓存中读取这个变量 的值，结果永远是旧值</p>
<img src="http://img.louchen.top/2020/05/20200527174944.png" style="zoom:50%;" />

<p><strong>解决方法：</strong></p>
<blockquote>
<p>使用volatile关键字</p>
</blockquote>
<p>加上<strong>volatile(易变的)</strong>关键字，<strong>只能修饰成员变量，不能修饰局部变量</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">static</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用加synchronized锁的方式</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">boolean</span> flag = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">static</span> Object lock=<span class="keyword">new</span> Object();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!flag) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"退出..."</span>);</span><br><span class="line">        flag=<span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、原子性和可见性"><a href="#3、原子性和可见性" class="headerlink" title="3、原子性和可见性"></a>3、原子性和可见性</h3><p>前面例子体现的实际就是可见性，它保证的是在多个线程之间，一个线程对 volatile 变量的修改对另一个线程可 见， 不能保证原子性，仅用在一个写线程，多个读线程的情况： 上例从字节码理解是这样的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getstatic     run   <span class="comment">// 线程 t 获取 run true </span></span><br><span class="line">   getstatic     run   <span class="comment">// 线程 t 获取 run true </span></span><br><span class="line">   getstatic     run   <span class="comment">// 线程 t 获取 run true </span></span><br><span class="line">   getstatic     run   <span class="comment">// 线程 t 获取 run true </span></span><br><span class="line">   putstatic     run  <span class="comment">//  线程 main 修改 run 为 false， 仅此一次 </span></span><br><span class="line">   getstatic     run   <span class="comment">// 线程 t 获取 run false</span></span><br></pre></td></tr></table></figure>

<p>比较一下之前我们将线程安全时举的例子：两个线程一个 i++ 一个 i– ，只能保证看到新值，不能解决指令交错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设i的初始值为0 </span></span><br><span class="line">getstatic     i  <span class="comment">// 线程2-获取静态变量i的值 线程内i=0 </span></span><br><span class="line"> </span><br><span class="line">getstatic     i  <span class="comment">// 线程1-获取静态变量i的值 线程内i=0 </span></span><br><span class="line">iconst_1         <span class="comment">// 线程1-准备常量1 </span></span><br><span class="line">iadd             <span class="comment">// 线程1-自增 线程内i=1 </span></span><br><span class="line">putstatic     i  <span class="comment">// 线程1-将修改后的值存入静态变量i 静态变量i=1 </span></span><br><span class="line"> </span><br><span class="line">iconst_1         <span class="comment">// 线程2-准备常量1 </span></span><br><span class="line">isub             <span class="comment">// 线程2-自减 线程内i=-1 </span></span><br><span class="line">putstatic     i  <span class="comment">// 线程2-将修改后的值存入静态变量i 静态变量i=-1</span></span><br></pre></td></tr></table></figure>

<h5 id="①synchronized和volatile区别："><a href="#①synchronized和volatile区别：" class="headerlink" title="①synchronized和volatile区别："></a><strong>①synchronized和volatile区别：</strong></h5><ul>
<li><strong>synchronized</strong>语句块既可以保证代码块的<strong>原子性</strong>，也同时保证代码块内变量的<strong>可见性</strong>，也可以保证<strong>有序性</strong>(但是需要将修改的变量全部交由<strong>synchronized</strong>管理)。但缺点是synchronize属于重量级的操作，性能相对较低。</li>
<li>volatile<strong>并不能保证原子性</strong>，但是能够保证<strong>其有序性和可见性</strong>。他适用于一个线程读，另一个线程写的情况</li>
</ul>
<h3 id="4、终止模式之两阶段终止模式-volatile"><a href="#4、终止模式之两阶段终止模式-volatile" class="headerlink" title="4、终止模式之两阶段终止模式(volatile)"></a>4、终止模式之两阶段终止模式(volatile)</h3><p>我们之前使用<code>isInterrupted</code>来实现，现在我们使用<code>volatile</code>实现监视器功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        LogMonitor logMonitor=<span class="keyword">new</span> LogMonitor();</span><br><span class="line">        logMonitor.start();</span><br><span class="line">        <span class="comment">//5秒后停止监控</span></span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        logMonitor.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogMonitor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Thread thread;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag=<span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">        thread=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                    log.info(<span class="string">"停止监控..."</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    log.info(<span class="string">"监控记录中..."</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"监视器"</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        flag=<span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//打断线程  避免在睡眠后又一次记录</span></span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">50</span>:<span class="number">16.992</span> [监视器] INFO org.lc.volatile_.LogMonitor - 监控记录中...</span><br><span class="line"><span class="number">19</span>:<span class="number">50</span>:<span class="number">17.996</span> [监视器] INFO org.lc.volatile_.LogMonitor - 监控记录中...</span><br><span class="line"><span class="number">19</span>:<span class="number">50</span>:<span class="number">18.997</span> [监视器] INFO org.lc.volatile_.LogMonitor - 监控记录中...</span><br><span class="line"><span class="number">19</span>:<span class="number">50</span>:<span class="number">19.998</span> [监视器] INFO org.lc.volatile_.LogMonitor - 监控记录中...</span><br><span class="line"><span class="number">19</span>:<span class="number">50</span>:<span class="number">20.991</span> [监视器] INFO org.lc.volatile_.LogMonitor - 停止监控...</span><br></pre></td></tr></table></figure>

<h3 id="5、同步模式之Balking-犹豫模式"><a href="#5、同步模式之Balking-犹豫模式" class="headerlink" title="5、同步模式之Balking(犹豫模式)"></a>5、同步模式之Balking(犹豫模式)</h3><h4 id="①定义："><a href="#①定义：" class="headerlink" title="①定义："></a>①定义：</h4><p>Balking （犹豫）模式用在一个线程发现另一个线程或本线程已经做了某一件相同的事，那么本线程就无需再做 了，直接结束返回 </p>
<h4 id="②监控日志-案例"><a href="#②监控日志-案例" class="headerlink" title="②监控日志-案例"></a>②监控日志-案例</h4><p>防止创建多个启动实例  <strong>synchronized+volatile</strong></p>
<p><strong>synchronzed</strong>保证原子性，<strong>volatile</strong>保证可见性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        LogMonitor logMonitor=<span class="keyword">new</span> LogMonitor();</span><br><span class="line"><span class="comment">//       这里启动多个实例 还是按照每秒执行一次来监控</span></span><br><span class="line">        logMonitor.start();</span><br><span class="line">        logMonitor.start();</span><br><span class="line">        logMonitor.start();</span><br><span class="line">        <span class="comment">//5秒后停止监控</span></span><br><span class="line"><span class="comment">//        Thread.sleep(5000);</span></span><br><span class="line"><span class="comment">//        logMonitor.stop();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogMonitor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Thread thread;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> flag=<span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//    判断是否已经启动了该监视器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isStaring=<span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//多个线程来访问修改isStrating,会产生线程安全问题 需要使用synchronize来保证原子性</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isStaring) &#123;</span><br><span class="line"><span class="comment">//            已经启动了 直接返回</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        isStaring=<span class="keyword">true</span>;</span><br><span class="line">        thread=<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                    log.info(<span class="string">"停止监控..."</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    log.info(<span class="string">"监控记录中..."</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">"监视器"</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        flag=<span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">//打断线程  避免在睡眠后又一次记录</span></span><br><span class="line">        thread.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">20</span>:<span class="number">09</span>:<span class="number">15.560</span> [监视器] INFO org.lc.volatile_.LogMonitor - 监控记录中...</span><br><span class="line"><span class="number">20</span>:<span class="number">09</span>:<span class="number">16.566</span> [监视器] INFO org.lc.volatile_.LogMonitor - 监控记录中...</span><br><span class="line"><span class="number">20</span>:<span class="number">09</span>:<span class="number">17.566</span> [监视器] INFO org.lc.volatile_.LogMonitor - 监控记录中...</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="③线程安全的单例模式"><a href="#③线程安全的单例模式" class="headerlink" title="③线程安全的单例模式"></a>③线程安全的单例模式</h4><p>效率太低，详细请看7下的第④个。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeSingleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SafeSingleton safeSingleton=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SafeSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> SafeSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (safeSingleton != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> safeSingleton;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> safeSingleton=<span class="keyword">new</span> SafeSingleton();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6、有序性"><a href="#6、有序性" class="headerlink" title="6、有序性"></a>6、有序性</h3><p>JVM 会在不影响正确性的前提下，可以调整语句的执行顺序，思考下面一段代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> i; </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> j;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 在某个线程内执行如下赋值操作 i = ...; j = ...;</span></span><br></pre></td></tr></table></figure>

<p>可以看到，至于是先执行 i 还是 先执行 j ，对终的结果不会产生影响。所以，上面代码真正执行时，既可以是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">i = ...; </span><br><span class="line">j = ...;</span><br></pre></td></tr></table></figure>

<p>也可以是</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">j = ...; </span><br><span class="line">i = ...;</span><br></pre></td></tr></table></figure>

<p>这种特性称之为『指令重排』，多线程下『指令重排』会影响正确性。</p>
<p>使用：<strong>volatile 修饰的变量，可以防止指令重排</strong></p>
<p>即被volatile修饰的变量在修改之前的代码都是有序的(<strong>只是在本线程有效</strong>)，不可被jvm进行优化，重新排列运行</p>
<h3 id="7、volatile原理"><a href="#7、volatile原理" class="headerlink" title="7、volatile原理"></a>7、volatile原理</h3><h4 id="①读屏障和写屏障的可见性和有序性"><a href="#①读屏障和写屏障的可见性和有序性" class="headerlink" title="①读屏障和写屏障的可见性和有序性"></a>①读屏障和写屏障的可见性和有序性</h4><ul>
<li>可见性 <ul>
<li>写屏障（sfence）保证在该屏障之前的，对共享变量的改动，都同步到主存当中</li>
<li>而读屏障（lfence）保证在该屏障之后，对共享变量的读取，加载的是主存中新数据 </li>
</ul>
</li>
<li>有序性 <ul>
<li>写屏障会确保指令重排序时，不会将写屏障之前的代码排在写屏障之后 </li>
<li>读屏障会确保指令重排序时，不会将读屏障之后的代码排在读屏障之前</li>
</ul>
</li>
</ul>
<p>volatile 的底层实现原理<strong>是内存屏障，</strong>Memory Barrier（Memory Fence）</p>
<ul>
<li>对 volatile 变量的写指令后会加入写屏障 </li>
<li>对 volatile 变量的写指令后会加入写屏障 </li>
</ul>
<h4 id="②如何保证可见性"><a href="#②如何保证可见性" class="headerlink" title="②如何保证可见性"></a>②如何保证可见性</h4><ul>
<li><p>写屏障（sfence）保证在该<strong>屏障之前的，对共享变量的改动，都同步到主存当中</strong></p>
</li>
<li><pre><code class="java"><span class="keyword">private</span> <span class="keyword">volatile</span> boolena ready=<span class="keyword">false</span>;
<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actor2</span><span class="params">(I_Result r)</span> </span>{
    num = <span class="number">2</span>;  <span class="comment">//写到主存中  </span>
    ready = <span class="keyword">true</span>; <span class="comment">// ready 是 volatile 赋值带写屏障    </span>
    <span class="comment">// 写屏障 </span>
}
&lt;!--￼<span class="number">151</span>--&gt;

&lt;img src=<span class="string">"http://img.louchen.top/2020/05/20200528102536.png"</span> style=<span class="string">"zoom: 67%;"</span> /&gt;
</code></pre>
</li>
</ul>
<h4 id="③如何保证有序性"><a href="#③如何保证有序性" class="headerlink" title="③如何保证有序性"></a>③如何保证有序性</h4><ul>
<li><p>写屏障会确保指令重排序时，<strong>不会将写屏障之前的代码排在写屏障之后</strong></p>
</li>
<li><pre><code class="java"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actor2</span><span class="params">(I_Result r)</span> </span>{
    num = <span class="number">2</span>;    
    ready = <span class="keyword">true</span>; <span class="comment">// ready 是 volatile 赋值带写屏障    </span>
    <span class="comment">// 写屏障 </span>
}
&lt;!--￼<span class="number">152</span>--&gt;

&lt;img src=<span class="string">"C:\Users\42119\AppData\Roaming\Typora\typora-user-images\1590632954308.png"</span> alt=<span class="string">"1590632954308"</span> style=<span class="string">"zoom:67%;"</span> /&gt;
</code></pre>
</li>
</ul>
<p><strong>总结：</strong> 被volatile修饰的成员变量，只能在本线程保证有序性和可见性，不能解决指令交错。</p>
<ul>
<li>写屏障：保证被volatile的修饰的成员变量在改变之前的代码都是写到主存中。保证在修改该变量之前的代码不会排在该变量之后。</li>
<li>读屏障：保证被volatile的修饰的成员变量在读取之后的代码都是从主存中读。保证在读该变量之后的代码不会排在该变量之前。</li>
</ul>
<h4 id="④单例模式的-double-checked-locking-双重检查"><a href="#④单例模式的-double-checked-locking-双重检查" class="headerlink" title="④单例模式的 double-checked locking (双重检查)"></a>④单例模式的 double-checked locking (双重检查)</h4><p><strong>之前创建的单例的方式</strong>： 这种方式效率非常低。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeSingleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SafeSingleton safeSingleton=<span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SafeSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SafeSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SafeSingleton<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (safeSingleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> safeSingleton==<span class="keyword">new</span> SafeSingleton();;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> safeSingleton</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>改进：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeSingleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SafeSingleton safeSingleton=<span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SafeSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SafeSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//多个线程访问 如果实例不为空则直接返回，后面的线程无需再竞争锁</span></span><br><span class="line">        <span class="keyword">if</span>(safeSingleton==<span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//            第一个进来的线程 获得到锁创建  </span></span><br><span class="line">            <span class="keyword">synchronized</span> (SafeSingleton<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (safeSingleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> safeSingleton=<span class="keyword">new</span> SafeSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> safeSingleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上的实现特点是：</p>
<ul>
<li>懒惰实例化 </li>
<li>首次使用 getInstance() 才使用 synchronized 加锁，后续使用时无需加锁 </li>
<li>有隐含的，但很关键的一点：<strong>第一个 if 使用了 INSTANCE 变量，是在同步块之外</strong></li>
</ul>
<p>但在多线程环境下，上面的代码是有问题的，getInstance 方法对应的字节码为：</p>
<img src="http://img.louchen.top/2020/05/20200528122410.png" style="zoom: 80%;" />

<p>其中</p>
<ul>
<li>17 表示创建对象，将对象引用入栈  // new Singleton</li>
<li>20 表示复制一份对象引用  // 引用地址 </li>
<li>21 表示利用一个对象引用，调用构造方法 </li>
<li>24 表示利用一个对象引用，赋值给 static INSTANCE </li>
</ul>
<p>也许 jvm 会优化为：先执行 24，再执行 21。如果两个线程 t1，t2 按如下时间序列执行：</p>
<img src="http://img.louchen.top/2020/05/20200528122711.png" style="zoom:67%;" />

<p>通俗一点就是，线程<code>t2</code>执行第一个<code>if(safeSingleton==null)</code>时,线程<code>t1</code>已经执行到第二个<code>if(safeSingleton==null)</code>中的<code>safeSingleton=new SafeSingleton();</code>，但是由于jvm指令重排的关系，可能会先执行对<code>safeSingleton</code>的引用赋值情况，但是<code>new SafeSingleton()</code>还未执行完毕。所以线程<code>t2</code>拿到返回的实例为未被初始化完毕的实例。</p>
<p><strong>注意：</strong>对 INSTANCE 使用 volatile 修饰即可，可以禁用指令重排，但要注意在 <strong>JDK 5 以上的版本的 volatile 才会真正有效</strong> </p>
<blockquote>
<p>最终解决方案：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SafeSingleton</span> </span>&#123;</span><br><span class="line">    <span class="comment">//给实例加上volatile关键字 加入内存屏障</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> SafeSingleton safeSingleton=<span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SafeSingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SafeSingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//       可见性：读：该屏障后面的代码都会从主存中读</span></span><br><span class="line"><span class="comment">//        有序性：读：该屏障后面的代码都会在该屏障之后执行</span></span><br><span class="line">        <span class="keyword">if</span>(safeSingleton==<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SafeSingleton<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (safeSingleton == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">//可见性：写：该屏障之前的代码都会写到主存中</span></span><br><span class="line">                    <span class="comment">//有序性，写：该屏障之前的代码后会在该屏障之前执行</span></span><br><span class="line">          <span class="comment">//保证对变量safeSingleton的赋值为有序性，即先调用构造方法，再赋值引用给safeSingleton</span></span><br><span class="line">                    <span class="keyword">return</span> safeSingleton=<span class="keyword">new</span> SafeSingleton();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> safeSingleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://img.louchen.top/2020/05/20200528130102.png" alt=""></p>
<h3 id="8、习题-1"><a href="#8、习题-1" class="headerlink" title="8、习题"></a>8、习题</h3><h4 id="①balking-模式习题"><a href="#①balking-模式习题" class="headerlink" title="①balking 模式习题"></a>①balking 模式习题</h4><p>希望 doInit() 方法仅被调用一次，下面的实现是否有问题，为什么？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestVolatile</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> Boolean initialized=<span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        doInit();</span><br><span class="line">        initialized=<span class="keyword">true</span>;    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化的一些操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码存在多线程并发操作，doInit()调用多次的情况, <strong>修改如下：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestVolatile</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">boolean</span> initialized=<span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (TestVolatile<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(initialized)&#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            doInit();</span><br><span class="line">            initialized=<span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//初始化的一些操作</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="②线程安全单例习题"><a href="#②线程安全单例习题" class="headerlink" title="②线程安全单例习题"></a>②线程安全单例习题</h4><p>单例模式有很多实现方法，饿汉、懒汉、静态内部类、枚举类，试分析每种实现下获取单例对象（即调用 getInstance）时的线程安全，并思考注释中的问题</p>
<ul>
<li>饿汉式：类加载就会导致该单实例对象被创建</li>
<li>懒汉式：类加载不会导致该单实例对象被创建，而是首次使用该对象时才会创建</li>
</ul>
<h6 id="实现1-饿汉式-："><a href="#实现1-饿汉式-：" class="headerlink" title="实现1(饿汉式)："></a>实现1(饿汉式)：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1、为什么加final?  答：防止子类对父类覆盖创建对象方法的干扰</span></span><br><span class="line"><span class="comment">//2、如果实现了序列化接口，还要做什么来防止序列化破坏单例？ 答：加上一个readResovle方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//3、为什么设置为私有？ 答：防止通过new无限制的创建对象。 是否能防止反序列化创建新的实例？  答：不能</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//4、这样初始化能否保证线程安全问题?  答：在类加载的时候，该对象即被jvm创建，所有为线程安全的</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton INSTANCE = <span class="keyword">new</span> Singleton();</span><br><span class="line">    <span class="comment">//5、为什么使用方法提供实例，而不是直接通过设置字段成员公有提供实例？ 答：更好的封装性，扩展性</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//若该类有readResolve方法，则使用该方法返回的对象，而不是使用序列化后的对象实例</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="实现2-懒汉式-："><a href="#实现2-懒汉式-：" class="headerlink" title="实现2(懒汉式)："></a>实现2(懒汉式)：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Singleton INSTANCE=<span class="keyword">null</span>;</span><br><span class="line">	<span class="comment">//对Singleton类对象上锁，性能比较低。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line">        INSTANCE=<span class="keyword">new</span> Singleton();</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="实现3-double-checked-locking-双重检查-懒汉"><a href="#实现3-double-checked-locking-双重检查-懒汉" class="headerlink" title="实现3(double-checked locking 双重检查)懒汉"></a>实现3(double-checked locking 双重检查)懒汉</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//加上volatile，防止在创建对象的时候指令重排</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton INSTANCE=<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (INSTANCE != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (Singleton<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(INSTANCE!=<span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> INSTANCE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//创建对象</span></span><br><span class="line">            INSTANCE = <span class="keyword">new</span> Singleton();</span><br><span class="line">            <span class="keyword">return</span> INSTANCE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="实现4-静态内部类-懒汉："><a href="#实现4-静态内部类-懒汉：" class="headerlink" title="实现4(静态内部类)懒汉："></a>实现4(静态内部类)懒汉：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Singleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//使用静态内部类，对外部不可见。</span></span><br><span class="line">    <span class="comment">//jvm本身对类加载是懒惰的，即只调用到getInstance方法时，使用到LazyHolder对象时该内部类才会被加载，里面的实例才会被加载</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyHolder</span></span>&#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">final</span> Singleton INSTANCE=<span class="keyword">new</span> Singleton();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">//调用时才会加载此内部类</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LazyHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="实现5-枚举"><a href="#实现5-枚举" class="headerlink" title="实现5(枚举)"></a>实现5(枚举)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//反编译后的问题：继承Enum枚举类</span></span><br><span class="line"><span class="comment">//final enum Singleton extends Enum&#123;</span></span><br><span class="line"><span class="comment">//        类加载时创建对象</span></span><br><span class="line"><span class="comment">//      public final static enum Singleton INSTANCE;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="comment">//1、枚举单例是如何实现限制实例个数的？  每个枚举实例，都是一个单例对象</span></span><br><span class="line"><span class="comment">//2、枚举单例在创建时是否有有并发问题？ 没有，final static实例会在类初始化的时候创建</span></span><br><span class="line"><span class="comment">//3、枚举单例能否被反序列化破坏单例？ 枚举类默认实现序列化接口，可被序列化和反序列，但是不破坏单例</span></span><br><span class="line"><span class="comment">//4、枚举能否通过反射破坏单例？ 不能。</span></span><br><span class="line"><span class="comment">//5、枚举单例属于饿汉式</span></span><br><span class="line"><span class="comment">//6、枚举单例中可以加入一些字段和构造方法，来初始化单例的属性</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> Singleton &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title">GetInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleTest</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Singleton instance = Singleton.GetInstance();</span><br><span class="line">        Singleton instance1 = Singleton.INSTANCE;</span><br><span class="line"><span class="comment">//        true</span></span><br><span class="line">        System.out.println(instance==instance1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Ⅴ、共享模型之无锁"><a href="#Ⅴ、共享模型之无锁" class="headerlink" title="Ⅴ、共享模型之无锁"></a>Ⅴ、共享模型之无锁</h2><h3 id="1、存取款问题"><a href="#1、存取款问题" class="headerlink" title="1、存取款问题"></a>1、存取款问题</h3><h4 id="①有锁方式synchronized"><a href="#①有锁方式synchronized" class="headerlink" title="①有锁方式synchronized"></a>①有锁方式synchronized</h4><blockquote>
<p> 账户接口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取余额</span></span><br><span class="line">    <span class="function">Integer <span class="title">getBalance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取款</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">demo</span><span class="params">(Account account)</span> </span>&#123;</span><br><span class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                account.withdraw(<span class="number">10</span>);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(Thread::start);</span><br><span class="line">        list.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(account.getBalance() + <span class="string">" cost:"</span> + (end - start)+<span class="string">"ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实现接口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AcccountSafe safe = <span class="keyword">new</span> AcccountSafe(<span class="number">10000</span>);</span><br><span class="line">        Account.demo(safe);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AcccountSafe</span> <span class="keyword">implements</span> <span class="title">Account</span> </span>&#123;</span><br><span class="line">    <span class="comment">//    余额</span></span><br><span class="line">    <span class="keyword">private</span> Integer balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AcccountSafe</span><span class="params">(Integer balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Integer <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance -= amount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> cost:<span class="number">126</span>ms</span><br></pre></td></tr></table></figure>

<h4 id="②无锁方式CAS"><a href="#②无锁方式CAS" class="headerlink" title="②无锁方式CAS"></a>②无锁方式CAS</h4><blockquote>
<p>账户接口 不变</p>
</blockquote>
<blockquote>
<p>实现接口</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AccountCAS cas=<span class="keyword">new</span> AccountCAS(<span class="number">10000</span>);</span><br><span class="line">        Account.demo(cas);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AccountCAS</span> <span class="keyword">implements</span> <span class="title">Account</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//余额</span></span><br><span class="line">    <span class="comment">//使用原子的Atomic</span></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger balance;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AccountCAS</span><span class="params">(Integer balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.balance = <span class="keyword">new</span> AtomicInteger(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取最新的值</span></span><br><span class="line">        <span class="keyword">return</span> balance.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用cas操作</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//获取最新的余额</span></span><br><span class="line">            <span class="keyword">int</span> pre=balance.get();</span><br><span class="line">            <span class="comment">//取钱之后的余额</span></span><br><span class="line">            <span class="keyword">int</span> next=pre-amount;</span><br><span class="line">                                    <span class="comment">//期望最新值    操作完之后的值</span></span><br><span class="line">            <span class="keyword">if</span>(balance.compareAndSet(pre, next))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> cost:<span class="number">68</span>ms</span><br></pre></td></tr></table></figure>

<p><strong>结果：</strong> 无锁的操作相比加锁确实效率提升了不少</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> cost:<span class="number">126</span>ms <span class="comment">//加锁</span></span><br><span class="line"><span class="number">0</span> cost:<span class="number">68</span>ms <span class="comment">//无锁</span></span><br></pre></td></tr></table></figure>

<h3 id="2、CAS与Volatile"><a href="#2、CAS与Volatile" class="headerlink" title="2、CAS与Volatile"></a>2、CAS与Volatile</h3><h4 id="①CAS操作分析"><a href="#①CAS操作分析" class="headerlink" title="①CAS操作分析"></a>①CAS操作分析</h4><p>前面看到的 <strong>AtomicInteger</strong> 的解决方法，内部并没有用锁来保护共享变量的线程安全。那么它是如何实现的呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//不断循环重试，知道成功为止</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//获取最新的余额 比如，拿到最新的值10000</span></span><br><span class="line">            <span class="keyword">int</span> pre=balance.get();</span><br><span class="line">            <span class="comment">//取钱之后的余额  操作 10000-10=9990</span></span><br><span class="line">            <span class="keyword">int</span> next=pre-amount;</span><br><span class="line">             <span class="comment">//当前线程读取到的最新余额 ;  操作完之后的余额</span></span><br><span class="line">			 <span class="comment">//compareAndSet这个操作是原子性的</span></span><br><span class="line">             <span class="comment">//例如，当该线程t1读取到当前的余额和操作之后的余额得到compareAndSet(10000,9990)</span></span><br><span class="line">             <span class="comment">//此外，线程t2再此原子操作之前修改了最新的余额为9990，即当前线程t1执行compareAndSet之前			 //pre会和最新的期望余额值进行比较，如果不一致，则next作废，返回false,重试。否则没有其他线程对余额进行操作，返回true,退出循环</span></span><br><span class="line">            <span class="keyword">if</span>(balance.compareAndSet(pre, next))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中的关键是 <strong>compareAndSet</strong>，它的简称就是 CAS （也有 <strong>Compare And Swap</strong> 比较交换 的说法），它必须是原子操作。</p>
<img src="http://img.louchen.top/2020/05/20200528210043.png" style="zoom:67%;" />

<p>我们可以发现在 AtomicInteger 中 是使用volatile保证可见性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AtomicInteger</span> <span class="keyword">extends</span> <span class="title">Number</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6214790243416807050L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// setup to use Unsafe.compareAndSwapInt for updates</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> valueOffset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            valueOffset = unsafe.objectFieldOffset</span><br><span class="line">                (AtomicInteger.class.getDeclaredField("value"));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123; <span class="keyword">throw</span> <span class="keyword">new</span> Error(ex); &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> value;</span><br><span class="line">    <span class="comment">//**</span></span><br><span class="line">   	<span class="comment">//**</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<ul>
<li><p>其实 CAS 的底层是 lock cmpxchg 指令（X86 架构），<strong>在单核 CPU 和多核 CPU 下都能够保证【比较-交 换】的原子性</strong>。</p>
</li>
<li><p>在多核状态下，某个核执行到带 lock 的指令时，CPU 会让总线锁住，当这个核把此指令执行完毕，再 开启总线。这个过程中不会被线程的调度机制所打断，保证了多个线程对内存操作的准确性，是原子 的。</p>
</li>
<li><p><strong>CAS 必须借助 volatile 才能读取到共享变量的新值来实现【比较并交换】的效果</strong> </p>
</li>
</ul>
<h4 id="②为什么无锁效率高？"><a href="#②为什么无锁效率高？" class="headerlink" title="②为什么无锁效率高？"></a>②为什么无锁效率高？</h4><ul>
<li>无锁情况下，即使重试失败，线程始终在高速运行，没有停歇，而 synchronized 会让线程在没有获得锁的时 候，发生上下文切换，进入阻塞。打个比喻</li>
<li>线程就好像高速跑道上的赛车，高速运行时，速度超快，一旦发生上下文切换，就好比赛车要减速、熄火， 等被唤醒又得重新打火、启动、加速… 恢复到高速运行，代价比较大 </li>
<li><strong>但无锁情况下，因为线程要保持运行，需要额外 CPU 的支持</strong>，CPU 在这里就好比高速跑道，没有额外的跑 道，线程想高速运行也无从谈起，虽然不会进入阻塞，但由于没有分到时间片，仍然会进入可运行状态，还 是会导致上下文切换。</li>
</ul>
<h4 id="③CAS特点"><a href="#③CAS特点" class="headerlink" title="③CAS特点"></a>③CAS特点</h4><p>结合 CAS 和 volatile 可以实现无锁并发，适用于<strong>线程数少、多核 CPU 的场景</strong>下</p>
<ul>
<li><p><strong>CAS 是基于乐观锁</strong>的思想：乐观的估计，不怕别的线程来修改共享变量，就算改了也没关系，我吃亏点再 重试呗。  每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。</p>
</li>
<li><p><strong>synchronized 是基于悲观锁</strong>的思想：悲观的估计，得防着其它线程来修改共享变量，我上了锁你们都别想 改，我改完了解开锁，你们才有机会。 这种线程一旦得到锁，其他需要锁的线程就挂起的情况就是悲观锁</p>
</li>
<li><p>CAS 体现的是无锁并发、无阻塞并发，请仔细体会这两句话的意思 </p>
<ul>
<li>因为没有使用 synchronized，所以线程不会陷入阻塞，这是效率提升的因素之一 </li>
<li>但如果竞争激烈，可以想到重试必然频繁发生，反而效率会受影响</li>
</ul>
</li>
</ul>
<h3 id="3、原子整数"><a href="#3、原子整数" class="headerlink" title="3、原子整数"></a>3、原子整数</h3><blockquote>
<p>java.util.concurrent.atomic下的</p>
</blockquote>
<h6 id="AtomicInteger"><a href="#AtomicInteger" class="headerlink" title="AtomicInteger"></a>AtomicInteger</h6><h6 id="AtomicBoolean"><a href="#AtomicBoolean" class="headerlink" title="AtomicBoolean"></a>AtomicBoolean</h6><h6 id="AtomicLong"><a href="#AtomicLong" class="headerlink" title="AtomicLong"></a>AtomicLong</h6><p>以<strong>AtomicInteger</strong>为例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T2</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        初始化值为0</span></span><br><span class="line">        AtomicInteger i = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line"><span class="comment">//        先获取再自增1  返回：1</span></span><br><span class="line">        System.out.println(i.getAndIncrement()); <span class="comment">//i++</span></span><br><span class="line"><span class="comment">//        先自增1再获取  返回：3</span></span><br><span class="line">        System.out.println(i.incrementAndGet()); <span class="comment">//++i</span></span><br><span class="line"><span class="comment">//        先自减1再获取  返回：2</span></span><br><span class="line">        System.out.println(i.decrementAndGet());<span class="comment">// --i;</span></span><br><span class="line"><span class="comment">//        先获取再自减1   返回：2</span></span><br><span class="line">        System.out.println(i.getAndDecrement());<span class="comment">// i--;</span></span><br><span class="line"><span class="comment">//        直接获取值 返回：1</span></span><br><span class="line">        System.out.println(i.get());</span><br><span class="line"><span class="comment">//        加上指定的值大小(先获取，再加)  返回：1  结果为11</span></span><br><span class="line">        System.out.println(i.getAndAdd(<span class="number">10</span>));</span><br><span class="line"><span class="comment">//        加上指定的值大小(先增加，再获取)</span></span><br><span class="line"><span class="comment">//        i.addAndGet(10)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        对指定的值进行更新操作   IntUnaryOperator函数式接口提供一个int类型参数，int类型的返回值的方法</span></span><br><span class="line"><span class="comment">//        先更新后获取 返回：22 结果：22</span></span><br><span class="line">        System.out.println(i.updateAndGet(value -&gt; value * <span class="number">2</span>));</span><br><span class="line"><span class="comment">//        对指定的值进行更新操作</span></span><br><span class="line"><span class="comment">//        先获取后更新 返回22  结果2200</span></span><br><span class="line">        System.out.println(i.getAndUpdate(value -&gt; value * <span class="number">100</span>));</span><br><span class="line"><span class="comment">//        先计算再获取  IntBinaryOperator函数式接口提供两个int类型参数 第一个为值i为2200，第二个为传来的参数200，返回一个int类型 </span></span><br><span class="line">        <span class="comment">// 返回2000  结果为2000</span></span><br><span class="line">        System.out.println(i.accumulateAndGet(<span class="number">200</span>, (p, x) -&gt; p - x));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即我们可以将上述取钱的操作修改：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(Integer amount)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        //使用cas操作</span></span><br><span class="line"><span class="comment">//        while (true) &#123;</span></span><br><span class="line"><span class="comment">//            //获取最新的余额</span></span><br><span class="line"><span class="comment">//            int pre=balance.get();</span></span><br><span class="line"><span class="comment">//            //取钱之后的余额</span></span><br><span class="line"><span class="comment">//            int next=pre-amount;</span></span><br><span class="line"><span class="comment">//                                    //期望最新值    操作完之后的值</span></span><br><span class="line"><span class="comment">//            if(balance.compareAndSet(pre, next))&#123;</span></span><br><span class="line"><span class="comment">//                break;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="comment">//取钱加一个负数即可</span></span><br><span class="line">        balance.addAndGet(-<span class="number">1</span>*amount);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>手动实现<strong>UpdateAndGet</strong>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AtomicInteger i = <span class="keyword">new</span> AtomicInteger(<span class="number">10</span>);</span><br><span class="line">        System.out.println(updateAndGet(i, value -&gt; value * <span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">updateAndGet</span><span class="params">(AtomicInteger i, IntUnaryOperator operator)</span></span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="comment">//        获取最新的值</span></span><br><span class="line">            <span class="keyword">int</span> pre = i.get();</span><br><span class="line">            <span class="keyword">int</span> next = operator.applyAsInt(pre);</span><br><span class="line"><span class="comment">//            调用cas操作</span></span><br><span class="line">            <span class="keyword">if</span>(i.compareAndSet(pre, next))&#123;</span><br><span class="line">                <span class="keyword">return</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>AtomicInteger的UpdateAndGet方法源码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">updateAndGet</span><span class="params">(IntUnaryOperator updateFunction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> prev, next;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            prev = get();</span><br><span class="line">            next = updateFunction.applyAsInt(prev);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、原子引用"><a href="#4、原子引用" class="headerlink" title="4、原子引用"></a>4、原子引用</h3><h6 id="AtomicReference"><a href="#AtomicReference" class="headerlink" title="AtomicReference"></a>AtomicReference</h6><h6 id="AtomicMarkableReference"><a href="#AtomicMarkableReference" class="headerlink" title="AtomicMarkableReference"></a>AtomicMarkableReference</h6><h6 id="AtomicStampedReference"><a href="#AtomicStampedReference" class="headerlink" title="AtomicStampedReference"></a>AtomicStampedReference</h6><h4 id="①AtomicReference-lt-V-gt-的使用"><a href="#①AtomicReference-lt-V-gt-的使用" class="headerlink" title="①AtomicReference&lt;V&gt;的使用"></a>①AtomicReference&lt;V&gt;的使用</h4><p><strong>对引用类型进行原子操作</strong></p>
<p>取款问题，若存取的操作为引用类型。则需要AtomicReference保护该类型</p>
<blockquote>
<p>账户类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">AccountR</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取余额</span></span><br><span class="line">    <span class="function">BigDecimal <span class="title">getBalance</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取款</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(BigDecimal amount)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">demo</span><span class="params">(AccountR account)</span> </span>&#123;</span><br><span class="line">        List&lt;Thread&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                account.withdraw(<span class="keyword">new</span> BigDecimal(String.valueOf(<span class="number">10</span>)));</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        list.forEach(Thread::start);</span><br><span class="line">        list.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">        System.out.println(account.getBalance() + <span class="string">" cost:"</span> + (end - start)+<span class="string">"ms"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实现类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T4</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DecimalAccountCas cas=<span class="keyword">new</span> DecimalAccountCas(<span class="keyword">new</span> BigDecimal(String.valueOf(<span class="number">10000</span>)));</span><br><span class="line">        AccountR.demo(cas);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DecimalAccountCas</span> <span class="keyword">implements</span> <span class="title">AccountR</span></span>&#123;</span><br><span class="line"><span class="comment">//    原子引用 &lt;要保护的类型&gt;</span></span><br><span class="line">    <span class="keyword">private</span> AtomicReference&lt;BigDecimal&gt; reference;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DecimalAccountCas</span><span class="params">(BigDecimal balance)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.reference = <span class="keyword">new</span> AtomicReference&lt;&gt;(balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getBalance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> reference.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">withdraw</span><span class="params">(BigDecimal amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            BigDecimal pre=reference.get();</span><br><span class="line">            <span class="comment">//subtract减操作</span></span><br><span class="line">            BigDecimal next=pre.subtract(amount);</span><br><span class="line"><span class="comment">//            使用cas</span></span><br><span class="line">            <span class="keyword">if</span> (reference.compareAndSet(pre, next)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span> cost:<span class="number">159</span>ms</span><br></pre></td></tr></table></figure>

<h4 id="②ABA问题及其解决"><a href="#②ABA问题及其解决" class="headerlink" title="②ABA问题及其解决"></a>②ABA问题及其解决</h4><h5 id="ABA问题"><a href="#ABA问题" class="headerlink" title="ABA问题"></a>ABA问题</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T5</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> AtomicReference&lt;String&gt; ref=<span class="keyword">new</span> AtomicReference&lt;&gt;(<span class="string">"A"</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"main start..."</span>);</span><br><span class="line"><span class="comment">//        获取值</span></span><br><span class="line">        String value = ref.get();</span><br><span class="line">        <span class="comment">//其他线程对变量修改</span></span><br><span class="line">        other();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"><span class="comment">//        尝试修改为</span></span><br><span class="line"><span class="comment">//        能否判断该变量value被其他线程修改过？</span></span><br><span class="line">        log.info(<span class="string">"change A-&gt;C &#123;&#125;"</span>,ref.compareAndSet(value, <span class="string">"C"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">other</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"change A-&gt;B &#123;&#125;"</span>,ref.compareAndSet(ref.get(),<span class="string">"B"</span>));</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"change B-&gt;A &#123;&#125;"</span>,ref.compareAndSet(ref.get(),<span class="string">"A"</span>));</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">04.348</span> [main] INFO org.lc.cas.T5 - main start...</span><br><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">04.386</span> [t1] INFO org.lc.cas.T5 - change A-&gt;B <span class="keyword">true</span></span><br><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">04.886</span> [t2] INFO org.lc.cas.T5 - change B-&gt;A <span class="keyword">true</span></span><br><span class="line"><span class="number">19</span>:<span class="number">04</span>:<span class="number">05.886</span> [main] INFO org.lc.cas.T5 - change A-&gt;C <span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>我们发现，在主线程main执行cas操作的时候，并不能感知其他线程对其值value修改过的操作。只是表面上的一致。中间操作还是被其他线程修改过。</p>
<p>主线程仅能判断出共享变量的值与初值 A 是否相同，不能感知到这种从 A 改为 B 又 改回 A 的情况，如果主线程 希望：</p>
<p>只要有其它线程【动过了】共享变量，那么自己的 cas 就算失败，这时，仅比较值是不够的，需要再加一个版本号</p>
<h4 id="③AtomicStampedReference-lt-V-gt-解决ABA问题-加版本号"><a href="#③AtomicStampedReference-lt-V-gt-解决ABA问题-加版本号" class="headerlink" title="③AtomicStampedReference&lt;V&gt;解决ABA问题(加版本号)"></a>③AtomicStampedReference&lt;V&gt;解决ABA问题(加版本号)</h4><p><strong>保证期望值匹配和版本号匹配CAS才能成功</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T6</span> </span>&#123;</span><br><span class="line">    <span class="comment">//赋初值的时候加版本号</span></span><br><span class="line">    <span class="keyword">static</span> AtomicStampedReference&lt;String&gt; ref=<span class="keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="string">"A"</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        log.info(<span class="string">"main start..."</span>);</span><br><span class="line"><span class="comment">//         获取值</span></span><br><span class="line">        String value = ref.getReference();</span><br><span class="line"><span class="comment">//        获取版本号</span></span><br><span class="line">        <span class="keyword">int</span> stamp = ref.getStamp();</span><br><span class="line">        log.info(<span class="string">"值为:&#123;&#125;,版本号为:&#123;&#125;"</span>,value,stamp);</span><br><span class="line">        <span class="comment">//其他线程对变量修改</span></span><br><span class="line">        other();</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"值为:&#123;&#125;,版本号为:&#123;&#125;"</span>,value,stamp);</span><br><span class="line"><span class="comment">//        尝试修改为</span></span><br><span class="line"><span class="comment">//        期望的值；新值；期望的版本号；新的版本号</span></span><br><span class="line"><span class="comment">//        stamp为0，但是other中的方法对已经对stamp进行了修改为2，版本号不匹配，即此CAS操作失败</span></span><br><span class="line">        log.info(<span class="string">"change A-&gt;C &#123;&#125;"</span>,ref.compareAndSet(value,<span class="string">"C"</span>,stamp, stamp+<span class="number">1</span>));</span><br><span class="line"><span class="comment">//        输出为A. 是other中的线程t2的cas操作的结果</span></span><br><span class="line">        System.out.println(ref.getReference());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">other</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            String value=ref.getReference();</span><br><span class="line">            <span class="keyword">int</span> stamp=ref.getStamp();</span><br><span class="line">            log.info(<span class="string">"值为:&#123;&#125;,版本号为:&#123;&#125;"</span>,value,stamp);</span><br><span class="line">            log.info(<span class="string">"change A-&gt;B &#123;&#125;"</span>,ref.compareAndSet(value,<span class="string">"B"</span>,ref.getStamp(),stamp+<span class="number">1</span>));</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            String value=ref.getReference();</span><br><span class="line">            <span class="keyword">int</span> stamp=ref.getStamp();</span><br><span class="line">            log.info(<span class="string">"值为:&#123;&#125;,版本号为:&#123;&#125;"</span>,value,stamp);</span><br><span class="line">            log.info(<span class="string">"change A-&gt;B &#123;&#125;"</span>,ref.compareAndSet(value,<span class="string">"A"</span>,ref.getStamp(),stamp+<span class="number">1</span>));</span><br><span class="line">        &#125;,<span class="string">"t2"</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">24</span>:<span class="number">01.934</span> [main] INFO org.lc.cas.T6 - main start...</span><br><span class="line"><span class="number">19</span>:<span class="number">24</span>:<span class="number">01.936</span> [main] INFO org.lc.cas.T6 - 值为:A,版本号为:<span class="number">0</span></span><br><span class="line"><span class="number">19</span>:<span class="number">24</span>:<span class="number">01.974</span> [t1] INFO org.lc.cas.T6 - 值为:A,版本号为:<span class="number">0</span></span><br><span class="line"><span class="number">19</span>:<span class="number">24</span>:<span class="number">01.974</span> [t1] INFO org.lc.cas.T6 - change A-&gt;B <span class="keyword">true</span></span><br><span class="line"><span class="number">19</span>:<span class="number">24</span>:<span class="number">02.474</span> [t2] INFO org.lc.cas.T6 - 值为:B,版本号为:<span class="number">1</span></span><br><span class="line"><span class="number">19</span>:<span class="number">24</span>:<span class="number">02.474</span> [t2] INFO org.lc.cas.T6 - change A-&gt;B <span class="keyword">true</span></span><br><span class="line"><span class="number">19</span>:<span class="number">24</span>:<span class="number">03.475</span> [main] INFO org.lc.cas.T6 - 值为:A,版本号为:<span class="number">0</span></span><br><span class="line"><span class="number">19</span>:<span class="number">24</span>:<span class="number">03.475</span> [main] INFO org.lc.cas.T6 - change A-&gt;C <span class="keyword">false</span></span><br><span class="line">A</span><br></pre></td></tr></table></figure>

<p><strong>AtomicStampedReference</strong> 可以给原子引用加上版本号，追踪原子引用整个的变化过程，如： A -&gt; B -&gt; A -&gt; C ，通过<strong>AtomicStampedReference</strong>，我们可以知道，引用变量中途被更改了几次。但是有时候，<strong>并不关心引用变量更改了几次</strong>，<strong>只是单纯的关心是否更改过</strong>，所以就有了 AtomicMarkableReference</p>
<h4 id="④AtomicMarkableReference-lt-V-gt-解决ABA问题-true-false标记"><a href="#④AtomicMarkableReference-lt-V-gt-解决ABA问题-true-false标记" class="headerlink" title="④AtomicMarkableReference&lt;V&gt;解决ABA问题(true/false标记)"></a>④AtomicMarkableReference&lt;V&gt;解决ABA问题(true/false标记)</h4><p><strong>保证期望值匹配和标志匹配CAS才能成功</strong></p>
<img src="http://img.louchen.top/2020/05/20200529194946.png" style="zoom:50%;" />

<blockquote>
<p>垃圾袋类</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//垃圾袋</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GarbageBag</span></span>&#123;</span><br><span class="line">    String desc;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GarbageBag</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> GarbageBag <span class="title">setDesc</span><span class="params">(String desc)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.desc = desc;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"GarbageBag&#123;"</span> +</span><br><span class="line">                <span class="string">"desc='"</span> + desc + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>实现操作</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T7</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        GarbageBag bag=<span class="keyword">new</span> GarbageBag(<span class="string">"这是一个装满了垃圾的垃圾袋"</span>);</span><br><span class="line"><span class="comment">//        初始化并标记  标记为true，这里只是作为一个标记，其他线程修改该值时，将此标记改为false</span></span><br><span class="line">        AtomicMarkableReference&lt;GarbageBag&gt; reference=<span class="keyword">new</span> AtomicMarkableReference&lt;&gt;(bag, <span class="keyword">true</span>);</span><br><span class="line">        log.info(<span class="string">"主线程 start..."</span>);</span><br><span class="line">        GarbageBag prev = reference.getReference();</span><br><span class="line">        log.info(prev.toString());</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"想换一只垃圾袋？"</span>);</span><br><span class="line">        <span class="comment">//CAS操作</span></span><br><span class="line">        <span class="comment">//参数： 期望的值；修改后的值；期望的标记；修改后的标记</span></span><br><span class="line">        <span class="comment">//先匹配prev的值是否被修改，再匹配第三个参数期望的标记是否为初始化时的标记为true.</span></span><br><span class="line">        <span class="comment">//都匹配，则cas成功。否则失败</span></span><br><span class="line">        <span class="keyword">boolean</span> result = reference.compareAndSet(prev, <span class="keyword">new</span> GarbageBag(<span class="string">"新的垃圾袋"</span>), <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        log.info(<span class="string">"换成功没？ &#123;&#125;"</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">51</span>:<span class="number">28.716</span> [main] INFO org.lc.cas.T7 - 主线程 start...</span><br><span class="line"><span class="number">19</span>:<span class="number">51</span>:<span class="number">28.718</span> [main] INFO org.lc.cas.T7 - GarbageBag&#123;desc=<span class="string">'这是一个装满了垃圾的垃圾袋'</span>&#125;</span><br><span class="line"><span class="number">19</span>:<span class="number">51</span>:<span class="number">29.719</span> [main] INFO org.lc.cas.T7 - 想换一只垃圾袋？</span><br><span class="line"><span class="number">19</span>:<span class="number">51</span>:<span class="number">29.719</span> [main] INFO org.lc.cas.T7 - 换成功没？ <span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>当其他线程对其prev修改时，主线程能否CAS成功?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T7</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        GarbageBag bag=<span class="keyword">new</span> GarbageBag(<span class="string">"这是一个装满了垃圾的垃圾袋"</span>);</span><br><span class="line"><span class="comment">//        初始化并标记</span></span><br><span class="line">        AtomicMarkableReference&lt;GarbageBag&gt; reference=<span class="keyword">new</span> AtomicMarkableReference&lt;&gt;(bag, <span class="keyword">true</span>);</span><br><span class="line">        log.info(<span class="string">"主线程 start..."</span>);</span><br><span class="line">        GarbageBag prev = reference.getReference();</span><br><span class="line">        log.info(prev.toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//此线程就是修改了prev的desc的变量值</span></span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            GarbageBag bag1 = reference.getReference();</span><br><span class="line">            log.info(<span class="string">"打扫卫生的线程 start..."</span>);</span><br><span class="line">            bag1.setDesc(<span class="string">"垃圾已打扫，这是一个空垃圾袋"</span>);</span><br><span class="line">            <span class="comment">//cas成功</span></span><br><span class="line">            <span class="keyword">while</span> (!reference.compareAndSet(bag1,bag1,<span class="keyword">true</span>,<span class="keyword">false</span>))&#123; &#125;</span><br><span class="line">            log.info(bag.toString());</span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        log.info(<span class="string">"想换一只垃圾袋？"</span>);</span><br><span class="line">        <span class="comment">//cas失败  因为pre已经被修改，且新的期望值已经变为false.</span></span><br><span class="line">        <span class="keyword">boolean</span> result = reference.compareAndSet(prev, <span class="keyword">new</span> GarbageBag(<span class="string">"新的垃圾袋"</span>), <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">        log.info(<span class="string">"换成功没？ &#123;&#125;"</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">59</span>:<span class="number">31.901</span> [main] INFO org.lc.cas.T7 - 主线程 start...</span><br><span class="line"><span class="number">19</span>:<span class="number">59</span>:<span class="number">31.903</span> [main] INFO org.lc.cas.T7 - GarbageBag&#123;desc=<span class="string">'这是一个装满了垃圾的垃圾袋'</span>&#125;</span><br><span class="line"><span class="number">19</span>:<span class="number">59</span>:<span class="number">31.947</span> [t1] INFO org.lc.cas.T7 - 打扫卫生的线程 start...</span><br><span class="line"><span class="number">19</span>:<span class="number">59</span>:<span class="number">31.947</span> [t1] INFO org.lc.cas.T7 - GarbageBag&#123;desc=<span class="string">'垃圾已打扫，这是一个空垃圾袋'</span>&#125;</span><br><span class="line"><span class="number">19</span>:<span class="number">59</span>:<span class="number">32.948</span> [main] INFO org.lc.cas.T7 - 想换一只垃圾袋？</span><br><span class="line"><span class="number">19</span>:<span class="number">59</span>:<span class="number">32.948</span> [main] INFO org.lc.cas.T7 - 换成功没？ <span class="keyword">false</span></span><br></pre></td></tr></table></figure>

<h3 id="5、原子数组"><a href="#5、原子数组" class="headerlink" title="5、原子数组"></a>5、原子数组</h3><h6 id="AtomicIntegerArray"><a href="#AtomicIntegerArray" class="headerlink" title="AtomicIntegerArray"></a>AtomicIntegerArray</h6><h6 id="AtomicLongArray"><a href="#AtomicLongArray" class="headerlink" title="AtomicLongArray"></a>AtomicLongArray</h6><h6 id="AtomicReferenceArray"><a href="#AtomicReferenceArray" class="headerlink" title="AtomicReferenceArray"></a>AtomicReferenceArray</h6><h4 id="①AtomicIntegerArray的使用"><a href="#①AtomicIntegerArray的使用" class="headerlink" title="①AtomicIntegerArray的使用"></a>①AtomicIntegerArray的使用</h4><p>对数组的每个索引处进行10000的累加操作。期望结果：[10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000, 10000]</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *数组测试</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> arraySupplier 提供数组，可以是线程不安全数组或线程安全数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> lengthFun 获取数组长度的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> putConsume 自增方法，回传array,index</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> printConsume 打印数组的方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;类型定义</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">demo</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            //  T get()</span></span>;</span><br><span class="line">            Supplier&lt;T&gt; arraySupplier,</span><br><span class="line">            <span class="comment">//  R apply(T t);</span></span><br><span class="line">            Function&lt;T,Integer&gt; lengthFun,</span><br><span class="line">            <span class="comment">// void accept(T t, U u);</span></span><br><span class="line">            BiConsumer&lt;T,Integer&gt; putConsume,</span><br><span class="line">            <span class="comment">// void accept(T t);</span></span><br><span class="line">            Consumer&lt;T&gt; printConsume)&#123;</span><br><span class="line">        List&lt;Thread&gt; ts=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//        获取数组</span></span><br><span class="line">        T array = arraySupplier.get();</span><br><span class="line"><span class="comment">//        获取数组长度</span></span><br><span class="line">        Integer length = lengthFun.apply(array);</span><br><span class="line"><span class="comment">//        循环10次</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="comment">//每个线程对数组10000次操作</span></span><br><span class="line">            ts.add(<span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="comment">//对每个索引的位置进行1000的累加操作 </span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                                       <span class="comment">//数组;   得到 0,1,2,3,4,5,6,7,8,9索引</span></span><br><span class="line">                    putConsume.accept(array, j % length);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        ts.forEach(Thread::start);</span><br><span class="line">        ts.forEach(thread -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                thread.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//打印数组</span></span><br><span class="line">        printConsume.accept(array);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>非安全操作： </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        demo(</span><br><span class="line">                <span class="comment">//传递长度为10的int数组</span></span><br><span class="line">                ()-&gt;<span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">10</span>],</span><br><span class="line">                <span class="comment">//传入数组长度</span></span><br><span class="line">                (array-&gt;array.length),</span><br><span class="line">                <span class="comment">//对数组中的每个索引位10000次加1操作</span></span><br><span class="line">            	<span class="comment">//array[index]++,这里可能存在指令的交错。导致线程不安全</span></span><br><span class="line">                (array,index)-&gt;array[index]++,</span><br><span class="line">                <span class="comment">//打印操作完后的数组</span></span><br><span class="line">                array-&gt; System.out.println(Arrays.toString(array))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">9312</span>, <span class="number">9230</span>, <span class="number">9238</span>, <span class="number">9229</span>, <span class="number">9222</span>, <span class="number">9210</span>, <span class="number">9291</span>, <span class="number">9263</span>, <span class="number">9247</span>, <span class="number">9230</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 安全操作：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        demo(</span><br><span class="line">                <span class="comment">//传递长度为10的int数组</span></span><br><span class="line">                ()-&gt;<span class="keyword">new</span> AtomicIntegerArray(<span class="number">10</span>),</span><br><span class="line">                <span class="comment">//传入数组长度</span></span><br><span class="line">                (array-&gt;array.length()),</span><br><span class="line">                <span class="comment">//对数组中的每个索引位10000次加1操作</span></span><br><span class="line">                (array,index)-&gt;array.getAndIncrement(index),</span><br><span class="line">                <span class="comment">//打印操作完后的数组</span></span><br><span class="line">                array-&gt; System.out.println(array)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">10000</span>]</span><br></pre></td></tr></table></figure>

<h3 id="6、字段更新器"><a href="#6、字段更新器" class="headerlink" title="6、字段更新器"></a>6、字段更新器</h3><p>我们只能对对象进行原子保护，但是不能对对象中的字段进行保护。因为对象中属性的改变并不会导致期望值的改变。所以我们需要<strong>字段更新器</strong></p>
<p> <strong>根据要修改的字段类型，决定使用什么类型：</strong> </p>
<h6 id="AtomicReferenceFieldUpdater"><a href="#AtomicReferenceFieldUpdater" class="headerlink" title="AtomicReferenceFieldUpdater"></a>AtomicReferenceFieldUpdater</h6><h6 id="AtomicIntegerFieldUpdater"><a href="#AtomicIntegerFieldUpdater" class="headerlink" title="AtomicIntegerFieldUpdater"></a>AtomicIntegerFieldUpdater</h6><h6 id="AtomicLongFieldUpdater"><a href="#AtomicLongFieldUpdater" class="headerlink" title="AtomicLongFieldUpdater"></a>AtomicLongFieldUpdater</h6><h4 id="①AtomicReferenceFieldUpdater的使用"><a href="#①AtomicReferenceFieldUpdater的使用" class="headerlink" title="①AtomicReferenceFieldUpdater的使用"></a>①AtomicReferenceFieldUpdater的使用</h4><p>注意：要操作的字段必须加<strong>volatile</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T10</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        AtomicReferenceFieldUpdater fieldUpdater=AtomicReferenceFieldUpdater.newUpdater(Student.class,String.class, "name");</span><br><span class="line">        Student student=<span class="keyword">new</span> Student();</span><br><span class="line">        <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">            <span class="comment">//下面的cas成功</span></span><br><span class="line">            student.setName(<span class="string">"李四"</span>);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//下面的cas失败</span></span><br><span class="line">            <span class="comment">//student.setName("张三");</span></span><br><span class="line">        &#125;,<span class="string">"t1"</span>).start();</span><br><span class="line">        Thread.sleep(<span class="number">500</span>);</span><br><span class="line"><span class="comment">//        cas操作：将对象字段的预期值和操作的对象中的值进行比较。如果一致则cas成功，否则失败</span></span><br><span class="line">                            <span class="comment">//当前操作的对象;  对象字段的预期值(原始值);  更新自动后的值</span></span><br><span class="line">        System.out.println(fieldUpdater.compareAndSet(student, <span class="string">"李四"</span>, <span class="string">"张三"</span>));</span><br><span class="line">        System.out.println(student.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span></span>&#123;</span><br><span class="line">    <span class="comment">//这里必须要配合volatile操作</span></span><br><span class="line">    <span class="keyword">volatile</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Student <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Student&#123;"</span> +</span><br><span class="line">                <span class="string">"name='"</span> + name + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7、原子累加器"><a href="#7、原子累加器" class="headerlink" title="7、原子累加器"></a>7、原子累加器</h3><h6 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h6><h4 id="①比较-AtomicLong-与-LongAdder"><a href="#①比较-AtomicLong-与-LongAdder" class="headerlink" title="①比较 AtomicLong 与 LongAdder"></a>①比较 AtomicLong 与 LongAdder</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T11</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//20000000 cost:327</span></span><br><span class="line">        demo(() -&gt; <span class="keyword">new</span> AtomicLong(), adder -&gt; adder.getAndIncrement());</span><br><span class="line">        <span class="comment">//20000000 cost:49</span></span><br><span class="line">        demo(() -&gt; <span class="keyword">new</span> LongAdder(), adder -&gt; adder.increment());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">demo</span><span class="params">(Supplier&lt;T&gt; adderSupplier, Consumer&lt;T&gt; action)</span> </span>&#123;</span><br><span class="line">        T adder = adderSupplier.get();</span><br><span class="line">        <span class="keyword">long</span> start = System.nanoTime();</span><br><span class="line">        List&lt;Thread&gt; ts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">//        4个线程 每个线程累加50万</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">40</span>; i++) &#123;</span><br><span class="line">            ts.add(<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">500000</span>; j++) &#123;</span><br><span class="line">                    action.accept(adder);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">        ts.forEach(t -&gt; t.start());</span><br><span class="line">        ts.forEach(t -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                t.join();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">long</span> end = System.nanoTime();</span><br><span class="line">        System.out.println(adder + <span class="string">" cost:"</span> + (end - start) / <span class="number">1000_000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>性能提升的原因很简单，就是在有竞争时，设置多个累加单元，Therad-0 累加 Cell[0]，而 Thread-1 累加 Cell[1]… 后将结果汇总。这样它们在累加时操作的不同的 Cell 变量，因此减少了 CAS 重试失败，从而提高性 能。</p>
<h2 id="Ⅵ、共享模型之不可变"><a href="#Ⅵ、共享模型之不可变" class="headerlink" title="Ⅵ、共享模型之不可变"></a>Ⅵ、共享模型之不可变</h2><h3 id="1、日期转换出现的线程安全问题"><a href="#1、日期转换出现的线程安全问题" class="headerlink" title="1、日期转换出现的线程安全问题"></a>1、日期转换出现的线程安全问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SimpleDateFormat sdf=<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(sdf.parse(<span class="string">"2019-1-1 11:11:11"</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"Thread-5"</span> java.lang.NumberFormatException: multiple points</span><br><span class="line">	at sun.misc.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:<span class="number">1890</span>)</span><br><span class="line">	at sun.misc.FloatingDecimal.parseDouble(FloatingDecimal.java:<span class="number">110</span>)</span><br><span class="line">	at java.lang.Double.parseDouble(Double.java:<span class="number">538</span>)</span><br><span class="line">	at java.text.DigitList.getDouble(DigitList.java:<span class="number">169</span>)</span><br><span class="line">......</span><br><span class="line">Tue Jan <span class="number">01</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">11</span> GMT+<span class="number">08</span>:<span class="number">00</span> <span class="number">2019</span></span><br><span class="line">Tue Jan <span class="number">01</span> <span class="number">11</span>:<span class="number">11</span>:<span class="number">11</span> GMT+<span class="number">08</span>:<span class="number">00</span> <span class="number">2019</span></span><br></pre></td></tr></table></figure>

<p>多线程同时操作同一个日期转换对象可能出现异常</p>
<h4 id="①加锁synchronized"><a href="#①加锁synchronized" class="headerlink" title="①加锁synchronized"></a>①加锁synchronized</h4><p>效率比较低</p>
<h4 id="②使用不可变类"><a href="#②使用不可变类" class="headerlink" title="②使用不可变类"></a>②使用不可变类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        DateTimeFormatter sdf = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(sdf.parse(<span class="string">"2019-01-01 11:11:11"</span>,(LocalDateTime::from)));</span><br><span class="line">                    <span class="comment">//等价-&gt;</span></span><br><span class="line">                    <span class="comment">// System.out.println(sdf.parse("2019-01-01 11:11:11", (TemporalAccessor temporal) -&gt; LocalDateTime.from(temporal)));</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* <span class="meta">@implSpec</span></span><br><span class="line">* This <span class="class"><span class="keyword">class</span> <span class="title">is</span> <span class="title">immutable</span> <span class="title">and</span> <span class="title">thread</span>-<span class="title">safe</span>. //类不可变且是线程安全的</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">final</span> <span class="title">class</span> <span class="title">DateTimeFormatter</span> </span>&#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、不可变类的设计"><a href="#2、不可变类的设计" class="headerlink" title="2、不可变类的设计"></a>2、不可变类的设计</h3><p>另一个大家更为熟悉的 String 类也是不可变的，以它为例，说明一下不可变设计的要素</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>, <span class="title">Comparable</span>&lt;<span class="title">String</span>&gt;, <span class="title">CharSequence</span> </span>&#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="①final的使用"><a href="#①final的使用" class="headerlink" title="①final的使用"></a>①final的使用</h4><p>发现该类、类中所有属性都是 ﬁnal 的 </p>
<ul>
<li>属性用 ﬁnal 修饰保证了该属性是只读的，不能修改</li>
<li>类用 ﬁnal 修饰保证了该类中的方法不能被覆盖，防止子类无意间破坏不可变性</li>
</ul>
<h4 id="②保护性拷贝"><a href="#②保护性拷贝" class="headerlink" title="②保护性拷贝"></a>②保护性拷贝</h4><p>例如String中的substring 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">substring</span><span class="params">(<span class="keyword">int</span> beginIndex)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (beginIndex &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(beginIndex);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> subLen = value.length - beginIndex;</span><br><span class="line">        <span class="keyword">if</span> (subLen &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> StringIndexOutOfBoundsException(subLen);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="comment">//实际new了一个新的对象</span></span><br><span class="line">        <span class="keyword">return</span> (beginIndex == <span class="number">0</span>) ? <span class="keyword">this</span> : <span class="keyword">new</span> String(value, beginIndex, subLen);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><strong>通过创建副本对象来避 免共享的手段称之为【保护性拷贝（defensive copy）】</strong></p>
<h3 id="3、享元模式"><a href="#3、享元模式" class="headerlink" title="3、享元模式"></a>3、享元模式</h3><p>定义 英文名称：Flyweight pattern. <strong>当需要重用数量有限的同一类对象时</strong></p>
<h4 id="①包装类体现"><a href="#①包装类体现" class="headerlink" title="①包装类体现"></a>①包装类体现</h4><p>在JDK中 Boolean，Byte，Short，Integer，Long，Character 等包装类提供了 valueOf 方法，例如 Long 的 valueOf 会缓存 -128~127 之间的 Long 对象，在这个范围之间会重用对象，大于这个范围，才会新建 Long 对 象：</p>
<blockquote>
<p>Long对象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title">valueOf</span><span class="params">(<span class="keyword">long</span> l)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> offset = <span class="number">128</span>;</span><br><span class="line">        <span class="keyword">if</span> (l &gt;= -<span class="number">128</span> &amp;&amp; l &lt;= <span class="number">127</span>) &#123; <span class="comment">// will cache</span></span><br><span class="line">            <span class="keyword">return</span> LongCache.cache[(<span class="keyword">int</span>)l + offset];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Long(l);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意:</p>
<ul>
<li>Byte, Short, Long 缓存的范围都是 -128~127 </li>
<li>Character 缓存的范围是 0~127 </li>
<li>Integer的默认范围是 -128~127 <ul>
<li>最小值不能变</li>
<li>但最大值可以通过调整虚拟机参数 <code>-Djava.lang.Integer.IntegerCache.high</code> 来改变 </li>
</ul>
</li>
<li>Boolean 缓存了 TRUE 和 FALSE</li>
</ul>
</blockquote>
<h4 id="②BigInteger和BigDecimal体现"><a href="#②BigInteger和BigDecimal体现" class="headerlink" title="②BigInteger和BigDecimal体现"></a>②BigInteger和BigDecimal体现</h4><p>我们可以发现在BigDecimal进行add操作时，也是通过new一个BigDecimal进行的累加操作，不存在线程安全问题。但是多个方法同时操作，多线程的情况下则存在线程安全问题。</p>
<h4 id="③实现简单的享元模式-数据库连接池"><a href="#③实现简单的享元模式-数据库连接池" class="headerlink" title="③实现简单的享元模式(数据库连接池)"></a>③实现简单的享元模式(数据库连接池)</h4><p>例如：一个线上商城应用，QPS（每秒查询率（QPS，Queries-per-second）是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。） 达到数千，如果每次都重新创建和关闭数据库连接，性能会受到极大影响。 这时 预先创建好一批连接，放入连接池。一次请求到达后，从连接池获取连接，使用完毕后再还回连接池，这样既节约 了连接的创建和关闭时间，也实现了连接的重用，不至于让庞大的连接数压垮数据库</p>
<blockquote>
<p>连接对象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//模拟连接对象实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MockConnection</span> <span class="keyword">implements</span> <span class="title">Connection</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String connectionName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"MockConnection&#123;"</span> +</span><br><span class="line">                <span class="string">"connectionName='"</span> + connectionName + <span class="string">'\''</span> +</span><br><span class="line">                <span class="string">'&#125;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//其他代码 略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>连接池</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pool</span></span>&#123;</span><br><span class="line"><span class="comment">//    连接池大小</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> poolSize;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    连接对象数组</span></span><br><span class="line">    <span class="keyword">private</span> Connection[] connections;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    连接状态数组  0空闲 1表示繁忙</span></span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerArray states;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    构造方法初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pool</span><span class="params">(<span class="keyword">int</span> poolSize)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.poolSize = poolSize;</span><br><span class="line">        <span class="keyword">this</span>.connections = <span class="keyword">new</span> Connection[poolSize];</span><br><span class="line">        <span class="keyword">this</span>.states=<span class="keyword">new</span> AtomicIntegerArray(<span class="keyword">new</span> <span class="keyword">int</span>[poolSize]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line"><span class="comment">//            初始化所有连接</span></span><br><span class="line">            connections[i]=<span class="keyword">new</span> MockConnection(<span class="string">"连接"</span>+(i+<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//    借连接</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">borrow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line"><span class="comment">//                获取空闲连接</span></span><br><span class="line"><span class="comment">//                使用cas操作 将该位置的连接更新为1  表示该位置的连接已被占用</span></span><br><span class="line">                <span class="keyword">if</span>(states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>))&#123;</span><br><span class="line"><span class="comment">//                    获得连接</span></span><br><span class="line">                    log.info(<span class="string">"借到连接 &#123;&#125;"</span>,connections[i]);</span><br><span class="line">                    <span class="keyword">return</span> connections[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//          如果遍历完所有的连接池中的连接 还没有获得连接</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//                    等待连接</span></span><br><span class="line">                    log.info(<span class="string">"没有空闲连接，请等待..."</span>);</span><br><span class="line">                    <span class="keyword">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 归还连接</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> connection 归还的连接对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">free</span><span class="params">(Connection connection)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line"><span class="comment">//            找到归还的连接对象</span></span><br><span class="line">            <span class="keyword">if</span>(connections[i]==connection)&#123;</span><br><span class="line"><span class="comment">//                这里无需cas ,应为传过来的Conncetion对象已确定</span></span><br><span class="line">                states.set(i, <span class="number">0</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    log.info(<span class="string">"已释放该连接&#123;&#125;..."</span>,connection);</span><br><span class="line">                    <span class="keyword">this</span>.notify();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Pool pool = <span class="keyword">new</span> Pool(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">new</span> Thread(()-&gt;&#123;</span><br><span class="line">                Connection con = pool.borrow();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//模拟 随机1秒内的执行时间</span></span><br><span class="line">                    Thread.sleep(<span class="keyword">new</span> Random().nextInt(<span class="number">1000</span>));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                pool.free(con);</span><br><span class="line">            &#125;,<span class="string">""</span>+(i+<span class="number">1</span>)).start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">48.700</span> [<span class="number">3</span>] INFO org.lc.flyweight_pattern.Pool - 没有空闲连接，请等待...</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">48.700</span> [<span class="number">1</span>] INFO org.lc.flyweight_pattern.Pool - 借到连接 MockConnection&#123;connectionName=<span class="string">'连接1'</span>&#125;</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">48.703</span> [<span class="number">4</span>] INFO org.lc.flyweight_pattern.Pool - 没有空闲连接，请等待...</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">48.703</span> [<span class="number">5</span>] INFO org.lc.flyweight_pattern.Pool - 没有空闲连接，请等待...</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">48.700</span> [<span class="number">2</span>] INFO org.lc.flyweight_pattern.Pool - 借到连接 MockConnection&#123;connectionName=<span class="string">'连接2'</span>&#125;</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">49.183</span> [<span class="number">1</span>] INFO org.lc.flyweight_pattern.Pool - 已释放该连接MockConnection&#123;connectionName=<span class="string">'连接1'</span>&#125;...</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">49.183</span> [<span class="number">3</span>] INFO org.lc.flyweight_pattern.Pool - 借到连接 MockConnection&#123;connectionName=<span class="string">'连接1'</span>&#125;</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">49.668</span> [<span class="number">2</span>] INFO org.lc.flyweight_pattern.Pool - 已释放该连接MockConnection&#123;connectionName=<span class="string">'连接2'</span>&#125;...</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">49.669</span> [<span class="number">4</span>] INFO org.lc.flyweight_pattern.Pool - 借到连接 MockConnection&#123;connectionName=<span class="string">'连接2'</span>&#125;</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">49.748</span> [<span class="number">3</span>] INFO org.lc.flyweight_pattern.Pool - 已释放该连接MockConnection&#123;connectionName=<span class="string">'连接1'</span>&#125;...</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">49.748</span> [<span class="number">5</span>] INFO org.lc.flyweight_pattern.Pool - 借到连接 MockConnection&#123;connectionName=<span class="string">'连接1'</span>&#125;</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">49.752</span> [<span class="number">4</span>] INFO org.lc.flyweight_pattern.Pool - 已释放该连接MockConnection&#123;connectionName=<span class="string">'连接2'</span>&#125;...</span><br><span class="line"><span class="number">21</span>:<span class="number">00</span>:<span class="number">50.464</span> [<span class="number">5</span>] INFO org.lc.flyweight_pattern.Pool - 已释放该连接MockConnection&#123;connectionName=<span class="string">'连接1'</span>&#125;...</span><br></pre></td></tr></table></figure>

<h3 id="4、final原理"><a href="#4、final原理" class="headerlink" title="4、final原理"></a>4、final原理</h3><h4 id="①设置final变量的原理"><a href="#①设置final变量的原理" class="headerlink" title="①设置final变量的原理"></a>①设置final变量的原理</h4><p>理解了 volatile 原理，再对比 ﬁnal 的实现就比较简单了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFinal</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> a = <span class="number">20</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>字节码:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: aload_0 </span><br><span class="line">1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V </span><br><span class="line"><span class="number">4</span>: aload_0 </span><br><span class="line"><span class="number">5</span>: bipush        <span class="number">20</span> </span><br><span class="line">7: putfield      #2                  // Field a:I    </span><br><span class="line">    &lt;-- 写屏障 </span><br><span class="line"><span class="number">10</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>发现 ﬁnal 变量的赋值也会通过 putﬁeld 指令来完成，同样在这条指令之后也会加入写屏障<strong>，保证在其它线程读到 它的值时不会出现为 0 的情况</strong> </p>
<p><strong>线程安全问题：</strong>当多线操作int a= 20时， a变量的赋值情况为先初始化0 ，然后再赋值20，再次过程中可能线程读到的为0，所以导致线程安全问题。加<strong>final</strong>修饰的变量可以解决此问题。</p>
<h2 id="Ⅶ-、共享模型之工具"><a href="#Ⅶ-、共享模型之工具" class="headerlink" title="Ⅶ 、共享模型之工具"></a>Ⅶ 、共享模型之工具</h2><h3 id="1、自定义线程池"><a href="#1、自定义线程池" class="headerlink" title="1、自定义线程池"></a>1、自定义线程池</h3><img src="http://img.louchen.top/2020/05/20200601161355.png" style="zoom: 67%;" />



<p>ThreadPool线程池：包含核心的线程数(总共的线程大小)，若任务的个数超过核心线程数的时候，会将多余的任务存入阻塞队列中的，等待线程池中的线程执行当前任务后，再从阻塞队列中获取。</p>
<p>Blocking Queue阻塞队列：存放多余任务的地方，由主线程提供任务，线程池消费阻塞队列中的任务。</p>
<h4 id="①自定义拒绝策略接口"><a href="#①自定义拒绝策略接口" class="headerlink" title="①自定义拒绝策略接口"></a>①自定义拒绝策略接口</h4><p>为阻塞队列之外的任务提供策略的抽象方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 拒绝策略接口</span></span><br><span class="line"><span class="comment"> * 解决阻塞队列的任务满的时候，对多余的任务的处理的方式</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">RejectPolicy</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 策略抽象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queue 阻塞队列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task 任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reject</span><span class="params">(BlockingQueue&lt;T&gt; queue,T task)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="②自定义阻塞任务队列"><a href="#②自定义阻塞任务队列" class="headerlink" title="②自定义阻塞任务队列"></a>②自定义阻塞任务队列</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlockingQueue</span>&lt;<span class="title">T</span>&gt;</span>&#123;</span><br><span class="line"><span class="comment">//    1、任务队列  存放任务 双向队列 (先进先出)</span></span><br><span class="line">    <span class="keyword">private</span> Deque&lt;T&gt; queue=<span class="keyword">new</span> ArrayDeque&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">//    2、锁  保证任务队列里的一个任务只有一个线程执行</span></span><br><span class="line">    <span class="keyword">private</span> ReentrantLock lock=<span class="keyword">new</span> ReentrantLock();</span><br><span class="line"></span><br><span class="line"><span class="comment">//    3、生产者条件变量   保证队列满的时候，生产者不再生产任务</span></span><br><span class="line">    <span class="keyword">private</span> Condition fullWaitSet=lock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="comment">//    4、消费者条件变量   保证队列空的时候，线程不再消费任务</span></span><br><span class="line">    <span class="keyword">private</span> Condition emptyWaitSet=lock.newCondition();</span><br><span class="line"></span><br><span class="line"><span class="comment">//    5、容量</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> capcity;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BlockingQueue</span><span class="params">(<span class="keyword">int</span> capcity)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.capcity = capcity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    带超时的阻塞获取 消费者获取任务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">pull</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//我们传入的超时时间转换为纳秒</span></span><br><span class="line">            <span class="keyword">long</span> nanos = unit.toNanos(timeout);</span><br><span class="line">            <span class="comment">//队列是否为空</span></span><br><span class="line">            <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//返回的剩余时间小于0  证明已经超时</span></span><br><span class="line">                    <span class="keyword">if</span> (nanos &lt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">//                        无需等待直接返回</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"><span class="comment">//                   返回的值为：剩余等待的时间 = 设置的超时时间 - 已经等待的时间</span></span><br><span class="line">                    nanos=emptyWaitSet.awaitNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//不为空  开始获取任务</span></span><br><span class="line">            <span class="comment">//从任务队列中移除第一个任务并返回该任务</span></span><br><span class="line">            T task=queue.removeFirst();</span><br><span class="line"><span class="comment">//            唤醒生成者生产任务</span></span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> task;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    阻塞获取 消费者获取任务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">take</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//队列是否为空</span></span><br><span class="line">            <span class="keyword">while</span> (queue.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//为空等待</span></span><br><span class="line">                    emptyWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//不为空  开始获取任务</span></span><br><span class="line">            <span class="comment">//从任务队列中移除第一个任务并返回该任务</span></span><br><span class="line">            T task=queue.removeFirst();</span><br><span class="line"><span class="comment">//            唤醒生成者生产任务</span></span><br><span class="line">            fullWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> task;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//      阻塞添加  生成者生产任务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(T task)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//队列中的任务数是否和容量相等</span></span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capcity) &#123;</span><br><span class="line"><span class="comment">//                容量已满 阻塞</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(<span class="string">"等待加入任务队列&#123;&#125;"</span>,task);</span><br><span class="line">                    fullWaitSet.await();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">"加入任务队列&#123;&#125;"</span>,task);</span><br><span class="line">            <span class="comment">//没有满 添加任务</span></span><br><span class="line">            queue.addLast(task);</span><br><span class="line">            <span class="comment">//唤醒消费者线程</span></span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    带超时时间的阻塞添加  如果在指定的超时时间内该任务还没有进入队列则放弃执行该任务</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(T task,<span class="keyword">long</span> timeout,TimeUnit timeUnit)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">long</span> nanos = timeUnit.toNanos(timeout);</span><br><span class="line">            <span class="comment">//队列中的任务数是否和容量相等</span></span><br><span class="line">            <span class="keyword">while</span> (queue.size() == capcity) &#123;</span><br><span class="line"><span class="comment">//                容量已满 阻塞</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (nanos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    log.info(<span class="string">"等待加入任务队列&#123;&#125;"</span>,task);</span><br><span class="line">                    nanos=fullWaitSet.awaitNanos(nanos);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            log.info(<span class="string">"加入任务队列&#123;&#125;"</span>,task);</span><br><span class="line">            <span class="comment">//没有满 添加任务</span></span><br><span class="line">            queue.addLast(task);</span><br><span class="line">            <span class="comment">//唤醒消费者线程</span></span><br><span class="line">            emptyWaitSet.signal();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//    获取阻塞队列中任务数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> queue.size();</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 策略模式对阻塞队列已满的抽象处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rejectPolicy 策略对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task 任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">tryPut</span><span class="params">(RejectPolicy&lt;T&gt; rejectPolicy, T task)</span> </span>&#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">//            阻塞队列已满</span></span><br><span class="line">            <span class="keyword">if</span> (queue.size() == capcity) &#123;</span><br><span class="line">                <span class="comment">//具体策略由调用者实现</span></span><br><span class="line">                rejectPolicy.reject(<span class="keyword">this</span>,task);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//有空闲</span></span><br><span class="line">                log.info(<span class="string">"加入任务队列&#123;&#125;"</span>,task);</span><br><span class="line">                <span class="comment">//没有满 添加任务</span></span><br><span class="line">                queue.addLast(task);</span><br><span class="line">                <span class="comment">//唤醒消费者线程</span></span><br><span class="line">                emptyWaitSet.signal();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="③自定义线程池"><a href="#③自定义线程池" class="headerlink" title="③自定义线程池"></a>③自定义线程池</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 线程池</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadPool</span></span>&#123;</span><br><span class="line"><span class="comment">//        任务队列</span></span><br><span class="line">    BlockingQueue&lt;Runnable&gt; taskQueue;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    线程集合</span></span><br><span class="line">    <span class="keyword">private</span> HashSet&lt;Worker&gt; workes=<span class="keyword">new</span> HashSet();</span><br><span class="line"></span><br><span class="line"><span class="comment">//    核心的线程数(即线程池的线程总数)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> coreSize;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    获取任务的超时时间</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> timeout;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    时间单位</span></span><br><span class="line">    <span class="keyword">private</span> TimeUnit timeUnit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 拒绝策略对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> RejectPolicy&lt;Runnable&gt; rejectPolicy;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 线程池中任务的创建</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> task 任务对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span></span>&#123;</span><br><span class="line"><span class="comment">//        当任务数没有超过coreSize时，直接交给Worker对象执行</span></span><br><span class="line"><span class="comment">//        当任务数超过了的coreSize是，加入任务队列暂存</span></span><br><span class="line"><span class="comment">//        当线程数还不够时，小于核心线程数时  该集合操作并不安全 需要加锁</span></span><br><span class="line">        <span class="keyword">synchronized</span> (workes) &#123;</span><br><span class="line">            <span class="keyword">if</span> (workes.size() &lt; coreSize) &#123;</span><br><span class="line">                <span class="comment">//新建一个线程执行此任务</span></span><br><span class="line">                Worker worker = <span class="keyword">new</span> Worker(task);</span><br><span class="line">                log.info(<span class="string">"新增worker&#123;&#125;, &#123;&#125;"</span>,worker, task);</span><br><span class="line"><span class="comment">//            加入到线程集合中</span></span><br><span class="line">                workes.add(worker);</span><br><span class="line"><span class="comment">//            执行任务 线程中的run执行任务中的run方法</span></span><br><span class="line">                worker.start();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//  队列已满 选择死等</span></span><br><span class="line"><span class="comment">//                taskQueue.put(task);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//                策略模式的使用：具体实现由调用者选择。</span></span><br><span class="line"><span class="comment">//           当阻塞队列任务满的时候，执行的策略有很多种</span></span><br><span class="line"><span class="comment">//                1&gt;死等</span></span><br><span class="line"><span class="comment">//                2&gt;超时等待</span></span><br><span class="line"><span class="comment">//                3&gt;让调用者放弃任务执行</span></span><br><span class="line"><span class="comment">//                4&gt;让调用者抛出异常</span></span><br><span class="line"><span class="comment">//                5&gt;让调用者抛出异常</span></span><br><span class="line"><span class="comment">//                这里我们通过策略模式来实现。</span></span><br><span class="line"></span><br><span class="line">                taskQueue.tryPut(rejectPolicy,task);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化线程池</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> coreSize 核心线程数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeout 超时时间</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timeUnit 超时时间单位</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> queueCapcity 阻塞队列容量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rejectPolicy  拒绝策略的实现对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPool</span><span class="params">(<span class="keyword">int</span> coreSize, <span class="keyword">long</span> timeout, TimeUnit timeUnit,<span class="keyword">int</span> queueCapcity,RejectPolicy&lt;Runnable&gt; rejectPolicy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.coreSize = coreSize;</span><br><span class="line">        <span class="keyword">this</span>.timeout = timeout;</span><br><span class="line">        <span class="keyword">this</span>.timeUnit = timeUnit;</span><br><span class="line">        <span class="keyword">this</span>.rejectPolicy=rejectPolicy;</span><br><span class="line">        <span class="keyword">this</span>.taskQueue=<span class="keyword">new</span> BlockingQueue&lt;&gt;(queueCapcity);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义worker包装我们的线程类</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">Thread</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> Runnable task;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Worker</span><span class="params">(Runnable task)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.task = task;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * worker具体的执行方法</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//            ①当task不为空，执行任务</span></span><br><span class="line"><span class="comment">//            ②当task执行完毕，再接着从任务队列获取任务并执行</span></span><br><span class="line"><span class="comment">//               判断初始化的时候是否有任务  ||  从阻塞队列中获取任务(执行全部任务)</span></span><br><span class="line"><span class="comment">//            while (task != null || (task=taskQueue.take())!=null) &#123;</span></span><br><span class="line"><span class="comment">//            获取阻塞队列中任务，使用带超时的获取方式。若等待一段时间，阻塞队列还没有任务则不等待</span></span><br><span class="line">            <span class="keyword">while</span> (task != <span class="keyword">null</span> || (task=taskQueue.pull(timeout, timeUnit))!=<span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    log.info(<span class="string">"正在执行...&#123;&#125;"</span>,task);</span><br><span class="line">                    <span class="comment">//相当于执行Runnable中的普通run方法</span></span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">//执行完毕后 将初始化的任务设为null</span></span><br><span class="line">                    task=<span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">//            所有阻塞的任务和初始化的任务都被执行完毕 移除线程</span></span><br><span class="line">            <span class="keyword">synchronized</span> (workes) &#123;</span><br><span class="line">                log.info(<span class="string">"worker被移除&#123;&#125;"</span>,<span class="keyword">this</span>);</span><br><span class="line">                <span class="comment">//移除当前线程</span></span><br><span class="line">                workes.remove(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="④测试"><a href="#④测试" class="headerlink" title="④测试"></a>④测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPool</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ThreadPool threadPool=<span class="keyword">new</span> ThreadPool(<span class="number">1</span>, <span class="number">1000</span>, TimeUnit.MILLISECONDS, <span class="number">1</span>,((queue,task)-&gt;&#123;</span><br><span class="line"><span class="comment">//            策略模式测试：</span></span><br><span class="line"><span class="comment">//            1、实现 死等</span></span><br><span class="line"><span class="comment">//            queue.put(task);</span></span><br><span class="line"><span class="comment">//            2、带超时的等待  设定的超时时间小于任务的执行时间则该任务放弃。</span></span><br><span class="line"><span class="comment">//            queue.offer(task, 1500, TimeUnit.MILLISECONDS);</span></span><br><span class="line"><span class="comment">//            3、让调用者放弃任务执行</span></span><br><span class="line"><span class="comment">//            log.info("放弃任务&#123;&#125;",task);</span></span><br><span class="line"><span class="comment">//            4、让调用者抛出异常</span></span><br><span class="line"><span class="comment">//            throw new RuntimeException("任务执行失败"+task);</span></span><br><span class="line"><span class="comment">//            5、让调用者自己去执行任务</span></span><br><span class="line">              task.run();</span><br><span class="line">        &#125;));</span><br><span class="line"><span class="comment">//        当需要执行的任务超过阻塞队列的长度时  由调用者来实现我们的策略(即真正执行的方法)</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> j=i;</span><br><span class="line">            threadPool.execute(()-&gt;&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">//模拟执行很长</span></span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"&#123;&#125;"</span>,j);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">10</span>:<span class="number">10.673</span> [main] INFO org.lc.Thread_pool.ThreadPool - 新增workerThread[Thread-<span class="number">0</span>,<span class="number">5</span>,main], org.lc.Thread_pool.TestPool$$Lambda$<span class="number">2</span>/<span class="number">1030870354</span>@<span class="number">22927</span>a81</span><br><span class="line"><span class="number">16</span>:<span class="number">10</span>:<span class="number">10.676</span> [main] INFO org.lc.Thread_pool.BlockingQueue - 加入任务队列org.lc.Thread_pool.TestPool$$Lambda$<span class="number">2</span>/<span class="number">1030870354</span>@<span class="number">20f</span>a23c1</span><br><span class="line"><span class="number">16</span>:<span class="number">10</span>:<span class="number">10.676</span> [Thread-<span class="number">0</span>] INFO org.lc.Thread_pool.ThreadPool - 正在执行...org.lc.Thread_pool.TestPool$$Lambda$<span class="number">2</span>/<span class="number">1030870354</span>@<span class="number">22927</span>a81</span><br><span class="line"><span class="number">16</span>:<span class="number">10</span>:<span class="number">11.676</span> [main] INFO org.lc.Thread_pool.TestPool - <span class="number">2</span></span><br><span class="line"><span class="number">16</span>:<span class="number">10</span>:<span class="number">11.676</span> [Thread-<span class="number">0</span>] INFO org.lc.Thread_pool.TestPool - <span class="number">0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">10</span>:<span class="number">11.676</span> [Thread-<span class="number">0</span>] INFO org.lc.Thread_pool.ThreadPool - 正在执行...org.lc.Thread_pool.TestPool$$Lambda$<span class="number">2</span>/<span class="number">1030870354</span>@<span class="number">20f</span>a23c1</span><br><span class="line"><span class="number">16</span>:<span class="number">10</span>:<span class="number">12.677</span> [Thread-<span class="number">0</span>] INFO org.lc.Thread_pool.TestPool - <span class="number">1</span></span><br><span class="line"><span class="number">16</span>:<span class="number">10</span>:<span class="number">13.678</span> [Thread-<span class="number">0</span>] INFO org.lc.Thread_pool.ThreadPool - worker被移除Thread[Thread-<span class="number">0</span>,<span class="number">5</span>,main]</span><br></pre></td></tr></table></figure>

<h3 id="2、ThreadPoolExecutor"><a href="#2、ThreadPoolExecutor" class="headerlink" title="2、ThreadPoolExecutor"></a>2、ThreadPoolExecutor</h3><p><code>package java.util.concurrent;</code></p>
<img src="http://img.louchen.top/2020/05/20200601165853.png" style="zoom:67%;" />

<h4 id="①线程池状态"><a href="#①线程池状态" class="headerlink" title="①线程池状态"></a>①线程池状态</h4><p>ThreadPoolExecutor 使用 int 的高 3 位来表示线程池状态，低 29 位表示线程数量</p>
<img src="http://img.louchen.top/2020/06/20200601170142.png" style="zoom: 67%;" />

<p>从数字上比较，TERMINATED &gt; TIDYING &gt; STOP &gt; SHUTDOWN &gt; RUNNING（111 为负数）</p>
<p>这些信息存储在一个原子变量 ctl 中，目的是将线程池状态与线程个数合二为一，这样就可以用一次 cas 原子操作 进行赋值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// c 为旧值， ctlOf 返回结果为新值 </span></span><br><span class="line">ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c))));</span><br><span class="line"> </span><br><span class="line"><span class="comment">// rs 为高 3 位代表线程池状态， wc 为低 29 位代表线程个数，ctl 是合并它们 </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ctlOf</span><span class="params">(<span class="keyword">int</span> rs, <span class="keyword">int</span> wc)</span> </span>&#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure>

<h4 id="②构造方法"><a href="#②构造方法" class="headerlink" title="②构造方法"></a>②构造方法</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">int</span> maximumPoolSize,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">long</span> keepAliveTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                      TimeUnit unit,</span></span></span><br><span class="line"><span class="function"><span class="params">                      BlockingQueue&lt;Runnable&gt; workQueue,</span></span></span><br><span class="line"><span class="function"><span class="params">                      ThreadFactory threadFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">                      RejectedExecutionHandler handler)</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p><strong>corePoolSize</strong> 核心线程数目 （最多保留的线程数，核心线程不会超时）</p>
</li>
<li><p><strong>maximumPoolSize</strong> 最大线程数据(救急线程数+核心线程数)</p>
</li>
<li><p><strong>keepAliveTime</strong>  生存时间 - 针对救急线程 </p>
</li>
<li><p><strong>TimeUnit</strong> 时间单位 - 针对救急线程</p>
</li>
<li><p><strong>workQueue</strong> 阻塞队列 </p>
</li>
<li><p><strong>threadFactory</strong> 线程工厂 - 可以为线程创建时起个好名字 </p>
</li>
<li><p><strong>handler</strong> 拒绝策略（救急线程用完，阻塞队列已满，会执行该策略）</p>
</li>
</ul>
<h5 id="工作方式："><a href="#工作方式：" class="headerlink" title="工作方式："></a>工作方式：</h5><img src="http://img.louchen.top/2020/06/20200601171534.png" style="zoom: 67%;" />

<ul>
<li><p>线程池中<strong>刚开始还没有线程</strong>，当一个任务提交给线程池后，线程池会创建一个新任务来执行任务</p>
</li>
<li><p>当现场数达到<strong>corePoolSize</strong>并没有空闲线程，这时再加入任务，新加的任务会被加入<strong>workQqueue</strong>队列排队，<strong>直到有空闲的线程</strong></p>
</li>
<li><p>如果队列选择了有界队列，那么任务超过了队列大小时，会创建 <code>maximumPoolSize - corePoolSize</code> 数目的线 程来救急（阻塞任务队列满的时候，会根据这个线程数目来创建救急线程执行多余的任务）</p>
</li>
<li><p>如果线程到达 <strong>maximumPoolSize</strong> 仍然有新任务这时会执行拒绝策略（救急线程也全部创建完毕，还有其他的任务，则会执行拒绝策略）。拒绝策略 <strong>jdk 提供了 4 种实现</strong>，其它 著名框架也提供了实现</p>
<ul>
<li><strong>AbortPolicy</strong> 让调用者抛出 RejectedExecutionException 异常，这是<strong>默认策略</strong></li>
<li><strong>CallerRunsPolicy</strong> 让调用者运行任务 </li>
<li><strong>DiscardPolicy</strong> 放弃本次任务</li>
<li><strong>DiscardOldestPolicy</strong> 放弃队列中早的任务，本任务取而代之</li>
<li><img src="http://img.louchen.top/2020/06/20200601172724.png" style="zoom: 67%;" /></li>
<li>———————-其他框架实现—————————</li>
<li>Dubbo 的实现，在抛出 RejectedExecutionException 异常之前会记录日志，并 dump 线程栈信息，方 便定位问题 </li>
<li>Netty 的实现，是创建一个新线程来执行任务 </li>
<li>ActiveMQ 的实现，带超时等待（60s）尝试放入队列，类似我们之前自定义的拒绝策略 </li>
<li>PinPoint 的实现，它使用了一个拒绝策略链，会逐一尝试策略链中每种拒绝策略</li>
</ul>
</li>
<li><p>当高峰过去后，<strong>超过corePoolSize 的救急线程如果一段时间没有任务做</strong>，需要结束节省资源，这个时间由 <strong>keepAliveTime</strong> 和 <strong>unit</strong> 来控制。</p>
</li>
</ul>
<h4 id="③newFixedThreadPool"><a href="#③newFixedThreadPool" class="headerlink" title="③newFixedThreadPool"></a>③newFixedThreadPool</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executors</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">                                      <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>特点:</strong></p>
<ul>
<li><p>核心线程数 = 最大线程数（<strong>没有救急线程被创建</strong>），<strong>因此也无需超时时间</strong> </p>
</li>
<li><p><strong>阻塞队列是无界的</strong>，可以放任意数量的任务</p>
</li>
<li><p>任务执行完毕后，核心线程<strong>不会主动结束</strong>。</p>
</li>
</ul>
<p><strong>使用场景：</strong>适用于任务量已知，相对耗时的任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T1</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        创建两个核心线程数</span></span><br><span class="line"><span class="comment">//        ExecutorService pool = Executors.newFixedThreadPool(2);</span></span><br><span class="line"><span class="comment">//        创建两个核心线程数 并自定义实现线程工厂</span></span><br><span class="line">        ExecutorService pool = Executors.newFixedThreadPool(<span class="number">2</span>, <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">            <span class="keyword">private</span> AtomicInteger t=<span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line"><span class="comment">//                自定义线程名称 使用cas赋值自增名称</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Thread(r,<span class="string">"mypool_"</span>+t.getAndIncrement());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        pool.execute(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"1"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        pool.execute(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"2"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">        pool.execute(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"3"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">19</span>:<span class="number">46</span>:<span class="number">08.701</span> [mypool_1] INFO org.lc.Thread_pool.T1 - <span class="number">1</span> <span class="comment">//线程1 执行任务1</span></span><br><span class="line"><span class="number">19</span>:<span class="number">46</span>:<span class="number">08.701</span> [mypool_2] INFO org.lc.Thread_pool.T1 - <span class="number">2</span> <span class="comment">//线程2 执行任务2</span></span><br><span class="line"><span class="number">19</span>:<span class="number">46</span>:<span class="number">08.704</span> [mypool_1] INFO org.lc.Thread_pool.T1 - <span class="number">3</span> <span class="comment">//线程1 执行任务3</span></span><br></pre></td></tr></table></figure>

<h4 id="④newCachedThreadPool"><a href="#④newCachedThreadPool" class="headerlink" title="④newCachedThreadPool"></a>④newCachedThreadPool</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executors</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newCachedThreadPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">0</span>, Integer.MAX_VALUE,</span><br><span class="line">                                      <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                      <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>特定：</strong></p>
<ul>
<li><strong>核心线程数是 0</strong>， 最大线程数是 Integer.MAX_VALUE，救急线程的空闲生存时间是 60s，意味着 <ul>
<li><strong>全部都是救急线程</strong>（60s 后可以回收）</li>
<li>救急线程可以<strong>无限创建</strong> </li>
</ul>
</li>
<li>队列采用了 <strong>SynchronousQueue</strong> 实现特点是，<strong>它没有容量</strong>，没有线程来取是放不进去的（一手交钱、一手交 货）</li>
</ul>
<p><strong>使用场景：</strong>整个线程池表现为线程数会根据任务量不断增长，没有上限，当任务执行完毕，空闲 1分钟后释放线 程。 <strong>适合任务数比较密集，但每个任务执行时间较短的情况</strong></p>
<h4 id="⑤newSingleThreadExecutor"><a href="#⑤newSingleThreadExecutor" class="headerlink" title="⑤newSingleThreadExecutor"></a>⑤newSingleThreadExecutor</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Executors</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newSingleThreadExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FinalizableDelegatedExecutorService</span><br><span class="line">            (<span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>,</span><br><span class="line">                                    <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                    <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用场景</strong>：希望多个任务排队执行。线程数固定为 1，任务数多于 1 时，会放入无界队列排队。任务执行完毕，这唯一的线程 也不会被释放。</p>
<p><strong>区别：</strong></p>
<ul>
<li><p>自己创建一个单线程串行执行任务，如果任务执行失败而终止那么没有任何补救措施，<strong>而线程池还会新建一 个线程，保证池的正常工作</strong> </p>
</li>
<li><p>Executors.newSingleThreadExecutor() 线程个数始终为1，不能修改</p>
<ul>
<li>FinalizableDelegatedExecutorService 应用的是装饰器模式，只对外暴露了 <strong>ExecutorService</strong> 接口，因 此<strong>不能调用 ThreadPoolExecutor 中特有的方法</strong>，不能对核心线程数等参数进行修改。</li>
</ul>
</li>
<li><p>Executors.newFixedThreadPool(1) 初始时为1，以后还可以修改 </p>
<ul>
<li>对外暴露的是 ThreadPoolExecutor 对象，可以强转后调用 setCorePoolSize 等方法进行修改</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ExecutorService pool = Executors.newSingleThreadExecutor();</span><br><span class="line">        pool.execute(()-&gt;&#123;</span><br><span class="line">            <span class="keyword">int</span> i=<span class="number">1</span>/<span class="number">0</span>; <span class="comment">//出现异常的是否 当前线程会放弃该任务</span></span><br><span class="line">            log.info(<span class="string">"task 1"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        pool.execute(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"task 2"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        pool.execute(()-&gt;&#123;</span><br><span class="line">            log.info(<span class="string">"task 3"</span>);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread <span class="string">"pool-1-thread-1"</span> java.lang.ArithmeticException: / by zero</span><br><span class="line">	at org.lc.Thread_pool.T3.lambda$main$<span class="number">0</span>(T3.java:<span class="number">20</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1149</span>)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">624</span>)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">748</span>)</span><br><span class="line"><span class="number">22</span>:<span class="number">50</span>:<span class="number">39.111</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO org.lc.Thread_pool.T3 - task <span class="number">2</span></span><br><span class="line"><span class="number">22</span>:<span class="number">50</span>:<span class="number">39.113</span> [pool-<span class="number">1</span>-thread-<span class="number">2</span>] INFO org.lc.Thread_pool.T3 - task <span class="number">3</span></span><br></pre></td></tr></table></figure>



<p>​     </p>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></div><!--!--></article></div><div class="card"><div class="card-content"><h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3><div class="buttons is-centered"><a class="button is-success donate"><span class="icon is-small"><i class="fab fa-weixin"></i></span><span>微信</span><span class="qrcode"><img src="/img/pay.jpg" alt="微信"></span></a></div></div></div><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/07/24/websocket/SpringBoot%E6%95%B4%E5%90%88WebSocket/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">SpringBoot整合WebSocket</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/07/24/task/SpringBoot%E6%95%B4%E5%90%88Quartz/"><span class="level-item">Springboot整合Quartz</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="" src="/img/milk.png" alt="娄晨"></figure><p class="title is-size-4 is-block line-height-inherit">娄晨</p><p class="is-size-6 is-block">学生</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国·武汉</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">70</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">19</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">40</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded cursor:pointer" href="/img/wechart.jpg" target="_blank" rel="noopener">联系我</a></div><div class="level is-mobile"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/ppoffice"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" id="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><ul class="menu-list"><li><a class="is-flex" href="#一、进程和线程的区别？"><span class="mr-2">1.1</span><span>一、进程和线程的区别？</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、进程"><span class="mr-2">1.1.1</span><span>1、进程</span></a></li><li><a class="is-flex" href="#2、线程"><span class="mr-2">1.1.2</span><span>2、线程</span></a></li><li><a class="is-flex" href="#3、进程和线程的区别"><span class="mr-2">1.1.3</span><span>3、进程和线程的区别</span></a></li></ul></li></ul><li><a class="is-flex" href="#Ⅱ、Java线程"><span class="mr-2">2</span><span>Ⅱ、Java线程</span></a><ul class="menu-list"><li><a class="is-flex" href="#一、创建线程的方式"><span class="mr-2">2.1</span><span>一、创建线程的方式</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、继承Thread"><span class="mr-2">2.1.1</span><span>1、继承Thread</span></a></li><li><a class="is-flex" href="#2、实现Runnable接口"><span class="mr-2">2.1.2</span><span>2、实现Runnable接口</span></a></li><li><a class="is-flex" href="#3、实现Callable接口"><span class="mr-2">2.1.3</span><span>3、实现Callable接口</span></a></li><li><a class="is-flex" href="#4、Thread和Runnable的关系"><span class="mr-2">2.1.4</span><span>4、Thread和Runnable的关系</span></a></li></ul></li><li><a class="is-flex" href="#三、原理之线程运行"><span class="mr-2">2.2</span><span>三、原理之线程运行</span></a><ul class="menu-list"><li><a class="is-flex" href="#图解分析：方法执行在jvm中内存区域分析："><span class="mr-2">2.2.1</span><span>图解分析：方法执行在jvm中内存区域分析：</span></a></li><li><a class="is-flex" href="#2、线程上下文切换"><span class="mr-2">2.2.2</span><span>2、线程上下文切换</span></a></li></ul></li><li><a class="is-flex" href="#四、Thread常用方法"><span class="mr-2">2.3</span><span>四、Thread常用方法</span></a></li><li><a class="is-flex" href="#五、sleep与yield"><span class="mr-2">2.4</span><span>五、sleep与yield</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、sleep"><span class="mr-2">2.4.1</span><span>1、sleep</span></a></li><li><a class="is-flex" href="#2、yield"><span class="mr-2">2.4.2</span><span>2、yield</span></a></li><li><a class="is-flex" href="#3、sleep与yield的区别"><span class="mr-2">2.4.3</span><span>3、sleep与yield的区别</span></a></li><li><a class="is-flex" href="#4、线程优先级"><span class="mr-2">2.4.4</span><span>4、线程优先级</span></a></li><li><a class="is-flex" href="#5、设置线程优先级和yield的区别"><span class="mr-2">2.4.5</span><span>5、设置线程优先级和yield的区别</span></a></li><li><a class="is-flex" href="#6、sleep应用：使用sleep限制对cpu的占用"><span class="mr-2">2.4.6</span><span>6、sleep应用：使用sleep限制对cpu的占用</span></a></li></ul></li><li><a class="is-flex" href="#六、join的使用"><span class="mr-2">2.5</span><span>六、join的使用</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、基本应用"><span class="mr-2">2.5.1</span><span>1、基本应用</span></a></li><li><a class="is-flex" href="#2、同步应用-等待多个线程结果"><span class="mr-2">2.5.2</span><span>2、同步应用-等待多个线程结果</span></a></li><li><a class="is-flex" href="#3、限时同步"><span class="mr-2">2.5.3</span><span>3、限时同步</span></a></li></ul></li><li><a class="is-flex" href="#七、interrupt使用"><span class="mr-2">2.6</span><span>七、interrupt使用</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、打断-sleep，wait，join-的阻塞线程"><span class="mr-2">2.6.1</span><span>1、打断 sleep，wait，join 的阻塞线程</span></a></li><li><a class="is-flex" href="#2、打断正常运行的线程"><span class="mr-2">2.6.2</span><span>2、打断正常运行的线程</span></a></li><li><a class="is-flex" href="#③利用-isInterrupted"><span class="mr-2">2.6.3</span><span>③利用 isInterrupted()</span></a></li><li><a class="is-flex" href="#4、打断park线程"><span class="mr-2">2.6.4</span><span>4、打断park线程</span></a></li><li><a class="is-flex" href="#5、-不推荐的方法"><span class="mr-2">2.6.5</span><span>5、 不推荐的方法</span></a></li></ul></li><li><a class="is-flex" href="#八、主线程和守护线程"><span class="mr-2">2.7</span><span>八、主线程和守护线程</span></a></li><li><a class="is-flex" href="#九、线程的状态"><span class="mr-2">2.8</span><span>九、线程的状态</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、五种状态-操作系统层面"><span class="mr-2">2.8.1</span><span>1、五种状态(操作系统层面)</span></a></li><li><a class="is-flex" href="#2、六种状态-Java层面"><span class="mr-2">2.8.2</span><span>2、六种状态(Java层面)</span></a></li><li><a class="is-flex" href="#3、代码示例六种状态"><span class="mr-2">2.8.3</span><span>3、代码示例六种状态</span></a></li></ul></li><li><a class="is-flex" href="#十、习题"><span class="mr-2">2.9</span><span>十、习题</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、烧水泡茶-sleep"><span class="mr-2">2.9.1</span><span>1、烧水泡茶(sleep)</span></a></li><li><a class="is-flex" href="#2、多线程下载图片"><span class="mr-2">2.9.2</span><span>2、多线程下载图片</span></a></li><li><a class="is-flex" href="#3、龟兔赛跑"><span class="mr-2">2.9.3</span><span>3、龟兔赛跑</span></a></li></ul></li></ul></li><li><a class="is-flex" href="#Ⅲ、共享线程之管程-悲观锁"><span class="mr-2">3</span><span>Ⅲ、共享线程之管程(悲观锁)</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、共享带来的问题"><span class="mr-2">3.1</span><span>1、共享带来的问题</span></a><ul class="menu-list"><li><a class="is-flex" href="#①、java的体现"><span class="mr-2">3.1.1</span><span>①、java的体现</span></a></li><li><a class="is-flex" href="#②、问题分析"><span class="mr-2">3.1.2</span><span>②、问题分析</span></a></li><li><a class="is-flex" href="#③、临界区-Critical-Section"><span class="mr-2">3.1.3</span><span>③、临界区 Critical Section</span></a></li><li><a class="is-flex" href="#④、竞态条件-Race-Condition-："><span class="mr-2">3.1.4</span><span>④、竞态条件(Race Condition )：</span></a></li></ul></li><li><a class="is-flex" href="#4、synchronized-也叫互斥锁-解决方案"><span class="mr-2">3.2</span><span>4、synchronized(也叫互斥锁)解决方案</span></a><ul class="menu-list"><li><a class="is-flex" href="#⑥面向对象改进"><span class="mr-2">3.2.1</span><span>⑥面向对象改进</span></a></li></ul></li><li><a class="is-flex" href="#5、方法上的synchronized"><span class="mr-2">3.3</span><span>5、方法上的synchronized</span></a><ul class="menu-list"><li><a class="is-flex" href="#结论："><span class="mr-2">3.3.1</span><span>结论：</span></a></li></ul></li><li><a class="is-flex" href="#6、变量的线程安全分析"><span class="mr-2">3.4</span><span>6、变量的线程安全分析</span></a><ul class="menu-list"><li><a class="is-flex" href="#④引用的变量在方法内-线程安全"><span class="mr-2">3.4.1</span><span>④引用的变量在方法内(线程安全)</span></a></li></ul></li><li><a class="is-flex" href="#7、常见线程安全类"><span class="mr-2">3.5</span><span>7、常见线程安全类</span></a><ul class="menu-list"><li><a class="is-flex" href="#②不可变类线程安全性"><span class="mr-2">3.5.1</span><span>②不可变类线程安全性</span></a></li></ul></li><li><a class="is-flex" href="#8、习题"><span class="mr-2">3.6</span><span>8、习题</span></a><ul class="menu-list"><li><a class="is-flex" href="#②转账"><span class="mr-2">3.6.1</span><span>②转账</span></a></li></ul></li><li><a class="is-flex" href="#9、Monitor概念"><span class="mr-2">3.7</span><span>9、Monitor概念</span></a><ul class="menu-list"><li><a class="is-flex" href="#①java对象头"><span class="mr-2">3.7.1</span><span>①java对象头</span></a></li></ul></li><li><a class="is-flex" href="#10、wait、notify"><span class="mr-2">3.8</span><span>10、wait、notify</span></a><ul class="menu-list"><li><a class="is-flex" href="#①为什么需要wait"><span class="mr-2">3.8.1</span><span>①为什么需要wait</span></a></li><li><a class="is-flex" href="#②wait原理"><span class="mr-2">3.8.2</span><span>②wait原理</span></a></li><li><a class="is-flex" href="#wait-long-n"><span class="mr-2">3.8.3</span><span>wait(long n)</span></a></li><li><a class="is-flex" href="#④wait-long-n-和sleep-long-n-的区别"><span class="mr-2">3.8.4</span><span>④wait(long n)和sleep(long n)的区别</span></a></li><li><a class="is-flex" href="#⑤唤醒占用同一锁的其他指定线程-实例"><span class="mr-2">3.8.5</span><span>⑤唤醒占用同一锁的其他指定线程-实例</span></a></li></ul></li><li><a class="is-flex" href="#11、同步模式之保护性暂停"><span class="mr-2">3.9</span><span>11、同步模式之保护性暂停</span></a><ul class="menu-list"><li><a class="is-flex" href="#①-定义"><span class="mr-2">3.9.1</span><span>①.定义</span></a></li><li><a class="is-flex" href="#②应用-超时效果"><span class="mr-2">3.9.2</span><span>②应用- 超时效果</span></a></li><li><a class="is-flex" href="#③应用-join原理"><span class="mr-2">3.9.3</span><span>③应用 - join原理</span></a></li><li><a class="is-flex" href="#④应用-多任务版-GuardedObject"><span class="mr-2">3.9.4</span><span>④应用- 多任务版 GuardedObject</span></a></li></ul></li><li><a class="is-flex" href="#12、异步模式之生产者-消费者"><span class="mr-2">3.10</span><span>12、异步模式之生产者/消费者</span></a><ul class="menu-list"><li><a class="is-flex" href="#①定义"><span class="mr-2">3.10.1</span><span>①定义</span></a></li><li><a class="is-flex" href="#②实例"><span class="mr-2">3.10.2</span><span>②实例</span></a></li></ul></li><li><a class="is-flex" href="#13、park和unpark"><span class="mr-2">3.11</span><span>13、park和unpark</span></a><ul class="menu-list"><li><a class="is-flex" href="#①基本使用"><span class="mr-2">3.11.1</span><span>①基本使用</span></a></li><li><a class="is-flex" href="#②基本原理"><span class="mr-2">3.11.2</span><span>②基本原理</span></a></li><li><a class="is-flex" href="#③与Object的wait-amp-notify相比"><span class="mr-2">3.11.3</span><span>③与Object的wait&amp;notify相比</span></a></li></ul></li><li><a class="is-flex" href="#14、活跃性"><span class="mr-2">3.12</span><span>14、活跃性</span></a><ul class="menu-list"><li><a class="is-flex" href="#①多把不相干的锁"><span class="mr-2">3.12.1</span><span>①多把不相干的锁</span></a></li><li><a class="is-flex" href="#②死锁"><span class="mr-2">3.12.2</span><span>②死锁</span></a></li><li><a class="is-flex" href="#③活锁"><span class="mr-2">3.12.3</span><span>③活锁</span></a></li><li><a class="is-flex" href="#④饥饿"><span class="mr-2">3.12.4</span><span>④饥饿</span></a></li></ul></li><li><a class="is-flex" href="#15、ReentrantLock-可重入锁"><span class="mr-2">3.13</span><span>15、ReentrantLock(可重入锁)</span></a><ul class="menu-list"><li><a class="is-flex" href="#①可重入"><span class="mr-2">3.13.1</span><span>①可重入</span></a></li><li><a class="is-flex" href="#②可打断"><span class="mr-2">3.13.2</span><span>②可打断</span></a></li><li><a class="is-flex" href="#③锁超时"><span class="mr-2">3.13.3</span><span>③锁超时</span></a></li><li><a class="is-flex" href="#④公平锁"><span class="mr-2">3.13.4</span><span>④公平锁</span></a></li><li><a class="is-flex" href="#⑤条件变量"><span class="mr-2">3.13.5</span><span>⑤条件变量</span></a></li></ul></li><li><a class="is-flex" href="#16、设计模式-同步模式之顺序控制"><span class="mr-2">3.14</span><span>16、设计模式-同步模式之顺序控制</span></a><ul class="menu-list"><li><a class="is-flex" href="#3、使用park和unpark"><span class="mr-2">3.14.1</span><span>3、使用park和unpark</span></a></li><li><a class="is-flex" href="#3、park和unpark"><span class="mr-2">3.14.2</span><span>3、park和unpark</span></a></li></ul></li><li><a class="is-flex" href="#17、本章小结"><span class="mr-2">3.15</span><span>17、本章小结</span></a></li></ul></li><li><a class="is-flex" href="#Ⅳ、共享模型之内存"><span class="mr-2">4</span><span>Ⅳ、共享模型之内存</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、java内存模型"><span class="mr-2">4.1</span><span>1、java内存模型</span></a></li><li><a class="is-flex" href="#2、可见性"><span class="mr-2">4.2</span><span>2、可见性</span></a><ul class="menu-list"><li><a class="is-flex" href="#①退不出的循环"><span class="mr-2">4.2.1</span><span>①退不出的循环</span></a></li></ul></li><li><a class="is-flex" href="#3、原子性和可见性"><span class="mr-2">4.3</span><span>3、原子性和可见性</span></a><ul class="menu-list"><li><a class="is-flex" href="#①synchronized和volatile区别："><span class="mr-2">4.3.1</span><span>①synchronized和volatile区别：</span></a></li></ul></li><li><a class="is-flex" href="#4、终止模式之两阶段终止模式-volatile"><span class="mr-2">4.4</span><span>4、终止模式之两阶段终止模式(volatile)</span></a></li><li><a class="is-flex" href="#5、同步模式之Balking-犹豫模式"><span class="mr-2">4.5</span><span>5、同步模式之Balking(犹豫模式)</span></a><ul class="menu-list"><li><a class="is-flex" href="#①定义："><span class="mr-2">4.5.1</span><span>①定义：</span></a></li><li><a class="is-flex" href="#②监控日志-案例"><span class="mr-2">4.5.2</span><span>②监控日志-案例</span></a></li><li><a class="is-flex" href="#③线程安全的单例模式"><span class="mr-2">4.5.3</span><span>③线程安全的单例模式</span></a></li></ul></li><li><a class="is-flex" href="#6、有序性"><span class="mr-2">4.6</span><span>6、有序性</span></a></li><li><a class="is-flex" href="#7、volatile原理"><span class="mr-2">4.7</span><span>7、volatile原理</span></a><ul class="menu-list"><li><a class="is-flex" href="#①读屏障和写屏障的可见性和有序性"><span class="mr-2">4.7.1</span><span>①读屏障和写屏障的可见性和有序性</span></a></li><li><a class="is-flex" href="#②如何保证可见性"><span class="mr-2">4.7.2</span><span>②如何保证可见性</span></a></li><li><a class="is-flex" href="#③如何保证有序性"><span class="mr-2">4.7.3</span><span>③如何保证有序性</span></a></li><li><a class="is-flex" href="#④单例模式的-double-checked-locking-双重检查"><span class="mr-2">4.7.4</span><span>④单例模式的 double-checked locking (双重检查)</span></a></li></ul></li><li><a class="is-flex" href="#8、习题-1"><span class="mr-2">4.8</span><span>8、习题</span></a><ul class="menu-list"><li><a class="is-flex" href="#①balking-模式习题"><span class="mr-2">4.8.1</span><span>①balking 模式习题</span></a></li><li><a class="is-flex" href="#实现5-枚举"><span class="mr-2">4.8.2</span><span>实现5(枚举)</span></a></li></ul></li></ul></li><li><a class="is-flex" href="#Ⅴ、共享模型之无锁"><span class="mr-2">5</span><span>Ⅴ、共享模型之无锁</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、存取款问题"><span class="mr-2">5.1</span><span>1、存取款问题</span></a><ul class="menu-list"><li><a class="is-flex" href="#①有锁方式synchronized"><span class="mr-2">5.1.1</span><span>①有锁方式synchronized</span></a></li><li><a class="is-flex" href="#②无锁方式CAS"><span class="mr-2">5.1.2</span><span>②无锁方式CAS</span></a></li></ul></li><li><a class="is-flex" href="#2、CAS与Volatile"><span class="mr-2">5.2</span><span>2、CAS与Volatile</span></a><ul class="menu-list"><li><a class="is-flex" href="#①CAS操作分析"><span class="mr-2">5.2.1</span><span>①CAS操作分析</span></a></li><li><a class="is-flex" href="#②为什么无锁效率高？"><span class="mr-2">5.2.2</span><span>②为什么无锁效率高？</span></a></li><li><a class="is-flex" href="#③CAS特点"><span class="mr-2">5.2.3</span><span>③CAS特点</span></a></li></ul></li><li><a class="is-flex" href="#3、原子整数"><span class="mr-2">5.3</span><span>3、原子整数</span></a><ul class="menu-list"><li><a class="is-flex" href="#AtomicLong"><span class="mr-2">5.3.1</span><span>AtomicLong</span></a></li></ul></li><li><a class="is-flex" href="#4、原子引用"><span class="mr-2">5.4</span><span>4、原子引用</span></a><ul class="menu-list"><li><a class="is-flex" href="#AtomicStampedReference"><span class="mr-2">5.4.1</span><span>AtomicStampedReference</span></a></li><li><a class="is-flex" href="#①AtomicReference-lt-V-gt-的使用"><span class="mr-2">5.4.2</span><span>①AtomicReference&lt;V&gt;的使用</span></a></li><li><a class="is-flex" href="#ABA问题"><span class="mr-2">5.4.3</span><span>ABA问题</span></a></li><li><a class="is-flex" href="#③AtomicStampedReference-lt-V-gt-解决ABA问题-加版本号"><span class="mr-2">5.4.4</span><span>③AtomicStampedReference&lt;V&gt;解决ABA问题(加版本号)</span></a></li><li><a class="is-flex" href="#④AtomicMarkableReference-lt-V-gt-解决ABA问题-true-false标记"><span class="mr-2">5.4.5</span><span>④AtomicMarkableReference&lt;V&gt;解决ABA问题(true/false标记)</span></a></li></ul></li><li><a class="is-flex" href="#5、原子数组"><span class="mr-2">5.5</span><span>5、原子数组</span></a><ul class="menu-list"><li><a class="is-flex" href="#AtomicReferenceArray"><span class="mr-2">5.5.1</span><span>AtomicReferenceArray</span></a></li><li><a class="is-flex" href="#①AtomicIntegerArray的使用"><span class="mr-2">5.5.2</span><span>①AtomicIntegerArray的使用</span></a></li></ul></li><li><a class="is-flex" href="#6、字段更新器"><span class="mr-2">5.6</span><span>6、字段更新器</span></a><ul class="menu-list"><li><a class="is-flex" href="#AtomicLongFieldUpdater"><span class="mr-2">5.6.1</span><span>AtomicLongFieldUpdater</span></a></li><li><a class="is-flex" href="#①AtomicReferenceFieldUpdater的使用"><span class="mr-2">5.6.2</span><span>①AtomicReferenceFieldUpdater的使用</span></a></li></ul></li><li><a class="is-flex" href="#7、原子累加器"><span class="mr-2">5.7</span><span>7、原子累加器</span></a><ul class="menu-list"><li><a class="is-flex" href="#LongAdder"><span class="mr-2">5.7.1</span><span>LongAdder</span></a></li><li><a class="is-flex" href="#①比较-AtomicLong-与-LongAdder"><span class="mr-2">5.7.2</span><span>①比较 AtomicLong 与 LongAdder</span></a></li></ul></li></ul></li><li><a class="is-flex" href="#Ⅵ、共享模型之不可变"><span class="mr-2">6</span><span>Ⅵ、共享模型之不可变</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、日期转换出现的线程安全问题"><span class="mr-2">6.1</span><span>1、日期转换出现的线程安全问题</span></a><ul class="menu-list"><li><a class="is-flex" href="#①加锁synchronized"><span class="mr-2">6.1.1</span><span>①加锁synchronized</span></a></li><li><a class="is-flex" href="#②使用不可变类"><span class="mr-2">6.1.2</span><span>②使用不可变类</span></a></li></ul></li><li><a class="is-flex" href="#2、不可变类的设计"><span class="mr-2">6.2</span><span>2、不可变类的设计</span></a><ul class="menu-list"><li><a class="is-flex" href="#①final的使用"><span class="mr-2">6.2.1</span><span>①final的使用</span></a></li><li><a class="is-flex" href="#②保护性拷贝"><span class="mr-2">6.2.2</span><span>②保护性拷贝</span></a></li></ul></li><li><a class="is-flex" href="#3、享元模式"><span class="mr-2">6.3</span><span>3、享元模式</span></a><ul class="menu-list"><li><a class="is-flex" href="#①包装类体现"><span class="mr-2">6.3.1</span><span>①包装类体现</span></a></li><li><a class="is-flex" href="#②BigInteger和BigDecimal体现"><span class="mr-2">6.3.2</span><span>②BigInteger和BigDecimal体现</span></a></li><li><a class="is-flex" href="#③实现简单的享元模式-数据库连接池"><span class="mr-2">6.3.3</span><span>③实现简单的享元模式(数据库连接池)</span></a></li></ul></li><li><a class="is-flex" href="#4、final原理"><span class="mr-2">6.4</span><span>4、final原理</span></a><ul class="menu-list"><li><a class="is-flex" href="#①设置final变量的原理"><span class="mr-2">6.4.1</span><span>①设置final变量的原理</span></a></li></ul></li></ul></li><li><a class="is-flex" href="#Ⅶ-、共享模型之工具"><span class="mr-2">7</span><span>Ⅶ 、共享模型之工具</span></a><ul class="menu-list"><li><a class="is-flex" href="#1、自定义线程池"><span class="mr-2">7.1</span><span>1、自定义线程池</span></a><ul class="menu-list"><li><a class="is-flex" href="#①自定义拒绝策略接口"><span class="mr-2">7.1.1</span><span>①自定义拒绝策略接口</span></a></li><li><a class="is-flex" href="#②自定义阻塞任务队列"><span class="mr-2">7.1.2</span><span>②自定义阻塞任务队列</span></a></li><li><a class="is-flex" href="#③自定义线程池"><span class="mr-2">7.1.3</span><span>③自定义线程池</span></a></li><li><a class="is-flex" href="#④测试"><span class="mr-2">7.1.4</span><span>④测试</span></a></li></ul></li><li><a class="is-flex" href="#2、ThreadPoolExecutor"><span class="mr-2">7.2</span><span>2、ThreadPoolExecutor</span></a><ul class="menu-list"><li><a class="is-flex" href="#①线程池状态"><span class="mr-2">7.2.1</span><span>①线程池状态</span></a></li><li><a class="is-flex" href="#工作方式："><span class="mr-2">7.2.2</span><span>工作方式：</span></a></li><li><a class="is-flex" href="#③newFixedThreadPool"><span class="mr-2">7.2.3</span><span>③newFixedThreadPool</span></a></li><li><a class="is-flex" href="#④newCachedThreadPool"><span class="mr-2">7.2.4</span><span>④newCachedThreadPool</span></a></li><li><a class="is-flex" href="#⑤newSingleThreadExecutor"><span class="mr-2">7.2.5</span><span>⑤newSingleThreadExecutor</span></a></li></ul></li></ul></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile is-mobile" href="http://vhr.louchen.top/index.html" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">人事管理</span></span><span class="level-right"><span class="level-item tag">vhr.louchen.top</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Git/"><span class="level-start"><span class="level-item">Git</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/IDEA/"><span class="level-start"><span class="level-item">IDEA</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/JavaWeb/"><span class="level-start"><span class="level-item">JavaWeb</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Java%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">Java基础</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/MySQL/"><span class="level-start"><span class="level-item">MySQL</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Nginx/"><span class="level-start"><span class="level-item">Nginx</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Redis/"><span class="level-start"><span class="level-item">Redis</span></span><span class="level-end"><span class="level-item tag">15</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/SSM/"><span class="level-start"><span class="level-item">SSM</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Spring/"><span class="level-start"><span class="level-item">Spring</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Spring-Boot/"><span class="level-start"><span class="level-item">Spring Boot</span></span><span class="level-end"><span class="level-item tag">22</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Spring-Cache/"><span class="level-start"><span class="level-item">Spring Cache</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Spring-Security/"><span class="level-start"><span class="level-item">Spring Security</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/SpringBoot/"><span class="level-start"><span class="level-item">SpringBoot</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/SpringMVC/"><span class="level-start"><span class="level-item">SpringMVC</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Windows/"><span class="level-start"><span class="level-item">Windows</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/"><span class="level-start"><span class="level-item">并发编程</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%99%9A%E6%8B%9F%E6%9C%BA/"><span class="level-start"><span class="level-item">虚拟机</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA%E9%83%A8%E7%BD%B2/"><span class="level-start"><span class="level-item">项目构建部署</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button is-primary" type="submit" value="订阅"></div></div></form></div></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2020-08-07T11:31:32.683Z">2020-08-07</time></p><p class="title is-6"><a class="link-muted" href="/2020/08/07/mysql/MySQL%E5%9F%BA%E7%A1%80/">MySQL基础</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/MySQL/">MySQL</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-08-07T11:31:32.646Z">2020-08-07</time></p><p class="title is-6"><a class="link-muted" href="/2020/08/07/mysql/MySQL%E8%BF%9B%E9%98%B6/">MySQL进阶</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/MySQL/">MySQL</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-07-24T15:14:33.039Z">2020-07-24</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/24/websocket/WebSocket%E7%AE%80%E4%BB%8B/">WebSocket和Socket初识</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Spring-Boot/">Spring Boot</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-07-24T15:14:33.038Z">2020-07-24</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/24/websocket/SpringBoot%E6%95%B4%E5%90%88WebSocket/">SpringBoot整合WebSocket</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Spring-Boot/">Spring Boot</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2020-07-24T15:14:33.027Z">2020-07-24</time></p><p class="title is-6"><a class="link-muted" href="/2020/07/24/thread/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">深入理解Java并发编程</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/archives/2020/08/"><span class="level-start"><span class="level-item">八月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/archives/2020/07/"><span class="level-start"><span class="level-item">七月 2020</span></span><span class="level-end"><span class="level-item tag">68</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/ActiveMQ/"><span class="tag">ActiveMQ</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Docker/"><span class="tag">Docker</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Ehcache/"><span class="tag">Ehcache</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/FastDFS/"><span class="tag">FastDFS</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Git/"><span class="tag">Git</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/IDEA/"><span class="tag">IDEA</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JAR/"><span class="tag">JAR</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JDK1-8/"><span class="tag">JDK1.8</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JWT/"><span class="tag">JWT</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java%E5%9F%BA%E7%A1%80/"><span class="tag">Java基础</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Maven/"><span class="tag">Maven</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MongoDB/"><span class="tag">MongoDB</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Nginx/"><span class="tag">Nginx</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/OAuth2/"><span class="tag">OAuth2</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Quartz/"><span class="tag">Quartz</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RESTful/"><span class="tag">RESTful</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/RabbitMQ/"><span class="tag">RabbitMQ</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Redis/"><span class="tag">Redis</span><span class="tag is-grey-lightest">16</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SSM/"><span class="tag">SSM</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Servlet/"><span class="tag">Servlet</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Session/"><span class="tag">Session</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shiro/"><span class="tag">Shiro</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring/"><span class="tag">Spring</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Boot/"><span class="tag">Spring Boot</span><span class="tag is-grey-lightest">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spring-Security/"><span class="tag">Spring Security</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringBoot/"><span class="tag">SpringBoot</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/SpringMVC/"><span class="tag">SpringMVC</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swagger2/"><span class="tag">Swagger2</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WAR/"><span class="tag">WAR</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/WebSocket/"><span class="tag">WebSocket</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/"><span class="tag">代理模式</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8F%8D%E5%B0%84/"><span class="tag">反射</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/"><span class="tag">多数据源</span><span class="tag is-grey-lightest">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/"><span class="tag">多线程</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"><span class="tag">定时任务</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B3%9B%E5%9E%8B/"><span class="tag">泛型</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%B6%88%E6%81%AF%E6%9C%8D%E5%8A%A1/"><span class="tag">消息服务</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1/"><span class="tag">邮件服务</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/favicon.ico" alt="MilkLc" height="28"></a><p class="size-small"><span>&copy; 2020 lc</span>  Powered by <a href="#" target="_blank" rel="noopener">LouChen</a>  </p><p class="size-small"><a href="http://www.miitbeian.gov.cn">鄂ICP备19030764号-1</a></p></div><div style="margin-left:-150px"><span id="busuanzi_container_site_pv">本站总访问量 <span id="busuanzi_value_site_pv" style="color:blue;font-size: 17px"></span> 次</span><span class="post-meta-divider"> | </span><span id="busuanzi_container_site_uv" style="display:none">本站访客数 <span id="busuanzi_value_site_uv" style="color:blue;font-size: 17px"></span> 人</span><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div class="level-end"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://yoursite.com',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>